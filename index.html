<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CryptoPro — Professional Trading Platform</title>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=IBM+Plex+Mono:wght@400;500;600;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg0:#06080D;--bg1:#0C0F18;--bg2:#131825;--bg3:#1A2030;--bg4:#202840;
  --border:rgba(255,255,255,0.06);--border2:rgba(255,255,255,0.12);
  --green:#00E676;--green2:#00C853;--green3:rgba(0,230,118,0.08);
  --red:#FF3D57;--red2:rgba(255,61,87,0.08);
  --blue:#448AFF;--yellow:#FFD740;--purple:#AA77FF;--cyan:#00E5FF;
  --text1:#EDF2F7;--text2:#8892A4;--text3:#4A5568;
  --font-display:'Syne',sans-serif;--font-body:'DM Sans',sans-serif;
  --font-mono:'IBM Plex Mono',monospace;
  --r-sm:6px;--r-md:10px;--r-lg:16px;--r-xl:24px;
}
body{font-family:var(--font-body);background:var(--bg0);color:var(--text1);min-height:100vh;overflow-x:hidden;-webkit-font-smoothing:antialiased}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:var(--bg1)}
::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:3px}
.layer{display:none;min-height:100vh;animation:layerFade .35s ease}
.layer.active{display:block}
@keyframes layerFade{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
@keyframes tickerMove{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}
@keyframes glow{0%,100%{box-shadow:0 0 8px rgba(0,230,118,.3)}50%{box-shadow:0 0 24px rgba(0,230,118,.7),0 0 48px rgba(0,230,118,.2)}}
@keyframes slideDown{from{opacity:0;transform:translateY(-12px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
@keyframes countUp{from{opacity:0;transform:scale(.88)}to{opacity:1;transform:scale(1)}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes shimmer{0%{background-position:-200px 0}100%{background-position:calc(200px + 100%) 0}}
@keyframes pnlFlash{0%{opacity:1}50%{opacity:.3}100%{opacity:1}}
@keyframes borderGlow{0%,100%{border-color:rgba(0,230,118,.2)}50%{border-color:rgba(0,230,118,.6)}}
@keyframes tradeFlash{from{background:rgba(255,255,255,.05)}to{background:transparent}}
@keyframes ripple{0%{transform:scale(0);opacity:1}100%{transform:scale(4);opacity:0}}

/* NAVBAR */
.navbar{height:58px;background:rgba(6,8,13,0.98);backdrop-filter:blur(24px);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 20px;gap:14px;position:sticky;top:0;z-index:1000}
.nav-logo{display:flex;align-items:center;gap:9px;cursor:pointer;text-decoration:none;flex-shrink:0}
.nav-logo-mark{width:32px;height:32px;background:linear-gradient(135deg,var(--green),var(--green2));border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:17px;font-weight:900;color:#000;font-family:var(--font-mono);animation:glow 4s ease-in-out infinite}
.nav-logo-text{font-family:var(--font-display);font-size:17px;font-weight:800;color:var(--text1);letter-spacing:-.3px}
.nav-logo-text span{color:var(--green)}
.nav-ticker{flex:1;overflow:hidden;mask-image:linear-gradient(to right,transparent,black 5%,black 95%,transparent)}
.nav-ticker-track{display:flex;gap:28px;animation:tickerMove 55s linear infinite;white-space:nowrap}
.nt-item{display:flex;align-items:center;gap:7px;font-family:var(--font-mono);font-size:11.5px;cursor:pointer}
.nt-item:hover .nt-price{color:var(--green)}
.nt-sym{color:var(--text2);font-weight:600}
.nt-price{color:var(--text1);font-weight:600;transition:color .2s}
.nt-chg{font-size:10.5px;padding:2px 6px;border-radius:4px;font-weight:700}
.nt-up{color:var(--green);background:var(--green3)}
.nt-dn{color:var(--red);background:var(--red2)}
.nav-right{display:flex;align-items:center;gap:8px;flex-shrink:0}
.live-badge{display:flex;align-items:center;gap:5px;padding:4px 10px;background:var(--green3);border:1px solid rgba(0,230,118,.2);border-radius:20px;font-size:11px;font-weight:700;color:var(--green);font-family:var(--font-mono)}
.live-dot{width:5px;height:5px;background:var(--green);border-radius:50%;animation:pulse 1.5s ease-in-out infinite;flex-shrink:0}
.btn{padding:8px 18px;border:none;border-radius:var(--r-md);font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;font-family:var(--font-body);letter-spacing:.1px;position:relative;overflow:hidden}
.btn::after{content:'';position:absolute;inset:0;background:rgba(255,255,255,0);transition:background .2s}
.btn:hover::after{background:rgba(255,255,255,.05)}
.btn-outline{background:transparent;color:var(--text2);border:1px solid var(--border2)}
.btn-outline:hover{color:var(--text1);border-color:rgba(255,255,255,.25)}
.btn-green{background:var(--green);color:#000;font-weight:700}
.btn-green:hover{background:var(--green2);transform:translateY(-1px);box-shadow:0 4px 16px rgba(0,230,118,.3)}

/* MARKET BAR */
.market-bar{background:var(--bg1);border-bottom:1px solid var(--border);padding:5px 0;overflow:hidden;mask-image:linear-gradient(to right,transparent,black 3%,black 97%,transparent)}
.market-bar-track{display:flex;gap:24px;animation:tickerMove 45s linear infinite;white-space:nowrap;padding:0 16px}
.mb-item{display:flex;align-items:center;gap:6px;font-size:11px;font-family:var(--font-mono);cursor:pointer}
.mb-sym{color:var(--text2);font-weight:600}
.mb-price{color:var(--text1)}
.mb-chg{font-size:11px;padding:1px 5px;border-radius:3px}

/* TOAST */
#toast{position:fixed;top:68px;right:20px;max-width:340px;background:var(--bg2);border:1px solid var(--border2);border-radius:var(--r-lg);padding:14px 18px;box-shadow:0 20px 60px rgba(0,0,0,.7);z-index:9999;display:none;animation:slideDown .3s ease;font-size:13px;line-height:1.6;white-space:pre-line}
#toast.show{display:block}
#toast.toast-green{border-left:3px solid var(--green)}
#toast.toast-red{border-left:3px solid var(--red)}
#toast.toast-blue{border-left:3px solid var(--blue)}
#toast.toast-yellow{border-left:3px solid var(--yellow)}

/* REFERRAL BANNER */
#refBanner{display:none;position:fixed;top:0;left:0;right:0;background:linear-gradient(90deg,#002b16,#004d2a,#002b16);border-bottom:1px solid rgba(0,230,118,.3);padding:16px 24px;z-index:9998;text-align:center;animation:slideDown .4s ease}
#refBanner.show{display:block}
.ref-close{position:absolute;top:50%;right:20px;transform:translateY(-50%);background:rgba(255,255,255,.1);border:none;color:#fff;width:28px;height:28px;border-radius:50%;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;transition:background .2s}
.ref-close:hover{background:rgba(255,255,255,.2)}
.ref-bonus-amt{font-size:30px;font-weight:900;color:var(--yellow);font-family:var(--font-mono);display:block;line-height:1}

/* NOTIFICATION BELL */
.notif-bell{position:relative;width:36px;height:36px;background:var(--bg2);border:1px solid var(--border);border-radius:var(--r-md);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;font-size:16px;flex-shrink:0}
.notif-bell:hover{border-color:var(--border2);background:var(--bg3)}
.notif-count{position:absolute;top:-4px;right:-4px;width:16px;height:16px;background:var(--red);border-radius:50%;font-size:9px;font-weight:800;color:#fff;display:flex;align-items:center;justify-content:center;font-family:var(--font-mono)}
.notif-dropdown{position:absolute;top:100%;right:0;margin-top:8px;width:320px;background:var(--bg2);border:1px solid var(--border2);border-radius:var(--r-xl);box-shadow:0 24px 64px rgba(0,0,0,.7);z-index:1001;display:none;animation:slideDown .25s ease;overflow:hidden}
.notif-dropdown.open{display:block}
.notif-header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;font-size:13px;font-weight:700;font-family:var(--font-display)}
.notif-item{padding:12px 16px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .15s;display:flex;gap:10px;align-items:flex-start}
.notif-item:hover{background:var(--bg3)}
.notif-item:last-child{border-bottom:none}
.notif-icon{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
.notif-text{font-size:12px;color:var(--text2);line-height:1.5}
.notif-text strong{color:var(--text1)}
.notif-time{font-size:10px;color:var(--text3);margin-top:2px}

/* SKELETON LOADER */
.skeleton{background:linear-gradient(90deg,var(--bg2) 25%,var(--bg3) 50%,var(--bg2) 75%);background-size:400px 100%;animation:shimmer 1.4s ease-in-out infinite;border-radius:var(--r-sm)}

/* WELCOME LAYER */
#welcomeLayer{background:var(--bg0)}
.hero{position:relative;padding:80px 40px 60px;text-align:center;overflow:hidden}
.hero::before{content:'';position:absolute;top:-200px;left:50%;transform:translateX(-50%);width:900px;height:900px;background:radial-gradient(ellipse,rgba(0,230,118,.06) 0%,transparent 70%);pointer-events:none}
.hero-grid{position:absolute;inset:0;background-image:linear-gradient(var(--border) 1px,transparent 1px),linear-gradient(90deg,var(--border) 1px,transparent 1px);background-size:40px 40px;mask-image:radial-gradient(ellipse 80% 60% at 50% 0%,black,transparent);opacity:.4}
.hero-tag{display:inline-flex;align-items:center;gap:6px;background:var(--green3);border:1px solid rgba(0,230,118,.2);border-radius:20px;padding:6px 14px;font-size:12px;font-weight:600;color:var(--green);font-family:var(--font-mono);margin-bottom:24px;animation:countUp .5s ease .1s both}
.hero-title{font-family:var(--font-display);font-size:clamp(36px,6vw,68px);font-weight:800;line-height:1.05;letter-spacing:-1.5px;margin-bottom:20px;animation:countUp .5s ease .2s both}
.hero-title .accent{color:var(--green)}
.hero-title .dim{color:var(--text2)}
.hero-sub{font-size:17px;color:var(--text2);max-width:560px;margin:0 auto 36px;line-height:1.65;font-weight:400;animation:countUp .5s ease .3s both}
.hero-cta{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;animation:countUp .5s ease .4s both}
.btn-hero-primary{padding:14px 32px;background:var(--green);color:#000;border:none;border-radius:var(--r-md);font-size:15px;font-weight:700;cursor:pointer;transition:all .25s;font-family:var(--font-display)}
.btn-hero-primary:hover{background:var(--green2);transform:translateY(-2px);box-shadow:0 8px 28px rgba(0,230,118,.35)}
.btn-hero-secondary{padding:14px 32px;background:transparent;color:var(--text1);border:1px solid var(--border2);border-radius:var(--r-md);font-size:15px;font-weight:600;cursor:pointer;transition:all .25s}
.btn-hero-secondary:hover{border-color:rgba(255,255,255,.3);background:var(--bg2)}
.stats-bar{display:flex;justify-content:center;border-top:1px solid var(--border);border-bottom:1px solid var(--border);background:var(--bg1);animation:countUp .5s ease .5s both}
.stat-item{flex:1;max-width:220px;padding:24px 20px;text-align:center;border-right:1px solid var(--border);transition:background .2s}
.stat-item:last-child{border-right:none}
.stat-item:hover{background:var(--bg2)}
.stat-val{font-family:var(--font-mono);font-size:26px;font-weight:700;color:var(--green);display:block;margin-bottom:4px}
.stat-lbl{font-size:12px;color:var(--text3);text-transform:uppercase;letter-spacing:.8px}
.traders-section{padding:32px 24px;border-bottom:1px solid var(--border)}
.section-header{display:flex;align-items:center;gap:10px;margin-bottom:16px}
.section-title{font-family:var(--font-display);font-size:14px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:1px}
.section-badge{font-size:10px;padding:2px 8px;background:var(--red2);color:var(--red);border-radius:10px;font-weight:700;font-family:var(--font-mono);animation:pulse 2s infinite}
.traders-track-wrap{overflow:hidden;mask-image:linear-gradient(to right,transparent,black 4%,black 96%,transparent)}
.traders-track{display:flex;gap:12px;animation:tickerMove 80s linear infinite;white-space:nowrap}
.trader-chip{display:inline-flex;align-items:center;gap:10px;background:var(--bg2);border:1px solid var(--border);border-radius:var(--r-md);padding:10px 16px;min-width:200px;transition:border-color .2s}
.trader-chip:hover{border-color:var(--border2)}
.trader-avatar{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,var(--green),var(--blue));display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
.trader-name{font-size:13px;font-weight:600;color:var(--text1)}
.trader-profit{font-size:13px;font-weight:700;color:var(--green);font-family:var(--font-mono)}
.trader-time{font-size:10px;color:var(--text3)}
.winners-section{padding:40px 24px;border-bottom:1px solid var(--border)}
.winners-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;margin-top:20px}
.winner-card{background:var(--bg1);border:1px solid var(--border);border-radius:var(--r-xl);padding:20px;transition:all .25s;position:relative;overflow:hidden}
.winner-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--green),var(--cyan));opacity:0;transition:opacity .25s}
.winner-card:hover{border-color:var(--border2);transform:translateY(-3px);box-shadow:0 12px 36px rgba(0,0,0,.4)}
.winner-card:hover::before{opacity:1}
.winner-rank{position:absolute;top:14px;right:14px;width:28px;height:28px;background:var(--bg3);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:800;font-family:var(--font-mono);color:var(--yellow)}
.winner-head{display:flex;align-items:center;gap:12px;margin-bottom:16px}
.winner-ava{width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,var(--green3),rgba(0,229,255,.1));border:1px solid var(--border2);display:flex;align-items:center;justify-content:center;font-size:22px}
.winner-name{font-weight:700;font-size:15px}
.winner-loc{font-size:12px;color:var(--text2);margin-top:2px}
.winner-stats{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.winner-stat{background:var(--bg2);border-radius:var(--r-md);padding:10px 12px;text-align:center}
.ws-val{font-family:var(--font-mono);font-size:17px;font-weight:700;color:var(--green)}
.ws-lbl{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;margin-top:2px}
.features-section{padding:48px 24px;border-bottom:1px solid var(--border)}
.features-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:16px;margin-top:24px}
.feature-card{background:var(--bg1);border:1px solid var(--border);border-radius:var(--r-xl);padding:24px;transition:all .25s;cursor:pointer}
.feature-card:hover{border-color:var(--border2);background:var(--bg2);transform:translateY(-2px)}
.feature-icon{width:44px;height:44px;border-radius:var(--r-md);display:flex;align-items:center;justify-content:center;font-size:20px;margin-bottom:16px}
.fi-green{background:var(--green3)}.fi-blue{background:rgba(68,138,255,.1)}.fi-yellow{background:rgba(255,215,64,.1)}.fi-purple{background:rgba(170,119,255,.1)}.fi-red{background:var(--red2)}.fi-cyan{background:rgba(0,229,255,.1)}
.feature-title{font-weight:700;font-size:15px;margin-bottom:6px;font-family:var(--font-display)}
.feature-desc{font-size:13px;color:var(--text2);line-height:1.55}
.reviews-section{padding:48px 24px}
.reviews-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;margin-top:24px}
.review-card{background:var(--bg1);border:1px solid var(--border);border-radius:var(--r-xl);padding:20px;transition:all .2s}
.review-card:hover{border-color:var(--border2)}
.review-head{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.review-ava{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,var(--bg3),var(--bg4));display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.review-name{font-weight:600;font-size:14px}
.review-loc{font-size:11px;color:var(--text3)}
.review-stars{color:var(--yellow);font-size:12px;letter-spacing:1px;margin-top:3px}
.review-body{font-size:13px;color:var(--text2);line-height:1.6;font-style:italic}
.cta-section{padding:64px 24px;text-align:center;border-top:1px solid var(--border);background:radial-gradient(ellipse 60% 80% at 50% 100%,rgba(0,230,118,.04),transparent)}
.cta-title{font-family:var(--font-display);font-size:clamp(28px,4vw,44px);font-weight:800;letter-spacing:-.8px;margin-bottom:16px}
.cta-sub{font-size:16px;color:var(--text2);max-width:440px;margin:0 auto 32px;line-height:1.6}
.footer{background:var(--bg1);border-top:1px solid var(--border);padding:24px;text-align:center;font-size:12px;color:var(--text3)}

/* AI ASSISTANT — Advanced Modern Design */
#aiBtn{position:fixed;bottom:24px;right:24px;z-index:1000;width:56px;height:56px;background:linear-gradient(135deg,#1a1f35,#0d1120);border:1px solid rgba(68,138,255,.4);border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 32px rgba(0,0,0,.6),0 0 0 1px rgba(68,138,255,.15);transition:all .3s}
#aiBtn:hover{transform:scale(1.08);box-shadow:0 12px 40px rgba(68,138,255,.3),0 0 0 1px rgba(68,138,255,.3)}
#aiBtn .ai-logo{width:30px;height:30px;position:relative}
#aiBtn .ai-logo svg{width:100%;height:100%}
.ai-pulse-ring{position:absolute;inset:-6px;border:1.5px solid rgba(68,138,255,.35);border-radius:50%;animation:pulse 2.5s ease-in-out infinite}
.ai-pulse-ring2{position:absolute;inset:-12px;border:1px solid rgba(68,138,255,.15);border-radius:50%;animation:pulse 2.5s ease-in-out infinite .5s}

#aiPanel{position:fixed;bottom:92px;right:24px;width:380px;height:580px;background:linear-gradient(180deg,#0a0d18 0%,#080b14 100%);border:1px solid rgba(255,255,255,.08);border-radius:20px;box-shadow:0 32px 80px rgba(0,0,0,.8),0 0 0 1px rgba(68,138,255,.1);z-index:999;display:none;flex-direction:column;overflow:hidden;animation:slideUp .3s cubic-bezier(.16,1,.3,1)}
#aiPanel.open{display:flex}

.ai-header{padding:16px 18px;background:linear-gradient(135deg,rgba(68,138,255,.12),rgba(41,98,255,.06));border-bottom:1px solid rgba(255,255,255,.06);display:flex;align-items:center;gap:12px;flex-shrink:0}
.ai-avatar{width:38px;height:38px;border-radius:12px;background:linear-gradient(135deg,#1e3a8a,#3b82f6);display:flex;align-items:center;justify-content:center;flex-shrink:0;position:relative;overflow:hidden}
.ai-avatar::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(59,130,246,.5),transparent);animation:pulse 3s ease-in-out infinite}
.ai-avatar svg{width:22px;height:22px;position:relative;z-index:1}
.ai-header-info{flex:1}
.ai-header-title{font-weight:700;font-size:14px;font-family:var(--font-display);letter-spacing:-.2px}
.ai-header-status{font-size:11px;color:var(--green);display:flex;align-items:center;gap:4px;margin-top:1px}
.ai-header-status::before{content:'';width:5px;height:5px;background:var(--green);border-radius:50%;animation:pulse 2s ease-in-out infinite}
.ai-header-actions{display:flex;gap:6px}
.ai-header-btn{width:28px;height:28px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--text2);font-size:12px;transition:all .2s}
.ai-header-btn:hover{background:rgba(255,255,255,.1);color:var(--text1)}

.ai-model-bar{padding:8px 16px;background:rgba(255,255,255,.02);border-bottom:1px solid rgba(255,255,255,.04);display:flex;align-items:center;gap:8px;font-size:11px;color:var(--text3);flex-shrink:0}
.ai-model-pill{display:flex;align-items:center;gap:4px;padding:3px 8px;background:rgba(68,138,255,.1);border:1px solid rgba(68,138,255,.2);border-radius:20px;font-size:10px;font-weight:700;color:var(--blue);cursor:pointer;font-family:var(--font-mono)}
.ai-model-pill:hover{background:rgba(68,138,255,.2)}

.ai-messages{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:14px}
.ai-messages::-webkit-scrollbar{width:3px}
.ai-messages::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1)}

.ai-msg{max-width:90%;animation:countUp .25s ease}
.ai-msg.bot{align-self:flex-start}
.ai-msg.user{align-self:flex-end}

.ai-msg-bubble{padding:11px 14px;border-radius:14px;font-size:13px;line-height:1.6}
.ai-msg.bot .ai-msg-bubble{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.07);border-radius:4px 14px 14px 14px;color:var(--text1)}
.ai-msg.user .ai-msg-bubble{background:linear-gradient(135deg,rgba(68,138,255,.25),rgba(41,98,255,.18));border:1px solid rgba(68,138,255,.25);border-radius:14px 4px 14px 14px;color:var(--text1)}

.ai-msg-meta{display:flex;align-items:center;gap:6px;margin-top:4px;font-size:10px;color:var(--text3)}
.ai-msg.user .ai-msg-meta{justify-content:flex-end}
.ai-msg-avatar{width:20px;height:20px;border-radius:6px;background:linear-gradient(135deg,#1e3a8a,#3b82f6);display:flex;align-items:center;justify-content:center;font-size:9px;flex-shrink:0}

.ai-typing{align-self:flex-start}
.ai-typing-bubble{padding:12px 16px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.07);border-radius:4px 14px 14px 14px;display:flex;gap:5px;align-items:center}
.ai-typing-dot{width:6px;height:6px;background:var(--text3);border-radius:50%;animation:pulse 1.2s ease-in-out infinite}
.ai-typing-dot:nth-child(2){animation-delay:.2s}
.ai-typing-dot:nth-child(3){animation-delay:.4s}

.ai-suggestions{padding:10px 14px;display:flex;gap:6px;flex-wrap:nowrap;overflow-x:auto;border-top:1px solid rgba(255,255,255,.05);flex-shrink:0}
.ai-suggestions::-webkit-scrollbar{height:0}
.ai-sug{padding:6px 12px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);border-radius:20px;font-size:11px;color:var(--text2);cursor:pointer;transition:all .2s;white-space:nowrap;flex-shrink:0}
.ai-sug:hover{border-color:rgba(68,138,255,.4);color:var(--blue);background:rgba(68,138,255,.08)}

.ai-capabilities{display:flex;gap:6px;padding:0 14px 10px;overflow-x:auto;flex-shrink:0}
.ai-capabilities::-webkit-scrollbar{height:0}
.ai-cap{display:flex;align-items:center;gap:4px;padding:4px 10px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);border-radius:8px;font-size:10px;color:var(--text3);white-space:nowrap;flex-shrink:0}

.ai-input-area{padding:12px 14px;border-top:1px solid rgba(255,255,255,.05);flex-shrink:0}
.ai-input-wrap{display:flex;align-items:flex-end;gap:8px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:10px 12px;transition:border-color .2s}
.ai-input-wrap:focus-within{border-color:rgba(68,138,255,.4)}
.ai-input{flex:1;background:transparent;border:none;color:var(--text1);font-size:13px;font-family:var(--font-body);outline:none;resize:none;max-height:80px;min-height:20px;line-height:1.5}
.ai-input::placeholder{color:var(--text3)}
.ai-send{width:32px;height:32px;background:linear-gradient(135deg,var(--blue),#2962FF);border:none;border-radius:10px;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;transition:all .2s;flex-shrink:0}
.ai-send:hover{transform:scale(1.08);box-shadow:0 4px 12px rgba(68,138,255,.4)}
.ai-send:disabled{opacity:.4;cursor:not-allowed}
.ai-footer-hint{text-align:center;font-size:10px;color:var(--text3);margin-top:8px;padding:0 4px}

/* AUTH */
.auth-page{display:grid;grid-template-columns:1fr 1fr;min-height:100vh}
.auth-left{background:linear-gradient(160deg,var(--bg1) 0%,var(--bg2) 100%);border-right:1px solid var(--border);display:flex;align-items:center;justify-content:center;padding:48px;position:relative;overflow:hidden}
.auth-left::before{content:'';position:absolute;bottom:-160px;right:-160px;width:500px;height:500px;background:radial-gradient(circle,rgba(0,230,118,.06),transparent 65%);pointer-events:none}
.auth-left::after{content:'';position:absolute;inset:0;background-image:linear-gradient(var(--border) 1px,transparent 1px),linear-gradient(90deg,var(--border) 1px,transparent 1px);background-size:36px 36px;opacity:.35}
.auth-left-inner{position:relative;z-index:1;max-width:380px;width:100%}
.auth-big-title{font-family:var(--font-display);font-size:54px;font-weight:800;letter-spacing:-1.5px;line-height:1.05;margin-bottom:16px}
.auth-big-sub{font-size:15px;color:var(--text2);line-height:1.65;margin-bottom:32px}
.auth-trust-list{display:flex;flex-direction:column;gap:10px;margin-bottom:28px}
.auth-trust-item{display:flex;align-items:center;gap:10px;font-size:13px;color:var(--text2)}
.auth-trust-icon{font-size:16px}
.auth-live-card{background:var(--bg3);border:1px solid var(--border2);border-radius:var(--r-lg);padding:14px 16px}
.auth-live-row{display:flex;align-items:center;justify-content:space-between}
.signup-bonus-card{background:linear-gradient(135deg,rgba(0,230,118,.15),rgba(0,200,83,.06));border:1px solid rgba(0,230,118,.25);border-radius:var(--r-xl);padding:20px;margin-bottom:28px}
.sbc-top{display:flex;align-items:center;gap:14px}
.auth-steps{display:flex;flex-direction:column;gap:12px}
.auth-step{display:flex;align-items:center;gap:12px;font-size:13px;color:var(--text2)}
.step-num{width:24px;height:24px;border-radius:50%;background:var(--green3);border:1px solid rgba(0,230,118,.3);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:var(--green);font-family:var(--font-mono);flex-shrink:0}
.auth-right{display:flex;align-items:center;justify-content:center;padding:40px 32px;background:var(--bg0);overflow-y:auto}
.auth-card{width:100%;max-width:420px;animation:layerFade .4s ease}
.auth-card-header{margin-bottom:28px}
.auth-form-title{font-family:var(--font-display);font-size:28px;font-weight:800;letter-spacing:-.5px;margin-bottom:6px}
.auth-form-sub{font-size:13px;color:var(--text2)}
.form-group{margin-bottom:18px}
.form-label{display:flex;justify-content:space-between;align-items:center;font-size:12px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:.6px;margin-bottom:7px}
.form-label-link{color:var(--green);font-weight:600;cursor:pointer;text-transform:none;letter-spacing:0;font-size:12px}
.input-wrap{position:relative;display:flex;align-items:center}
.input-icon{position:absolute;left:13px;font-size:15px;pointer-events:none;z-index:1}
.form-input{width:100%;padding:12px 14px 12px 40px;background:var(--bg2);border:1px solid var(--border);border-radius:var(--r-md);color:var(--text1);font-size:14px;font-family:var(--font-body);transition:all .2s}
.form-input:focus{outline:none;border-color:rgba(0,230,118,.5);box-shadow:0 0 0 3px rgba(0,230,118,.08)}
.form-input::placeholder{color:var(--text3)}
.form-input.error{border-color:var(--red)}
.input-eye{position:absolute;right:12px;background:none;border:none;cursor:pointer;font-size:14px;color:var(--text3);padding:4px;transition:color .2s}
.input-eye:hover{color:var(--text2)}
.btn-auth{width:100%;padding:13px;background:var(--green);color:#000;border:none;border-radius:var(--r-md);font-size:15px;font-weight:700;cursor:pointer;transition:all .2s;font-family:var(--font-display);display:flex;align-items:center;justify-content:center;gap:8px}
.btn-auth:hover{background:var(--green2);transform:translateY(-1px);box-shadow:0 6px 20px rgba(0,230,118,.3)}
.btn-auth:disabled{opacity:.6;cursor:not-allowed;transform:none}
.btn-auth-outline{padding:13px 20px;background:transparent;color:var(--text2);border:1px solid var(--border2);border-radius:var(--r-md);font-size:14px;font-weight:600;cursor:pointer;transition:all .2s;font-family:var(--font-body)}
.btn-auth-outline:hover{color:var(--text1)}
.btn-spinner{display:inline-block;animation:spin 1s linear infinite;font-size:16px}
.form-alert{padding:11px 14px;border-radius:var(--r-md);font-size:13px;margin-bottom:16px;border-left:3px solid}
.form-alert.error{background:var(--red2);border-color:var(--red);color:var(--red)}
.form-alert.success{background:var(--green3);border-color:var(--green);color:var(--green)}
.auth-divider{display:flex;align-items:center;gap:12px;margin:20px 0;color:var(--text3);font-size:12px}
.auth-divider::before,.auth-divider::after{content:'';flex:1;height:1px;background:var(--border)}
.social-row{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:20px}
.social-btn{padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:var(--r-md);color:var(--text1);font-size:13px;font-weight:500;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:7px;transition:all .2s}
.social-btn:hover{border-color:var(--border2);background:var(--bg3)}
.auth-switch-text{text-align:center;font-size:13px;color:var(--text2);margin-top:16px}
.auth-switch-text a{color:var(--green);cursor:pointer;font-weight:600}
.signup-progress{margin-bottom:24px}
.sp-bar{height:3px;background:var(--bg3);border-radius:2px;margin-bottom:8px;overflow:hidden}
.sp-fill{height:100%;background:linear-gradient(90deg,var(--green),var(--cyan));border-radius:2px;transition:width .4s ease}
.sp-steps{display:flex;justify-content:space-between}
.sp-step{font-size:11px;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:.5px;transition:color .3s}
.sp-step.active{color:var(--green)}
.pwd-strength{display:flex;align-items:center;gap:8px;margin-top:6px}
.pwd-bar{flex:1;height:3px;background:var(--bg3);border-radius:2px;overflow:hidden}
.pwd-fill{height:100%;border-radius:2px;transition:all .3s;width:0%}
.pwd-label{font-size:11px;font-weight:600;min-width:50px}
.twofa-box{background:var(--bg2);border:1px solid var(--border2);border-radius:var(--r-xl);padding:24px;text-align:center;margin-bottom:16px}
.otp-row{display:flex;gap:8px;justify-content:center;margin-bottom:8px}
.otp-input{width:42px;height:50px;background:var(--bg3);border:1px solid var(--border2);border-radius:var(--r-md);text-align:center;font-size:20px;font-weight:700;font-family:var(--font-mono);color:var(--text1);transition:all .2s}
.otp-input:focus{outline:none;border-color:var(--green);box-shadow:0 0 0 3px rgba(0,230,118,.12)}
.confirm-box{background:var(--bg2);border:1px solid var(--border);border-radius:var(--r-xl);padding:20px;margin-bottom:16px}
.confirm-row{display:flex;justify-content:space-between;align-items:center;padding:9px 0;border-bottom:1px solid var(--border);font-size:13px}
.confirm-row:last-child{border-bottom:none}
.confirm-row span{color:var(--text2)}
.checkbox-row{display:flex;align-items:flex-start;gap:10px;font-size:12px;color:var(--text2);line-height:1.5;cursor:pointer}
.checkbox-row input{margin-top:2px;accent-color:var(--green)}

/* CHARTS LAYER */
.pair-bar{background:var(--bg1);border-bottom:1px solid var(--border);overflow-x:auto}
.pair-bar::-webkit-scrollbar{height:3px}
.pair-bar-inner{display:flex;gap:2px;padding:6px 16px;white-space:nowrap}
.pair-btn{padding:6px 14px;background:transparent;border:none;border-radius:var(--r-sm);color:var(--text2);font-size:12px;font-weight:600;cursor:pointer;transition:all .2s;font-family:var(--font-mono)}
.pair-btn:hover{color:var(--text1);background:var(--bg3)}
.pair-btn.active{color:var(--green);background:var(--green3)}
.price-header{display:flex;align-items:center;gap:20px;padding:10px 20px;background:var(--bg1);border-bottom:1px solid var(--border);flex-wrap:wrap}
.ph-left{display:flex;align-items:baseline;gap:10px}
.ph-pair{font-family:var(--font-display);font-size:16px;font-weight:800}
.ph-price{font-family:var(--font-mono);font-size:26px;font-weight:700;transition:color .3s}
.ph-price.up{color:var(--green)}.ph-price.down{color:var(--red)}
.ph-change{font-family:var(--font-mono);font-size:14px;font-weight:700;padding:3px 10px;border-radius:var(--r-sm)}
.ph-change.up{color:var(--green);background:var(--green3)}
.ph-change.down{color:var(--red);background:var(--red2)}
.ph-stats{display:flex;gap:20px;flex:1}
.ph-stat{display:flex;flex-direction:column;gap:2px}
.ph-stat-lbl{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px}
.ph-stat-val{font-family:var(--font-mono);font-size:13px;font-weight:600}
.ph-right{margin-left:auto}
.interval-btns{display:flex;gap:2px}
.iv-btn{padding:5px 10px;background:transparent;border:1px solid transparent;border-radius:var(--r-sm);color:var(--text3);font-size:11px;font-weight:700;cursor:pointer;transition:all .2s;font-family:var(--font-mono)}
.iv-btn:hover{color:var(--text1)}
.iv-btn.active{color:var(--green);border-color:rgba(0,230,118,.3);background:var(--green3)}
.chart-layout{display:grid;grid-template-columns:1fr 200px 180px;height:calc(100vh - 200px);min-height:500px;border-bottom:1px solid var(--border)}
.chart-main{display:flex;flex-direction:column;border-right:1px solid var(--border);min-width:0;overflow:hidden}
.indicator-bar{display:flex;align-items:center;gap:8px;padding:7px 12px;background:var(--bg1);border-bottom:1px solid var(--border);flex-wrap:wrap}
.ind-btn{padding:4px 10px;background:var(--bg3);border:1px solid var(--border);border-radius:4px;color:var(--text2);font-size:11px;font-weight:600;cursor:pointer;transition:all .2s;font-family:var(--font-mono)}
.ind-btn:hover{color:var(--text1)}
.ind-btn.active{color:var(--green);border-color:rgba(0,230,118,.3);background:var(--green3)}
#tvChartContainer,.tv-chart-wrapper{flex:1;min-height:0;position:relative}
#tvChartContainer .tv-lightweight-charts{height:100%!important}
.vol-wrap-tv{height:70px;position:relative;border-top:1px solid var(--border)}
.rsi-wrap-tv{height:80px;position:relative;border-top:1px solid var(--border);display:none}
.depth-section{padding:12px 16px;background:var(--bg1);border-top:1px solid var(--border)}
.depth-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.depth-wrap{height:100px;position:relative;background:var(--bg0);border-radius:var(--r-md);overflow:hidden;border:1px solid var(--border)}
.depth-wrap canvas{position:absolute;inset:0;width:100%;height:100%}
.orderbook-panel{display:flex;flex-direction:column;background:var(--bg1);overflow:hidden}
.ob-header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--border);flex-shrink:0}
.ob-title{font-size:13px;font-weight:700;font-family:var(--font-display)}
.ob-tabs{display:flex;gap:4px}
.ob-tab{padding:3px 7px;background:var(--bg3);border:1px solid var(--border);border-radius:4px;font-size:11px;cursor:pointer;transition:all .2s}
.ob-tab.active{border-color:var(--border2);background:var(--bg4)}
.ob-labels{display:grid;grid-template-columns:1fr 1fr 1fr;padding:6px 10px;font-size:9.5px;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:.4px;flex-shrink:0}
.ob-labels span:last-child{text-align:right}
.ob-asks{flex:1;overflow-y:auto;display:flex;flex-direction:column-reverse}
.ob-bids{flex:1;overflow-y:auto}
.ob-asks::-webkit-scrollbar,.ob-bids::-webkit-scrollbar{width:2px}
.ob-row{display:grid;grid-template-columns:1fr 1fr 1fr;padding:2px 10px;font-size:11px;font-family:var(--font-mono);position:relative;cursor:pointer;transition:background .15s}
.ob-row:hover{background:rgba(255,255,255,.04)}
.ob-row .ob-price{font-weight:600}
.ob-row .ob-price.ask{color:var(--red)}
.ob-row .ob-price.bid{color:var(--green)}
.ob-row .ob-amt{color:var(--text2);text-align:center}
.ob-row .ob-total{color:var(--text3);text-align:right}
.ob-spread{display:flex;align-items:center;justify-content:space-between;padding:6px 10px;background:var(--bg2);border-top:1px solid var(--border);border-bottom:1px solid var(--border);flex-shrink:0}
.ob-spread-price{font-family:var(--font-mono);font-size:14px;font-weight:700;color:var(--green)}
.ob-spread-pct{font-family:var(--font-mono);font-size:10px;color:var(--text3)}
.trades-panel{display:flex;flex-direction:column;background:var(--bg1);border-left:1px solid var(--border);overflow:hidden}
.tp-header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--border);flex-shrink:0}
.tp-labels{display:grid;grid-template-columns:1fr 1fr 1fr;padding:6px 10px;font-size:9.5px;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:.4px;flex-shrink:0}
.tp-labels span:last-child{text-align:right}
.tp-feed{flex:1;overflow-y:auto}
.tp-feed::-webkit-scrollbar{width:2px}
.tp-row{display:grid;grid-template-columns:1fr 1fr 1fr;padding:3px 10px;font-size:11px;font-family:var(--font-mono);animation:tradeFlash .3s ease}
.tp-row .tp-price{font-weight:600}
.tp-row .tp-price.buy{color:var(--green)}
.tp-row .tp-price.sell{color:var(--red)}
.tp-row .tp-amt{color:var(--text2);text-align:center}
.tp-row .tp-time{color:var(--text3);text-align:right}
.market-overview-section{padding:24px 20px}
.market-cards-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px}
.market-card{background:var(--bg1);border:1px solid var(--border);border-radius:var(--r-lg);padding:16px;cursor:pointer;transition:all .2s}
.market-card:hover{border-color:var(--border2);transform:translateY(-2px)}
.mc-sym{font-family:var(--font-display);font-size:14px;font-weight:700;margin-bottom:8px}
.mc-price{font-family:var(--font-mono);font-size:20px;font-weight:700}
.mc-chg{font-family:var(--font-mono);font-size:12px;font-weight:700;margin-top:4px}
.mc-mini{height:40px;position:relative;margin-top:10px}
.mc-mini canvas{position:absolute;inset:0;width:100%;height:100%}

/* DASHBOARD */
.dash-user-chip{display:flex;align-items:center;gap:7px;padding:5px 12px;background:var(--bg2);border:1px solid var(--border);border-radius:20px;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s}
.dash-user-chip:hover{border-color:var(--border2)}
.duc-avatar{font-size:16px}
.dash-body{display:grid;grid-template-columns:220px 1fr;min-height:calc(100vh - 92px)}
.dash-sidebar{background:var(--bg1);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow-y:auto}
.sidebar-balance{padding:20px 16px;border-bottom:1px solid var(--border)}
.sbl-label{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.8px;font-weight:600;margin-bottom:4px}
.sbl-amount{font-family:var(--font-mono);font-size:24px;font-weight:700;color:var(--green);margin-bottom:2px}
.sbl-sub{font-size:11px;color:var(--text3);margin-bottom:12px}
.mode-toggle{display:flex;gap:4px;background:var(--bg0);border-radius:var(--r-md);padding:3px}
.mt-btn{flex:1;padding:6px 4px;border:none;border-radius:var(--r-sm);font-size:11px;font-weight:700;cursor:pointer;transition:all .2s;font-family:var(--font-mono);background:transparent;color:var(--text3)}
.mt-btn.active{background:var(--green);color:#000}
.sidebar-nav{flex:1;padding:12px 0}
.snav-section{padding:8px 16px 4px;font-size:10px;color:var(--text3);font-weight:700;text-transform:uppercase;letter-spacing:1px}
.snav-item{display:flex;align-items:center;gap:9px;padding:9px 16px;font-size:13px;color:var(--text2);cursor:pointer;transition:all .2s;border-left:2px solid transparent;position:relative}
.snav-item:hover{color:var(--text1);background:var(--bg2)}
.snav-item.active{color:var(--green);background:var(--green3);border-left-color:var(--green)}
.snav-icon{font-size:15px;width:20px;text-align:center}
.snav-badge{margin-left:auto;font-size:10px;padding:2px 6px;background:var(--green3);color:var(--green);border-radius:10px;font-weight:700;font-family:var(--font-mono)}
.sidebar-ref-card{margin:12px;padding:12px;background:var(--bg2);border:1px solid var(--border);border-radius:var(--r-lg)}
.src-link{font-size:10px;color:var(--text3);font-family:var(--font-mono);word-break:break-all;margin-bottom:8px;line-height:1.4}
.src-copy{width:100%;padding:6px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--r-sm);color:var(--text2);font-size:11px;cursor:pointer;transition:all .2s}
.src-copy:hover{color:var(--text1);border-color:var(--border2)}
.dash-content{padding:20px;overflow-y:auto;display:flex;flex-direction:column;gap:16px;background:var(--bg0)}
.balance-cards{display:grid;grid-template-columns:2fr 1fr 1fr 1fr;gap:12px}
.bal-card{background:var(--bg1);border:1px solid var(--border);border-radius:var(--r-xl);padding:20px;position:relative;overflow:hidden;transition:all .2s}
.bal-card:hover{border-color:var(--border2)}
.bal-card.primary{background:linear-gradient(135deg,rgba(0,230,118,.1),rgba(0,200,83,.04));border-color:rgba(0,230,118,.2)}
.bc-label{font-size:11px;color:var(--text3);text-transform:uppercase;letter-spacing:.6px;font-weight:600;margin-bottom:8px}
.bc-amount{font-family:var(--font-mono);font-size:26px;font-weight:700}
.bc-change{font-size:12px;font-weight:700;padding:2px 7px;border-radius:4px;display:inline-block;margin-top:4px;font-family:var(--font-mono)}
.bc-change.up{color:var(--green);background:var(--green3)}
.bc-change.down{color:var(--red);background:var(--red2)}
.quick-actions{display:grid;grid-template-columns:repeat(6,1fr);gap:10px}
.qa-btn{display:flex;flex-direction:column;align-items:center;gap:6px;padding:16px 8px;border:1px solid var(--border);border-radius:var(--r-xl);background:var(--bg1);cursor:pointer;transition:all .25s;font-size:12px;font-weight:600;color:var(--text2)}
.qa-btn:hover{transform:translateY(-3px);border-color:var(--border2);color:var(--text1);box-shadow:0 6px 20px rgba(0,0,0,.3)}
.qa-icon{font-size:22px}
.qa-trade{border-color:rgba(255,215,64,.2);background:rgba(255,215,64,.04)}.qa-trade:hover{border-color:var(--yellow);box-shadow:0 6px 20px rgba(255,215,64,.15)}
.qa-deposit{border-color:rgba(0,230,118,.2);background:var(--green3)}.qa-deposit:hover{border-color:var(--green);box-shadow:0 6px 20px rgba(0,230,118,.15)}
.qa-withdraw{border-color:rgba(68,138,255,.2);background:rgba(68,138,255,.05)}.qa-withdraw:hover{border-color:var(--blue);box-shadow:0 6px 20px rgba(68,138,255,.15)}
.qa-bots{border-color:rgba(170,119,255,.2);background:rgba(170,119,255,.05)}.qa-bots:hover{border-color:var(--purple);box-shadow:0 6px 20px rgba(170,119,255,.15)}
.qa-ref{border-color:rgba(0,229,255,.2);background:rgba(0,229,255,.04)}.qa-ref:hover{border-color:var(--cyan);box-shadow:0 6px 20px rgba(0,229,255,.15)}
.qa-charts{border-color:rgba(255,61,87,.2);background:var(--red2)}.qa-charts:hover{border-color:var(--red);box-shadow:0 6px 20px rgba(255,61,87,.15)}
.dash-card{background:var(--bg1);border:1px solid var(--border);border-radius:var(--r-xl);padding:18px}
.dc-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.dc-title{font-family:var(--font-display);font-size:14px;font-weight:700}
.dc-badge{font-size:11px;padding:3px 9px;background:var(--bg3);border-radius:20px;color:var(--text2);font-family:var(--font-mono)}
.dc-link{font-size:12px;color:var(--green);cursor:pointer;font-weight:600}
.dc-tabs{display:flex;gap:4px}
.dc-tab{padding:4px 10px;background:transparent;border:1px solid var(--border);border-radius:var(--r-sm);font-size:11px;font-weight:700;cursor:pointer;color:var(--text3);font-family:var(--font-mono);transition:all .2s}
.dc-tab.active{color:var(--green);border-color:rgba(0,230,118,.3);background:var(--green3)}
.dash-two-col{display:grid;grid-template-columns:1.5fr 1fr;gap:16px}
.dash-three-col{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
.dc-chart-wrap{height:180px;position:relative;margin-bottom:12px}
.dc-chart-wrap canvas{position:absolute;inset:0;width:100%;height:100%}
.perf-footer{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;padding-top:12px;border-top:1px solid var(--border)}
.pf-item{text-align:center}
.pf-lbl{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:3px}
.pf-val{font-family:var(--font-mono);font-size:14px;font-weight:700}
.position-row{background:var(--bg2);border-radius:var(--r-lg);padding:12px 14px;margin-bottom:8px;border:1px solid var(--border);transition:all .2s}
.position-row:hover{border-color:var(--border2)}
.pr-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.pr-pair{font-weight:700;font-size:13px;font-family:var(--font-display)}
.pr-type{font-size:11px;font-weight:700;padding:2px 8px;border-radius:4px;font-family:var(--font-mono)}
.pr-type.long{color:var(--green);background:var(--green3)}
.pr-type.short{color:var(--red);background:var(--red2)}
.pr-pnl{font-family:var(--font-mono);font-size:15px;font-weight:700}
.pr-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:6px}
.pr-stat{font-size:10px}
.pr-stat-lbl{color:var(--text3);display:block;margin-bottom:2px}
.pr-stat-val{color:var(--text1);font-family:var(--font-mono);font-weight:600;font-size:11px}
.pr-close-btn{width:100%;margin-top:8px;padding:6px;background:var(--red2);border:1px solid rgba(255,61,87,.3);border-radius:var(--r-sm);color:var(--red);font-size:11px;font-weight:700;cursor:pointer;transition:all .2s}
.pr-close-btn:hover{background:var(--red);color:#fff}
.alloc-chart-wrap{position:relative;width:140px;height:140px;margin:0 auto 12px}
.alloc-chart-wrap canvas{position:absolute;inset:0;width:100%;height:100%}
.alloc-center{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center}
.ac-amount{font-family:var(--font-mono);font-size:15px;font-weight:700}
.ac-label{font-size:10px;color:var(--text3)}
.alloc-legend{display:flex;flex-direction:column;gap:6px}
.al-row{display:flex;align-items:center;justify-content:space-between;font-size:12px}
.al-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.al-name{color:var(--text2);margin-left:6px;flex:1}
.al-pct{color:var(--text1);font-weight:600;font-family:var(--font-mono)}
.rt-row{display:grid;grid-template-columns:auto 1fr auto auto;gap:8px;align-items:center;padding:8px 0;border-bottom:1px solid var(--border);font-size:12px}
.rt-row:last-child{border-bottom:none}
.rt-type{padding:2px 7px;border-radius:4px;font-size:10px;font-weight:700;font-family:var(--font-mono)}
.rt-type.win{color:var(--green);background:var(--green3)}
.rt-type.loss{color:var(--red);background:var(--red2)}
.rt-pair{font-weight:600;color:var(--text1)}
.rt-pnl{font-family:var(--font-mono);font-weight:700}
.rt-date{font-size:10px;color:var(--text3)}
.msnap-list{display:flex;flex-direction:column;gap:0}
.ms-row{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);cursor:pointer;transition:all .15s}
.ms-row:last-child{border-bottom:none}
.ms-row:hover{padding-left:4px}
.ms-sym{font-weight:700;font-size:13px;font-family:var(--font-display)}
.ms-price{font-family:var(--font-mono);font-size:12px}
.ms-chg{font-family:var(--font-mono);font-size:11px;font-weight:700;padding:2px 6px;border-radius:4px}
.kyc-notice{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;background:linear-gradient(135deg,rgba(255,215,64,.12),rgba(245,158,11,.06));border:1px solid rgba(255,215,64,.25);border-radius:var(--r-xl);flex-wrap:wrap;gap:12px}
.kyc-btn{padding:9px 20px;background:var(--yellow);color:#000;border:none;border-radius:var(--r-md);font-size:13px;font-weight:700;cursor:pointer;transition:all .2s}
.kyc-btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(255,215,64,.3)}
.empty-state{text-align:center;padding:28px 16px}

/* TRADING LAYER */
.trade-price-strip{display:flex;align-items:center;gap:20px;padding:9px 20px;background:var(--bg1);border-bottom:1px solid var(--border);flex-wrap:wrap}
.tps-left{display:flex;align-items:baseline;gap:10px}
.tps-pair{font-family:var(--font-display);font-size:15px;font-weight:800}
.tps-price{font-family:var(--font-mono);font-size:24px;font-weight:700;transition:color .3s}
.tps-chg{font-size:12px;font-weight:700;padding:2px 8px;border-radius:var(--r-sm);font-family:var(--font-mono)}
.tps-stats{display:flex;gap:20px;flex:1}
.tps-stat{display:flex;flex-direction:column;gap:1px}
.tps-lbl{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px}
.tps-val{font-family:var(--font-mono);font-size:12px;font-weight:600}
.tps-bal{display:flex;flex-direction:column;gap:1px;margin-left:auto;text-align:right}
.trading-body{display:grid;grid-template-columns:1fr 260px 220px;height:calc(100vh - 168px);min-height:480px}
.trade-chart-col{display:flex;flex-direction:column;border-right:1px solid var(--border);min-width:0;overflow:hidden}
.order-panel{background:var(--bg1);border-right:1px solid var(--border);overflow-y:auto;display:flex;flex-direction:column}
.order-panel::-webkit-scrollbar{width:3px}
.order-tabs{display:grid;grid-template-columns:1fr 1fr;border-bottom:1px solid var(--border)}
.ot-btn{padding:14px 8px;border:none;font-size:13px;font-weight:800;cursor:pointer;transition:all .2s;font-family:var(--font-mono);background:var(--bg2);color:var(--text3)}
.ot-btn.buy.active{background:var(--green3);color:var(--green);border-bottom:2px solid var(--green)}
.ot-btn.sell.active{background:var(--red2);color:var(--red);border-bottom:2px solid var(--red)}
.order-type-row{display:flex;gap:4px;padding:10px 12px;border-bottom:1px solid var(--border)}
.order-type-btn{flex:1;padding:5px 4px;background:var(--bg2);border:1px solid var(--border);border-radius:var(--r-sm);color:var(--text3);font-size:11px;font-weight:600;cursor:pointer;transition:all .2s;font-family:var(--font-mono)}
.order-type-btn.active{color:var(--text1);border-color:var(--border2);background:var(--bg3)}
.op-group{padding:10px 12px;border-bottom:1px solid var(--border)}
.op-label{display:flex;justify-content:space-between;font-size:11px;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px}
.op-leverage-val{color:var(--yellow);font-family:var(--font-mono);font-size:13px;font-weight:800}
.op-input-wrap{display:flex;align-items:center;background:var(--bg2);border:1px solid var(--border);border-radius:var(--r-md);overflow:hidden}
.op-input{flex:1;padding:9px 10px;background:transparent;border:none;color:var(--text1);font-size:14px;font-family:var(--font-mono);outline:none}
.op-input::placeholder{color:var(--text3)}
.op-input-suffix{padding:0 10px;font-size:11px;color:var(--text3);font-family:var(--font-mono);font-weight:600;border-left:1px solid var(--border)}
.op-input-wrap:focus-within{border-color:rgba(0,230,118,.4)}
.quick-pct-row{display:flex;gap:4px;margin-top:8px}
.qp-btn{flex:1;padding:4px;background:var(--bg3);border:1px solid var(--border);border-radius:4px;color:var(--text3);font-size:11px;font-weight:700;cursor:pointer;transition:all .2s;font-family:var(--font-mono)}
.qp-btn:hover{color:var(--green);border-color:rgba(0,230,118,.3);background:var(--green3)}
.leverage-slider{width:100%;height:4px;margin:8px 0 4px;appearance:none;-webkit-appearance:none;background:linear-gradient(to right,var(--green) 0%,var(--green) 10%,var(--bg3) 10%,var(--bg3) 100%);border-radius:2px;outline:none;cursor:pointer}
.leverage-slider::-webkit-slider-thumb{appearance:none;width:14px;height:14px;background:var(--green);border-radius:50%;cursor:pointer;box-shadow:0 0 6px rgba(0,230,118,.5)}
.leverage-marks{display:flex;justify-content:space-between;font-size:10px;color:var(--text3);font-family:var(--font-mono)}
.leverage-marks span{cursor:pointer;transition:color .2s}
.leverage-marks span:hover{color:var(--green)}
.tp-sl-row{display:flex;gap:0}
.tp-sl-row .op-group:first-child{border-right:1px solid var(--border)}
.order-summary{padding:10px 12px;border-bottom:1px solid var(--border);background:var(--bg0)}
.os-row{display:flex;justify-content:space-between;font-size:11px;padding:3px 0}
.os-row span:first-child{color:var(--text3)}
.os-row span:last-child{font-family:var(--font-mono);font-weight:600;color:var(--text1)}
.risk-warning{display:flex;align-items:center;gap:8px;padding:8px 12px;background:rgba(255,215,64,.08);border-bottom:1px solid rgba(255,215,64,.15);font-size:11px;color:var(--yellow)}
.order-submit-btn{width:100%;padding:15px;border:none;font-size:15px;font-weight:800;cursor:pointer;transition:all .2s;font-family:var(--font-mono);letter-spacing:.5px}
.order-submit-btn.buy{background:linear-gradient(135deg,var(--green),var(--green2));color:#000}
.order-submit-btn.sell{background:linear-gradient(135deg,var(--red),#c92a40);color:#fff}
.order-submit-btn:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(0,0,0,.3)}
.op-mode-row{display:flex;align-items:center;gap:8px;padding:10px 12px;margin-top:auto;border-top:1px solid var(--border)}
.op-mode-btn{padding:4px 12px;background:var(--bg2);border:1px solid var(--border);border-radius:20px;font-size:11px;font-weight:700;cursor:pointer;transition:all .2s;font-family:var(--font-mono);color:var(--text3)}
.op-mode-btn.active{background:var(--green);color:#000;border-color:var(--green)}
.trade-right-col{display:flex;flex-direction:column;overflow:hidden;background:var(--bg1)}
.mini-ob{border-bottom:1px solid var(--border);flex-shrink:0}
.mob-header{padding:8px 12px;font-size:12px;font-weight:700;font-family:var(--font-display);border-bottom:1px solid var(--border)}
.my-positions{flex:1;overflow-y:auto;display:flex;flex-direction:column;border-bottom:1px solid var(--border)}
.my-pos-row{padding:8px 10px;border-bottom:1px solid var(--border);font-size:11px}
.mpr-top{display:flex;justify-content:space-between;margin-bottom:4px}
.mpr-pair{font-weight:700;font-family:var(--font-display)}
.mpr-pnl{font-family:var(--font-mono);font-weight:700}
.mpr-stats{display:flex;gap:8px;font-size:10px;color:var(--text3);font-family:var(--font-mono)}
.mpr-close{background:var(--red2);border:1px solid rgba(255,61,87,.2);border-radius:3px;color:var(--red);font-size:10px;font-weight:700;cursor:pointer;padding:2px 6px;float:right;margin-top:4px;transition:all .2s}
.mpr-close:hover{background:var(--red);color:#fff}

/* ORDER CONFIRMATION MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:2000;display:flex;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(4px)}
.modal-box{background:var(--bg2);border:1px solid var(--border2);border-radius:var(--r-xl);padding:28px;max-width:420px;width:100%;animation:countUp .3s ease;box-shadow:0 40px 80px rgba(0,0,0,.8)}
.modal-title{font-family:var(--font-display);font-size:20px;font-weight:800;margin-bottom:20px;display:flex;align-items:center;gap:10px}
.modal-row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border);font-size:13px}
.modal-row:last-of-type{border-bottom:none}
.modal-row span:first-child{color:var(--text2)}
.modal-row span:last-child{font-family:var(--font-mono);font-weight:700}
.modal-actions{display:flex;gap:10px;margin-top:20px}

/* ORDER FILL NOTIFICATION */
.fill-notification{position:fixed;bottom:90px;left:50%;transform:translateX(-50%);background:var(--bg2);border:1px solid var(--border2);border-radius:var(--r-lg);padding:14px 20px;box-shadow:0 16px 48px rgba(0,0,0,.6);z-index:1500;font-size:13px;display:flex;align-items:center;gap:12px;min-width:300px;animation:slideUp .3s ease}
.fill-icon{font-size:22px}
.fill-text{font-weight:700;font-size:14px}
.fill-sub{font-size:11px;color:var(--text2);margin-top:2px}

/* DEPOSIT/WITHDRAW */
.dep-method-btn{display:flex;flex-direction:column;align-items:center;padding:14px 8px;background:var(--bg2);border:1px solid var(--border);border-radius:var(--r-lg);cursor:pointer;transition:all .2s;color:var(--text2)}
.dep-method-btn.active{border-color:var(--green);background:var(--green3);color:var(--text1)}
.dep-method-btn:hover{border-color:var(--border2);color:var(--text1)}

/* BOTS */
.bots-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}
.bot-card{background:var(--bg1);border:1px solid var(--border);border-radius:var(--r-xl);padding:20px;transition:all .25s}
.bot-card.active-bot{border-color:rgba(0,230,118,.35);background:rgba(0,230,118,.03)}
.bot-card:hover{border-color:var(--border2);transform:translateY(-2px);box-shadow:0 8px 28px rgba(0,0,0,.3)}
.bc-top{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.bc-icon{width:44px;height:44px;border-radius:var(--r-md);display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0}
.bc-name{font-family:var(--font-display);font-size:15px;font-weight:700}
.bc-risk{font-size:11px;font-weight:600}
.bc-status{margin-left:auto;font-size:11px;font-weight:800;font-family:var(--font-mono)}
.bc-status.on{color:var(--green)}.bc-status.off{color:var(--text3)}
.bc-desc{font-size:12px;color:var(--text2);line-height:1.55;margin-bottom:14px}
.bc-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:12px}
.bc-stat{background:var(--bg2);border-radius:var(--r-sm);padding:8px 4px;text-align:center}
.bcs-val{font-family:var(--font-mono);font-size:13px;font-weight:700}
.bcs-lbl{font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:.4px;margin-top:2px}
.bc-pairs{font-size:11px;color:var(--text3);margin-bottom:12px}
.bc-toggle-btn{width:100%;padding:10px;border:none;border-radius:var(--r-md);font-size:13px;font-weight:700;cursor:pointer;transition:all .2s;font-family:var(--font-mono)}
.bc-toggle-btn.start{background:var(--green);color:#000}
.bc-toggle-btn.stop{background:var(--red2);border:1px solid rgba(255,61,87,.3);color:var(--red)}
.bc-toggle-btn.start:hover{background:var(--green2)}
.bc-toggle-btn.stop:hover{background:var(--red);color:#fff}
.bc-running{display:flex;align-items:center;font-size:11px;color:var(--green);margin-top:8px;font-family:var(--font-mono)}

/* SIGNALS */
.signal-card{background:var(--bg1);border:1px solid var(--border);border-radius:var(--r-xl);padding:18px;transition:all .25s;cursor:pointer;position:relative;overflow:hidden}
.signal-card::after{content:'';position:absolute;top:0;left:0;right:0;height:3px;opacity:0;transition:opacity .25s;border-radius:var(--r-xl) var(--r-xl) 0 0}
.signal-card:hover{border-color:var(--border2);transform:translateY(-3px);box-shadow:0 12px 36px rgba(0,0,0,.4)}
.signal-card:hover::after{opacity:1}
.signal-card.buy-sig::after{background:linear-gradient(90deg,var(--green),var(--cyan))}
.signal-card.sell-sig::after{background:linear-gradient(90deg,var(--red),#ff6b8a)}
.sig-direction{display:inline-flex;align-items:center;gap:6px;padding:5px 14px;border-radius:20px;font-size:12px;font-weight:800;font-family:var(--font-mono)}
.sig-direction.buy{background:var(--green3);color:var(--green);border:1px solid rgba(0,230,118,.3)}
.sig-direction.sell{background:var(--red2);color:var(--red);border:1px solid rgba(255,61,87,.3)}
.sig-stat{background:var(--bg2);border-radius:var(--r-md);padding:8px 10px}
.sig-stat-lbl{font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px}
.sig-stat-val{font-family:var(--font-mono);font-size:13px;font-weight:700}
.conf-bar{flex:1;height:4px;background:var(--bg3);border-radius:2px;overflow:hidden}
.conf-fill{height:100%;border-radius:2px;transition:width .6s ease}
.ind-tag{padding:3px 8px;border-radius:4px;font-size:10px;font-weight:700;font-family:var(--font-mono)}
.ind-bull{background:var(--green3);color:var(--green)}
.ind-bear{background:var(--red2);color:var(--red)}
.ind-neutral{background:rgba(255,255,255,.06);color:var(--text2)}

/* ANALYSIS */
.hm-cell{border-radius:var(--r-md);padding:14px 8px;text-align:center;cursor:pointer;transition:all .2s}
.hm-cell:hover{transform:scale(1.06)}
.hm-sym{font-family:var(--font-display);font-size:12px;font-weight:800;margin-bottom:3px}
.hm-chg{font-family:var(--font-mono);font-size:12px;font-weight:700}
.news-item{display:flex;gap:12px;padding:12px 0;border-bottom:1px solid var(--border);cursor:pointer;transition:padding .15s}
.news-item:last-child{border-bottom:none}
.news-item:hover{padding-left:6px}

/* HISTORY */
.hist-row{border-bottom:1px solid var(--border);transition:background .15s}
.hist-row:hover{background:var(--bg2)}
.hist-row td{padding:10px 12px}

/* REFERRAL */
.ref-hist-row{display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid var(--border)}
.ref-hist-row:last-child{border-bottom:none}

/* RECOMMENDATIONS */
.rec-action-card{background:var(--bg1);border:1px solid var(--border);border-radius:var(--r-xl);padding:18px;display:flex;align-items:center;gap:16px;transition:all .25s;cursor:pointer}
.rec-action-card:hover{border-color:var(--border2);transform:translateY(-2px);box-shadow:0 8px 28px rgba(0,0,0,.3)}
.rec-action-icon{width:48px;height:48px;border-radius:var(--r-md);display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0}
.rec-priority{font-size:10px;font-weight:700;padding:2px 7px;border-radius:4px;font-family:var(--font-mono)}
.rec-priority.high{background:var(--red2);color:var(--red)}
.rec-priority.med{background:rgba(255,215,64,.1);color:var(--yellow)}
.rec-priority.low{background:var(--green3);color:var(--green)}
.learn-step{display:flex;align-items:center;gap:14px;padding:14px 0;border-bottom:1px solid var(--border);cursor:pointer;transition:all .2s}
.learn-step:last-child{border-bottom:none}
.learn-step:hover{padding-left:6px}
.learn-step-num{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:800;font-family:var(--font-mono);flex-shrink:0}
.bot-suggest-row{display:flex;align-items:center;gap:14px;padding:14px;background:var(--bg2);border:1px solid var(--border);border-radius:var(--r-lg);transition:all .2s}
.bot-suggest-row:hover{border-color:var(--border2)}

/* UTILITIES */
.container{max-width:1440px;margin:0 auto;padding:0 24px}
.text-green{color:var(--green)}.text-red{color:var(--red)}.text-blue{color:var(--blue)}.text-yellow{color:var(--yellow)}.text-dim{color:var(--text2)}
.mono{font-family:var(--font-mono)}.fw-bold{font-weight:700}

/* RESPONSIVE */
@media(max-width:768px){
  .hero{padding:48px 20px 40px}.hero-title{font-size:34px}.stats-bar{flex-wrap:wrap}
  .stat-item{min-width:50%;border-bottom:1px solid var(--border)}.nav-ticker{display:none}
  .winners-grid,.features-grid,.reviews-grid{grid-template-columns:1fr}
  #aiPanel{width:calc(100vw - 32px);right:16px;height:520px}
}
@media(max-width:860px){.auth-page{grid-template-columns:1fr}.auth-left{display:none}.auth-right{padding:24px 16px;min-height:100vh}}
@media(max-width:900px){
  .chart-layout{grid-template-columns:1fr;height:auto}.orderbook-panel,.trades-panel{display:none}
  #tvChartContainer{height:320px;flex:none}
  .dash-body{grid-template-columns:1fr}.dash-sidebar{display:none}
  .balance-cards{grid-template-columns:1fr 1fr}.quick-actions{grid-template-columns:repeat(3,1fr)}
  .dash-two-col,.dash-three-col{grid-template-columns:1fr}
}
@media(max-width:1100px){
  .dash-three-col{grid-template-columns:1fr 1fr}
  .trading-body{grid-template-columns:1fr 260px}.trade-right-col{display:none}
}
@media(max-width:480px){.balance-cards{grid-template-columns:1fr}.quick-actions{grid-template-columns:repeat(2,1fr)}}
@media(max-width:750px){.trading-body{grid-template-columns:1fr;height:auto}.trade-chart-col #tvTradingChart{height:260px}}
</style>
</head>
<body>

<!-- REFERRAL BANNER -->
<div id="refBanner">
  <button class="ref-close" onclick="closeRefBanner()">×</button>
  <div style="font-size:13px;color:rgba(255,255,255,.7);margin-bottom:4px;">🎉 <strong id="refName">Your friend</strong> invited you to CryptoPro!</div>
  <span class="ref-bonus-amt">$25 SIGNUP BONUS</span>
  <div style="font-size:12px;color:rgba(255,255,255,.6);margin-top:6px;">Sign up now — bonus credited instantly</div>
</div>
<div id="toast"></div>

<!-- ORDER CONFIRMATION MODAL -->
<div class="modal-overlay" id="orderModal" style="display:none;" onclick="closeOrderModal(event)">
  <div class="modal-box">
    <div class="modal-title" id="modalTitle">Confirm Order</div>
    <div id="modalRows"></div>
    <div class="modal-actions">
      <button class="btn-auth-outline" style="flex:1" onclick="document.getElementById('orderModal').style.display='none'">Cancel</button>
      <button class="btn-auth" style="flex:2" id="modalConfirmBtn" onclick="confirmTrade()">✅ Confirm Trade</button>
    </div>
  </div>
</div>

<!-- FILL NOTIFICATION -->
<div id="fillNotif" style="display:none;"></div>

<!-- AI BUTTON -->
<button id="aiBtn" onclick="toggleAI()">
  <div class="ai-pulse-ring"></div>
  <div class="ai-pulse-ring2"></div>
  <div class="ai-logo">
    <svg viewBox="0 0 30 30" fill="none" xmlns="http://www.w3.org/2000/svg">
      <circle cx="15" cy="15" r="14" fill="url(#aiGrad)"/>
      <path d="M9 15C9 11.686 11.686 9 15 9V9C18.314 9 21 11.686 21 15V15C21 18.314 18.314 21 15 21V21C11.686 21 9 18.314 9 15V15Z" stroke="white" stroke-width="1.5"/>
      <circle cx="15" cy="15" r="3" fill="white"/>
      <path d="M15 5V7M15 23V25M5 15H7M23 15H25" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
      <defs><linearGradient id="aiGrad" x1="0" y1="0" x2="30" y2="30" gradientUnits="userSpaceOnUse"><stop stop-color="#1E40AF"/><stop offset="1" stop-color="#3B82F6"/></linearGradient></defs>
    </svg>
  </div>
</button>

<!-- AI PANEL -->
<div id="aiPanel">
  <div class="ai-header">
    <div class="ai-avatar">
      <svg viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg">
        <circle cx="11" cy="11" r="10" fill="rgba(59,130,246,0.3)"/>
        <path d="M6 11C6 8.239 8.239 6 11 6C13.761 6 16 8.239 16 11C16 13.761 13.761 16 11 16C8.239 16 6 13.761 6 11Z" stroke="white" stroke-width="1.2"/>
        <circle cx="11" cy="11" r="2.5" fill="white"/>
        <path d="M11 2V4M11 18V20M2 11H4M18 11H20" stroke="white" stroke-width="1.2" stroke-linecap="round"/>
      </svg>
    </div>
    <div class="ai-header-info">
      <div class="ai-header-title">CryptoPro AI</div>
      <div class="ai-header-status">Neural Engine Online</div>
    </div>
    <div class="ai-header-actions">
      <button class="ai-header-btn" onclick="clearAIChat()" title="Clear chat">🗑</button>
      <button class="ai-header-btn" onclick="toggleAI()" title="Close">✕</button>
    </div>
  </div>
  <div class="ai-model-bar">
    <span>Model:</span>
    <div class="ai-model-pill">⚡ CryptoPro-Neural v2</div>
    <span style="margin-left:auto">Context: <strong style="color:var(--text1)">Active</strong></span>
  </div>
  <div class="ai-messages" id="aiMessages">
    <div class="ai-msg bot">
      <div class="ai-msg-bubble">
        👋 <strong>Hello! I'm CryptoPro AI</strong> — your advanced trading intelligence assistant.<br><br>
        I can help you with:<br>
        • 📊 Real-time market analysis<br>
        • 🤖 AI bot strategies & setup<br>
        • 💰 Deposits, withdrawals & payments<br>
        • ⚡ Trade signals & entry points<br>
        • 🎓 Trading education & risk management<br><br>
        What would you like to explore today?
      </div>
      <div class="ai-msg-meta">
        <div class="ai-msg-avatar">AI</div>
        <span>CryptoPro AI</span>
        <span>•</span>
        <span>Just now</span>
      </div>
    </div>
  </div>
  <div class="ai-capabilities">
    <div class="ai-cap">📊 Market Analysis</div>
    <div class="ai-cap">⚡ Trade Signals</div>
    <div class="ai-cap">🤖 Bot Config</div>
    <div class="ai-cap">💰 Payments</div>
    <div class="ai-cap">🛡 Risk Mgmt</div>
  </div>
  <div class="ai-suggestions">
    <button class="ai-sug" onclick="aiQuick('How do I start trading?')">🚀 Start trading</button>
    <button class="ai-sug" onclick="aiQuick('What is leverage trading?')">📊 Leverage</button>
    <button class="ai-sug" onclick="aiQuick('How do I deposit via M-Pesa?')">💰 Deposit</button>
    <button class="ai-sug" onclick="aiQuick('How do AI bots work?')">🤖 AI Bots</button>
    <button class="ai-sug" onclick="aiQuick('How do I withdraw my profits?')">💸 Withdraw</button>
    <button class="ai-sug" onclick="aiQuick('What are the best coins to trade?')">🔥 Hot coins</button>
  </div>
  <div class="ai-input-area">
    <div class="ai-input-wrap">
      <textarea class="ai-input" id="aiInput" placeholder="Ask me anything about trading…" rows="1" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendAI()}" oninput="autoResize(this)"></textarea>
      <button class="ai-send" id="aiSendBtn" onclick="sendAI()">
        <svg width="14" height="14" viewBox="0 0 14 14" fill="none"><path d="M1 7L13 1L8.5 13L7 8L1 7Z" fill="white"/></svg>
      </button>
    </div>
    <div class="ai-footer-hint">Powered by CryptoPro Neural Engine · Not financial advice</div>
  </div>
</div>

<!-- NOTIFICATION DROPDOWN -->
<div id="notifDropdown" class="notif-dropdown">
  <div class="notif-header">
    <span>Notifications</span>
    <button onclick="clearNotifications()" style="background:none;border:none;color:var(--text3);font-size:11px;cursor:pointer">Clear all</button>
  </div>
  <div id="notifList"></div>
</div>

<!-- ============================================================ -->
<!-- WELCOME LAYER -->
<!-- ============================================================ -->
<div id="welcomeLayer" class="layer active">
  <nav class="navbar">
    <div class="nav-logo" onclick="showLayer('welcomeLayer')"><div class="nav-logo-mark">₿</div><div class="nav-logo-text">Crypto<span>Pro</span></div></div>
    <div class="nav-ticker"><div class="nav-ticker-track" id="navTickerTrack"></div></div>
    <div class="nav-right">
      <div class="live-badge"><div class="live-dot"></div>LIVE</div>
      <button class="btn btn-outline" onclick="showLayer('loginLayer')">Login</button>
      <button class="btn btn-green" onclick="showLayer('signupLayer')">Sign Up Free</button>
    </div>
  </nav>
  <div class="market-bar"><div class="market-bar-track" id="marketBarTrack"></div></div>
  <section class="hero">
    <div class="hero-grid"></div>
    <div class="hero-tag"><div class="live-dot"></div>50,000+ Active Traders Worldwide</div>
    <h1 class="hero-title">Trade Smarter<br><span class="accent">Earn Bigger</span><br><span class="dim">with AI Power</span></h1>
    <p class="hero-sub">Professional crypto trading with AI bots, real-time TradingView charts, and live order books. Get your <strong style="color:var(--green)">$25 bonus</strong> when you sign up today.</p>
    <div class="hero-cta">
      <button class="btn-hero-primary" onclick="showLayer('signupLayer')">Start Trading — Free</button>
      <button class="btn-hero-secondary" onclick="showLayer('chartsLayer')">View Live Charts →</button>
    </div>
  </section>
  <div class="stats-bar">
    <div class="stat-item"><span class="stat-val">50,000+</span><span class="stat-lbl">Active Traders</span></div>
    <div class="stat-item"><span class="stat-val">$125M+</span><span class="stat-lbl">Total Volume</span></div>
    <div class="stat-item"><span class="stat-val">98.5%</span><span class="stat-lbl">Uptime</span></div>
    <div class="stat-item"><span class="stat-val">4.9★</span><span class="stat-lbl">User Rating</span></div>
    <div class="stat-item"><span class="stat-val">15,000+</span><span class="stat-lbl">Daily Trades</span></div>
  </div>
  <section class="traders-section">
    <div class="section-header"><span class="section-title">Live Active Traders</span><span class="section-badge">● LIVE</span></div>
    <div class="traders-track-wrap"><div class="traders-track" id="tradersTrack"></div></div>
  </section>
  <section class="winners-section">
    <div class="section-header"><span class="section-title">🏆 Top Traders This Week</span></div>
    <div class="winners-grid" id="winnersGrid"></div>
  </section>
  <section class="features-section">
    <div class="section-header"><span class="section-title">Why CryptoPro?</span></div>
    <div class="features-grid">
      <div class="feature-card" onclick="showLayer('chartsLayer')"><div class="feature-icon fi-green">📈</div><div class="feature-title">TradingView Charts</div><div class="feature-desc">Professional real-time candlestick charts powered by TradingView Lightweight Charts with live Binance data.</div></div>
      <div class="feature-card" onclick="showLayer('signupLayer')"><div class="feature-icon fi-blue">🤖</div><div class="feature-title">AI Trading Bots</div><div class="feature-desc">Set-and-forget automated bots with up to 91% win rate. Trade 24/7 while you sleep.</div></div>
      <div class="feature-card" onclick="showLayer('signupLayer')"><div class="feature-icon fi-yellow">⚡</div><div class="feature-title">100× Leverage</div><div class="feature-desc">Amplify your positions with up to 100x leverage on major crypto pairs.</div></div>
      <div class="feature-card" onclick="showLayer('signupLayer')"><div class="feature-icon fi-purple">💸</div><div class="feature-title">Fast Withdrawals</div><div class="feature-desc">Withdraw via M-Pesa, Bank Transfer, or USDT. Processed within 5–30 minutes.</div></div>
      <div class="feature-card" onclick="showLayer('signupLayer')"><div class="feature-icon fi-cyan">🎁</div><div class="feature-title">Referral Rewards</div><div class="feature-desc">Earn 10% lifetime commission on every deposit your referrals make.</div></div>
      <div class="feature-card"><div class="feature-icon fi-red">🔒</div><div class="feature-title">Bank-Grade Security</div><div class="feature-desc">256-bit SSL encryption, 2FA, and cold storage for all user funds.</div></div>
    </div>
  </section>
  <section class="reviews-section">
    <div class="section-header"><span class="section-title">⭐ What Traders Say</span></div>
    <div class="reviews-grid" id="reviewsGrid"></div>
  </section>
  <section class="cta-section">
    <h2 class="cta-title">Ready to Start<br><span style="color:var(--green)">Earning Today?</span></h2>
    <p class="cta-sub">Join 50,000+ traders already profiting. Get your free $25 bonus just for signing up.</p>
    <button class="btn-hero-primary" onclick="showLayer('signupLayer')">Create Free Account →</button>
  </section>
  <footer class="footer">🔒 SSL Secured &nbsp;|&nbsp; 🛡️ 2FA Protected &nbsp;|&nbsp; ✅ Funds Secured &nbsp;|&nbsp; © 2025 CryptoPro. All rights reserved.</footer>
</div>

<!-- ============================================================ -->
<!-- LOGIN LAYER -->
<!-- ============================================================ -->
<div id="loginLayer" class="layer">
  <div class="auth-page">
    <div class="auth-left">
      <div class="auth-left-inner">
        <div class="nav-logo" onclick="showLayer('welcomeLayer')" style="margin-bottom:48px;"><div class="nav-logo-mark">₿</div><div class="nav-logo-text">Crypto<span>Pro</span></div></div>
        <h1 class="auth-big-title">Welcome<br>Back<span style="color:var(--green)">.</span></h1>
        <p class="auth-big-sub">Log in to your account and continue building your portfolio.</p>
        <div class="auth-trust-list">
          <div class="auth-trust-item"><span class="auth-trust-icon">🔒</span>256-bit SSL encryption</div>
          <div class="auth-trust-item"><span class="auth-trust-icon">🛡️</span>Two-factor authentication</div>
          <div class="auth-trust-item"><span class="auth-trust-icon">⚡</span>Instant account access</div>
          <div class="auth-trust-item"><span class="auth-trust-icon">💎</span>50,000+ active traders</div>
        </div>
        <div class="auth-live-card">
          <div class="auth-live-row"><div class="live-badge"><div class="live-dot"></div>LIVE</div><span style="font-size:12px;color:var(--text3)">Right now</span></div>
          <div style="margin-top:10px;font-size:13px;color:var(--text2)" id="loginLiveMsg">🎉 Loading live feed…</div>
        </div>
      </div>
    </div>
    <div class="auth-right">
      <div class="auth-card">
        <div class="auth-card-header"><h2 class="auth-form-title">Sign in</h2><p class="auth-form-sub">Enter your credentials to access your account</p></div>
        <div id="loginAlert" class="form-alert" style="display:none;"></div>
        <form onsubmit="return handleLogin(event)">
          <div class="form-group"><label class="form-label">Email Address</label><div class="input-wrap"><span class="input-icon">✉️</span><input class="form-input" type="email" id="loginEmail" placeholder="you@email.com" required></div></div>
          <div class="form-group"><label class="form-label">Password <a class="form-label-link" href="#">Forgot password?</a></label><div class="input-wrap"><span class="input-icon">🔒</span><input class="form-input" type="password" id="loginPassword" placeholder="Enter your password" required><button type="button" class="input-eye" onclick="togglePwd('loginPassword',this)">👁</button></div></div>
          <div id="twoFAStep" style="display:none;">
            <div class="twofa-box">
              <div style="font-size:28px;margin-bottom:8px;">🔐</div>
              <div style="font-weight:700;margin-bottom:4px;">Two-Factor Authentication</div>
              <div style="font-size:12px;color:var(--text2);margin-bottom:14px;">Enter the 6-digit code sent to your phone</div>
              <div class="otp-row" id="otpRow">
                <input class="otp-input" maxlength="1" oninput="otpNext(this,0)">
                <input class="otp-input" maxlength="1" oninput="otpNext(this,1)">
                <input class="otp-input" maxlength="1" oninput="otpNext(this,2)">
                <input class="otp-input" maxlength="1" oninput="otpNext(this,3)">
                <input class="otp-input" maxlength="1" oninput="otpNext(this,4)">
                <input class="otp-input" maxlength="1" oninput="otpNext(this,5)">
              </div>
              <div style="font-size:11px;color:var(--text3);margin-top:8px;">Demo code: <strong style="color:var(--green);font-family:var(--font-mono)">123456</strong></div>
            </div>
          </div>
          <button type="submit" class="btn-auth" id="loginBtn"><span id="loginBtnText">Sign In →</span><span id="loginBtnSpinner" style="display:none" class="btn-spinner">⟳</span></button>
        </form>
        <div class="auth-divider"><span>or continue with</span></div>
        <div class="social-row">
          <button class="social-btn" onclick="showToast('Google login coming soon!','blue')">🌐 Google</button>
          <button class="social-btn" onclick="showToast('Apple login coming soon!','blue')">🍎 Apple</button>
        </div>
        <p class="auth-switch-text">Don't have an account? <a onclick="showLayer('signupLayer')">Create one free →</a></p>
      </div>
    </div>
  </div>
</div>

<!-- ============================================================ -->
<!-- SIGNUP LAYER -->
<!-- ============================================================ -->
<div id="signupLayer" class="layer">
  <div class="auth-page">
    <div class="auth-left">
      <div class="auth-left-inner">
        <div class="nav-logo" onclick="showLayer('welcomeLayer')" style="margin-bottom:48px;"><div class="nav-logo-mark">₿</div><div class="nav-logo-text">Crypto<span>Pro</span></div></div>
        <h1 class="auth-big-title">Start<br>Earning<span style="color:var(--green)">.</span></h1>
        <p class="auth-big-sub">Join 50,000+ traders already making daily profits with AI-powered automation.</p>
        <div class="signup-bonus-card">
          <div class="sbc-top"><span style="font-size:28px;">🎁</span><div><div style="font-size:12px;color:rgba(255,255,255,.6);margin-bottom:2px;">WELCOME BONUS</div><div style="font-size:32px;font-weight:900;font-family:var(--font-mono);color:var(--yellow);">$25.00</div></div></div>
          <div style="font-size:12px;color:rgba(255,255,255,.6);margin-top:8px;line-height:1.5;">✅ Credited instantly on signup<br>✅ 100% Welcome bonus on first deposit<br>✅ No hidden fees</div>
        </div>
        <div class="auth-steps">
          <div class="auth-step"><div class="step-num">1</div><span>Create your account</span></div>
          <div class="auth-step"><div class="step-num">2</div><span>Get $25 demo bonus</span></div>
          <div class="auth-step"><div class="step-num">3</div><span>Deposit &amp; start trading</span></div>
          <div class="auth-step"><div class="step-num">4</div><span>Withdraw your profits</span></div>
        </div>
      </div>
    </div>
    <div class="auth-right">
      <div class="auth-card">
        <div class="auth-card-header"><h2 class="auth-form-title">Create Account</h2><p class="auth-form-sub">Join free — takes less than 60 seconds</p></div>
        <div class="signup-progress">
          <div class="sp-bar"><div class="sp-fill" id="spFill" style="width:33%"></div></div>
          <div class="sp-steps"><span class="sp-step active" id="sp1">Personal</span><span class="sp-step" id="sp2">Security</span><span class="sp-step" id="sp3">Confirm</span></div>
        </div>
        <div id="signupAlert" class="form-alert" style="display:none;"></div>
        <form onsubmit="return handleSignup(event)" id="signupForm">
          <div id="signupStep1">
            <div class="form-group"><label class="form-label">Full Name</label><div class="input-wrap"><span class="input-icon">👤</span><input class="form-input" type="text" id="signupName" placeholder="Your full name" required></div></div>
            <div class="form-group"><label class="form-label">Email Address</label><div class="input-wrap"><span class="input-icon">✉️</span><input class="form-input" type="email" id="signupEmail" placeholder="you@email.com" required></div></div>
            <div class="form-group"><label class="form-label">Phone Number</label><div class="input-wrap"><span class="input-icon">📱</span><input class="form-input" type="tel" id="signupPhone" placeholder="+254 712 345 678" required></div></div>
            <button type="button" class="btn-auth" onclick="signupNext(1)">Continue →</button>
          </div>
          <div id="signupStep2" style="display:none;">
            <div class="form-group">
              <label class="form-label">Password</label>
              <div class="input-wrap"><span class="input-icon">🔒</span><input class="form-input" type="password" id="signupPassword" placeholder="Min. 8 characters" required oninput="checkPasswordStrength(this.value)"><button type="button" class="input-eye" onclick="togglePwd('signupPassword',this)">👁</button></div>
              <div class="pwd-strength"><div class="pwd-bar"><div class="pwd-fill" id="pwdFill"></div></div><span class="pwd-label" id="pwdLabel"></span></div>
            </div>
            <div class="form-group"><label class="form-label">Confirm Password</label><div class="input-wrap"><span class="input-icon">🔒</span><input class="form-input" type="password" id="signupConfirm" placeholder="Re-enter password" required><button type="button" class="input-eye" onclick="togglePwd('signupConfirm',this)">👁</button></div></div>
            <div class="form-group"><label class="form-label">Referral Code <span style="color:var(--text3);font-weight:400">(optional)</span></label><div class="input-wrap"><span class="input-icon">🎁</span><input class="form-input" type="text" id="signupReferralCode" placeholder="Enter referral code"></div></div>
            <div style="display:flex;gap:8px;"><button type="button" class="btn-auth-outline" onclick="signupBack(2)">← Back</button><button type="button" class="btn-auth" style="flex:1" onclick="signupNext(2)">Continue →</button></div>
          </div>
          <div id="signupStep3" style="display:none;">
            <div class="confirm-box">
              <div style="text-align:center;margin-bottom:20px;"><div style="font-size:48px;margin-bottom:8px;">🎉</div><div style="font-size:18px;font-weight:700;font-family:var(--font-display)">Almost there!</div><div style="font-size:13px;color:var(--text2);margin-top:4px">Review your details</div></div>
              <div class="confirm-row"><span>Name</span><strong id="confirmName">—</strong></div>
              <div class="confirm-row"><span>Email</span><strong id="confirmEmail">—</strong></div>
              <div class="confirm-row"><span>Phone</span><strong id="confirmPhone">—</strong></div>
              <div class="confirm-row"><span>Bonus</span><strong style="color:var(--green)">$25.00 Free</strong></div>
              <div class="confirm-row"><span>Referral</span><strong id="confirmRef">None</strong></div>
            </div>
            <label class="checkbox-row"><input type="checkbox" id="agreeTerms" required><span>I agree to the <a href="#" style="color:var(--green)">Terms of Service</a> and <a href="#" style="color:var(--green)">Privacy Policy</a></span></label>
            <div style="display:flex;gap:8px;margin-top:16px;"><button type="button" class="btn-auth-outline" onclick="signupBack(3)">← Back</button><button type="submit" class="btn-auth" style="flex:1" id="signupBtn"><span id="signupBtnText">🚀 Create Account</span><span id="signupBtnSpinner" style="display:none" class="btn-spinner">⟳</span></button></div>
          </div>
        </form>
        <p class="auth-switch-text" style="margin-top:20px;">Already have an account? <a onclick="showLayer('loginLayer')">Sign in →</a></p>
      </div>
    </div>
  </div>
</div>

<!-- ============================================================ -->
<!-- CHARTS LAYER — TradingView Lightweight Charts -->
<!-- ============================================================ -->
<div id="chartsLayer" class="layer">
  <nav class="navbar">
    <div class="nav-logo" onclick="showLayer('welcomeLayer')"><div class="nav-logo-mark">₿</div><div class="nav-logo-text">Crypto<span>Pro</span></div></div>
    <div class="nav-ticker"><div class="nav-ticker-track" id="chartNavTicker"></div></div>
    <div class="nav-right">
      <div class="live-badge"><div class="live-dot"></div>LIVE</div>
      <button class="btn btn-outline" onclick="showLayer('loginLayer')">Login</button>
      <button class="btn btn-green" onclick="showLayer('signupLayer')">Sign Up</button>
    </div>
  </nav>
  <div class="pair-bar"><div class="pair-bar-inner">
    <button class="pair-btn active" onclick="selectPair('BTC','USDT',this)">BTC/USDT</button>
    <button class="pair-btn" onclick="selectPair('ETH','USDT',this)">ETH/USDT</button>
    <button class="pair-btn" onclick="selectPair('BNB','USDT',this)">BNB/USDT</button>
    <button class="pair-btn" onclick="selectPair('SOL','USDT',this)">SOL/USDT</button>
    <button class="pair-btn" onclick="selectPair('ADA','USDT',this)">ADA/USDT</button>
    <button class="pair-btn" onclick="selectPair('XRP','USDT',this)">XRP/USDT</button>
    <button class="pair-btn" onclick="selectPair('AVAX','USDT',this)">AVAX/USDT</button>
    <button class="pair-btn" onclick="selectPair('DOT','USDT',this)">DOT/USDT</button>
  </div></div>
  <div class="price-header">
    <div class="ph-left">
      <div class="ph-pair" id="phPairName">BTC / USDT</div>
      <div class="ph-price" id="phPrice">Loading…</div>
      <div class="ph-change up" id="phChange">—</div>
    </div>
    <div class="ph-stats">
      <div class="ph-stat"><span class="ph-stat-lbl">24h High</span><span class="ph-stat-val" id="ph24hHigh">—</span></div>
      <div class="ph-stat"><span class="ph-stat-lbl">24h Low</span><span class="ph-stat-val" id="ph24hLow">—</span></div>
      <div class="ph-stat"><span class="ph-stat-lbl">24h Vol</span><span class="ph-stat-val" id="ph24hVol">—</span></div>
      <div class="ph-stat"><span class="ph-stat-lbl">Open</span><span class="ph-stat-val" id="phOpen">—</span></div>
    </div>
    <div class="ph-right">
      <div class="interval-btns">
        <button class="iv-btn active" onclick="setChartInterval('1m',this)">1m</button>
        <button class="iv-btn" onclick="setChartInterval('5m',this)">5m</button>
        <button class="iv-btn" onclick="setChartInterval('15m',this)">15m</button>
        <button class="iv-btn" onclick="setChartInterval('1h',this)">1H</button>
        <button class="iv-btn" onclick="setChartInterval('4h',this)">4H</button>
        <button class="iv-btn" onclick="setChartInterval('1d',this)">1D</button>
      </div>
    </div>
  </div>
  <div class="chart-layout">
    <div class="chart-main">
      <div class="indicator-bar">
        <span style="font-size:11px;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:.5px;">Indicators:</span>
        <button class="ind-btn active" onclick="toggleMA(this)">MA(20)</button>
        <button class="ind-btn active" onclick="toggleBB(this)">BB</button>
        <button class="ind-btn" onclick="toggleVol(this)">Volume</button>
        <button class="ind-btn" onclick="toggleRSI(this)">RSI</button>
        <div style="margin-left:auto;display:flex;align-items:center;gap:8px;">
          <div class="live-badge" style="font-size:10px;padding:3px 8px;"><div class="live-dot"></div>BINANCE LIVE</div>
          <button class="ind-btn" onclick="showLayer('signupLayer')" style="background:var(--green);color:#000;border-color:var(--green);">Trade Now →</button>
        </div>
      </div>
      <div id="tvChartContainer" style="flex:1;min-height:0;"></div>
      <div class="vol-wrap-tv" id="volWrapTV" style="display:none;"><div id="tvVolContainer" style="height:100%;"></div></div>
      <div class="rsi-wrap-tv" id="rsiWrapTV"><div id="tvRsiContainer" style="height:100%;position:relative;"><div style="position:absolute;top:4px;left:8px;font-size:10px;color:var(--text3);font-family:var(--font-mono);z-index:1;">RSI(14)</div></div></div>
      <div class="depth-section">
        <div class="depth-header"><span class="section-title">📊 Market Depth</span><div style="display:flex;gap:12px;font-size:11px;"><span style="color:var(--green);">▬ Bids</span><span style="color:var(--red);">▬ Asks</span></div></div>
        <div class="depth-wrap"><canvas id="depthCanvas"></canvas></div>
      </div>
    </div>
    <div class="orderbook-panel">
      <div class="ob-header"><span class="ob-title">Order Book</span><div class="ob-tabs"><button class="ob-tab active" onclick="setOBView('both',this)">⬛</button><button class="ob-tab" onclick="setOBView('asks',this)">🔴</button><button class="ob-tab" onclick="setOBView('bids',this)">🟢</button></div></div>
      <div class="ob-labels"><span>Price (USDT)</span><span>Amount</span><span>Total</span></div>
      <div class="ob-asks" id="obAsks"></div>
      <div class="ob-spread"><span id="obSpreadPrice" class="ob-spread-price">—</span><span id="obSpreadPct" class="ob-spread-pct">Spread</span></div>
      <div class="ob-bids" id="obBids"></div>
    </div>
    <div class="trades-panel">
      <div class="tp-header"><span class="ob-title">Recent Trades</span><div class="live-badge" style="font-size:10px;padding:3px 8px;"><div class="live-dot"></div>LIVE</div></div>
      <div class="tp-labels"><span>Price</span><span>Amount</span><span>Time</span></div>
      <div class="tp-feed" id="tradesFeed"></div>
    </div>
  </div>
  <div class="market-overview-section">
    <div class="section-header" style="padding:0 0 16px;"><span class="section-title">📈 Market Overview</span></div>
    <div class="market-cards-grid" id="marketCardsGrid"></div>
  </div>
  <div style="text-align:center;padding:32px;border-top:1px solid var(--border);">
    <p style="color:var(--text2);font-size:14px;margin-bottom:16px;">Ready to start trading these markets?</p>
    <button class="btn-hero-primary" onclick="showLayer('signupLayer')">Open Free Account →</button>
  </div>
</div>

<!-- ============================================================ -->
<!-- DASHBOARD LAYER -->
<!-- ============================================================ -->
<div id="dashboardLayer" class="layer">
  <nav class="navbar">
    <div class="nav-logo" onclick="showLayer('dashboardLayer')"><div class="nav-logo-mark">₿</div><div class="nav-logo-text">Crypto<span>Pro</span></div></div>
    <div class="nav-ticker"><div class="nav-ticker-track" id="dashNavTicker"></div></div>
    <div class="nav-right">
      <div class="live-badge"><div class="live-dot"></div>LIVE</div>
      <div style="position:relative;">
        <div class="notif-bell" id="notifBell" onclick="toggleNotifications()">🔔<div class="notif-count" id="notifCount">3</div></div>
      </div>
      <div class="dash-user-chip" id="dashUserChip"><div class="duc-avatar">👤</div><span id="duchName">User</span><span style="color:var(--text3)">▾</span></div>
      <button class="btn btn-outline" onclick="handleLogout()">Logout</button>
    </div>
  </nav>
  <div class="market-bar"><div class="market-bar-track" id="dashMarketBar"></div></div>
  <div class="dash-body">
    <aside class="dash-sidebar">
      <div class="sidebar-balance">
        <div class="sbl-label" id="sblLabel">DEMO BALANCE</div>
        <div class="sbl-amount" id="sblAmount">$25.00</div>
        <div class="sbl-sub">Available to trade</div>
        <div class="mode-toggle"><button class="mt-btn active" id="mtDemo" onclick="switchMode('demo')">📊 DEMO</button><button class="mt-btn" id="mtReal" onclick="switchMode('real')">💎 REAL</button></div>
      </div>
      <nav class="sidebar-nav">
        <div class="snav-section">MAIN</div>
        <div class="snav-item active" id="snavOverview" onclick="dashTab('overview')"><span class="snav-icon">📊</span>Overview</div>
        <div class="snav-item" onclick="showLayer('tradingLayer')"><span class="snav-icon">⚡</span>Trade</div>
        <div class="snav-item" onclick="showLayer('chartsLayer')"><span class="snav-icon">📈</span>Live Charts</div>
        <div class="snav-item" onclick="showLayer('botsLayer')"><span class="snav-icon">🤖</span>AI Bots</div>
        <div class="snav-section">INSIGHTS</div>
        <div class="snav-item" onclick="showLayer('signalsLayer')"><span class="snav-icon">📡</span>AI Signals<span class="snav-badge">LIVE</span></div>
        <div class="snav-item" onclick="showLayer('analysisLayer')"><span class="snav-icon">🧠</span>Analysis</div>
        <div class="snav-item" onclick="showLayer('recommendLayer')"><span class="snav-icon">⭐</span>For You</div>
        <div class="snav-section">ACCOUNT</div>
        <div class="snav-item" onclick="showLayer('depositLayer')"><span class="snav-icon">💰</span>Deposit</div>
        <div class="snav-item" onclick="showLayer('withdrawLayer')"><span class="snav-icon">💸</span>Withdraw</div>
        <div class="snav-item" onclick="showLayer('historyLayer')"><span class="snav-icon">📜</span>History</div>
        <div class="snav-item" onclick="showLayer('referralLayer')"><span class="snav-icon">🎁</span>Referrals<span class="snav-badge">10%</span></div>
        <div class="snav-item" onclick="showLayer('profileLayer')"><span class="snav-icon">⚙️</span>Profile</div>
      </nav>
      <div class="sidebar-ref-card">
        <div style="font-size:11px;color:var(--text3);margin-bottom:6px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;">Referral Link</div>
        <div class="src-link" id="sideRefLink">Loading…</div>
        <button class="src-copy" onclick="copySideRef()">📋 Copy Link</button>
      </div>
    </aside>
    <main class="dash-content" id="dashContent">
      <div class="balance-cards">
        <div class="bal-card primary"><div class="bc-label" id="bcLabel">Demo Balance</div><div class="bc-amount" id="bcAmount">$25.00</div><div class="bc-change up" id="bcChange">+0.00%</div></div>
        <div class="bal-card"><div class="bc-label">Total Profit</div><div class="bc-amount text-green" id="bcProfit">$0.00</div><div style="font-size:11px;color:var(--text3);margin-top:4px;">All time</div></div>
        <div class="bal-card"><div class="bc-label">Total Deposits</div><div class="bc-amount" id="bcDeposits">$0.00</div><div style="font-size:11px;color:var(--text3);margin-top:4px;">Cumulative</div></div>
        <div class="bal-card"><div class="bc-label">Win Rate</div><div class="bc-amount text-blue" id="bcWinRate">—</div><div style="font-size:11px;color:var(--text3);margin-top:4px;">Closed trades</div></div>
      </div>
      <div class="quick-actions">
        <button class="qa-btn qa-trade" onclick="showLayer('tradingLayer')"><span class="qa-icon">⚡</span><span>Trade</span></button>
        <button class="qa-btn qa-deposit" onclick="showLayer('depositLayer')"><span class="qa-icon">💰</span><span>Deposit</span></button>
        <button class="qa-btn qa-withdraw" onclick="showLayer('withdrawLayer')"><span class="qa-icon">💸</span><span>Withdraw</span></button>
        <button class="qa-btn qa-bots" onclick="showLayer('botsLayer')"><span class="qa-icon">🤖</span><span>AI Bots</span></button>
        <button class="qa-btn qa-ref" onclick="showLayer('referralLayer')"><span class="qa-icon">🎁</span><span>Refer</span></button>
        <button class="qa-btn qa-charts" onclick="showLayer('chartsLayer')"><span class="qa-icon">📈</span><span>Charts</span></button>
      </div>
      <div class="dash-two-col">
        <div class="dash-card">
          <div class="dc-header"><span class="dc-title">📈 Portfolio Performance</span><div class="dc-tabs"><button class="dc-tab active" onclick="setPerfPeriod('7d',this)">7D</button><button class="dc-tab" onclick="setPerfPeriod('30d',this)">30D</button><button class="dc-tab" onclick="setPerfPeriod('90d',this)">90D</button></div></div>
          <div class="dc-chart-wrap"><canvas id="perfCanvas"></canvas></div>
          <div class="perf-footer">
            <div class="pf-item"><span class="pf-lbl">Period Return</span><span class="pf-val text-green" id="pfReturn">+0.00%</span></div>
            <div class="pf-item"><span class="pf-lbl">Best Day</span><span class="pf-val text-green" id="pfBest">+0.00%</span></div>
            <div class="pf-item"><span class="pf-lbl">Worst Day</span><span class="pf-val text-red" id="pfWorst">-0.00%</span></div>
          </div>
        </div>
        <div class="dash-card">
          <div class="dc-header"><span class="dc-title">🔓 Open Positions</span><span class="dc-badge" id="openPosCount">0 Active</span></div>
          <div id="openPositionsContainer"><div class="empty-state"><div style="font-size:40px;margin-bottom:8px;">📊</div><div style="font-weight:600;color:var(--text2);">No open positions</div><div style="font-size:12px;color:var(--text3);margin-top:4px;">Start trading to see live P&L here</div><button class="btn btn-green" style="margin-top:16px;" onclick="showLayer('tradingLayer')">Open Trade →</button></div></div>
        </div>
      </div>
      <div class="dash-three-col">
        <div class="dash-card">
          <div class="dc-header"><span class="dc-title">💼 Asset Allocation</span></div>
          <div class="alloc-chart-wrap"><canvas id="allocCanvas"></canvas><div class="alloc-center"><div class="ac-amount" id="acAmount">$0</div><div class="ac-label">Total</div></div></div>
          <div class="alloc-legend" id="allocLegend"></div>
        </div>
        <div class="dash-card">
          <div class="dc-header"><span class="dc-title">📜 Recent Trades</span><a class="dc-link" onclick="showLayer('historyLayer')">View all →</a></div>
          <div id="recentTradesContainer"><div class="empty-state"><div style="font-size:36px;margin-bottom:8px;">📭</div><div style="font-size:13px;color:var(--text2);">No trades yet</div></div></div>
        </div>
        <div class="dash-card">
          <div class="dc-header"><span class="dc-title">🌐 Market Snapshot</span><div class="live-badge" style="font-size:10px;"><div class="live-dot"></div>LIVE</div></div>
          <div class="msnap-list" id="mSnapList"></div>
        </div>
      </div>
      <div class="kyc-notice" id="kycNotice">
        <div style="display:flex;align-items:center;gap:12px;"><span style="font-size:28px;">🔐</span><div><div style="font-weight:700;font-size:14px;margin-bottom:2px;">Complete KYC Verification</div><div style="font-size:12px;color:rgba(255,215,64,.8);">Verify your identity to unlock higher withdrawal limits.</div></div></div>
        <button class="kyc-btn" onclick="showToast('Contact support via AI assistant to begin KYC verification.','blue')">Verify Now →</button>
      </div>
    </main>
  </div>
</div>

<!-- ============================================================ -->
<!-- TRADING LAYER — TradingView Lightweight Charts -->
<!-- ============================================================ -->
<div id="tradingLayer" class="layer">
  <nav class="navbar">
    <div class="nav-logo" onclick="showLayer('dashboardLayer')"><div class="nav-logo-mark">₿</div><div class="nav-logo-text">Crypto<span>Pro</span></div></div>
    <div class="nav-ticker"><div class="nav-ticker-track" id="tradeNavTicker"></div></div>
    <div class="nav-right">
      <div class="live-badge"><div class="live-dot"></div>LIVE</div>
      <button class="btn btn-outline" onclick="showLayer('dashboardLayer')">← Dashboard</button>
    </div>
  </nav>
  <div class="pair-bar"><div class="pair-bar-inner" id="tradePairBar">
    <button class="pair-btn active" onclick="tradingSelectPair('BTC','USDT',this)">BTC/USDT</button>
    <button class="pair-btn" onclick="tradingSelectPair('ETH','USDT',this)">ETH/USDT</button>
    <button class="pair-btn" onclick="tradingSelectPair('BNB','USDT',this)">BNB/USDT</button>
    <button class="pair-btn" onclick="tradingSelectPair('SOL','USDT',this)">SOL/USDT</button>
    <button class="pair-btn" onclick="tradingSelectPair('ADA','USDT',this)">ADA/USDT</button>
    <button class="pair-btn" onclick="tradingSelectPair('XRP','USDT',this)">XRP/USDT</button>
    <button class="pair-btn" onclick="tradingSelectPair('AVAX','USDT',this)">AVAX/USDT</button>
    <button class="pair-btn" onclick="tradingSelectPair('DOT','USDT',this)">DOT/USDT</button>
  </div></div>
  <div class="trade-price-strip">
    <div class="tps-left"><span class="tps-pair" id="tpsPair">BTC/USDT</span><span class="tps-price" id="tpsPrice">Loading…</span><span class="tps-chg up" id="tpsChg">—</span></div>
    <div class="tps-stats">
      <div class="tps-stat"><span class="tps-lbl">High</span><span class="tps-val" id="tpsHigh">—</span></div>
      <div class="tps-stat"><span class="tps-lbl">Low</span><span class="tps-val" id="tpsLow">—</span></div>
      <div class="tps-stat"><span class="tps-lbl">Volume</span><span class="tps-val" id="tpsVol">—</span></div>
      <div class="tps-stat"><span class="tps-lbl">Mode</span><span class="tps-val" id="tradeModeLabel" style="color:var(--yellow)">DEMO</span></div>
    </div>
    <div class="tps-bal"><span class="tps-lbl">Available</span><span class="tps-val text-green" id="tradeAvailBal">$0.00</span></div>
  </div>
  <div class="trading-body">
    <div class="trade-chart-col">
      <div class="indicator-bar">
        <span style="font-size:11px;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:.5px;">Chart:</span>
        <button class="ind-btn active" onclick="toggleTrdMA(this)">MA(20)</button>
        <button class="ind-btn active" onclick="toggleTrdBB(this)">BB</button>
        <button class="ind-btn" onclick="toggleTrdRSI(this)">RSI</button>
        <div style="display:flex;gap:2px;margin-left:8px;">
          <button class="iv-btn active" onclick="setTrdInterval('1m',this)">1m</button>
          <button class="iv-btn" onclick="setTrdInterval('5m',this)">5m</button>
          <button class="iv-btn" onclick="setTrdInterval('15m',this)">15m</button>
          <button class="iv-btn" onclick="setTrdInterval('1h',this)">1H</button>
          <button class="iv-btn" onclick="setTrdInterval('4h',this)">4H</button>
        </div>
        <div style="margin-left:auto;"><button class="ind-btn" style="background:var(--green);color:#000;border-color:var(--green);" onclick="showLayer('depositLayer')">💰 Deposit</button></div>
      </div>
      <div id="tvTradingChart" style="flex:1;min-height:0;height:300px;"></div>
      <div id="trdRsiWrap" style="height:80px;border-top:1px solid var(--border);display:none;position:relative;"><div id="tvTrdRsiContainer" style="height:100%;"></div><div style="position:absolute;top:4px;left:8px;font-size:10px;color:var(--text3);font-family:var(--font-mono);">RSI(14)</div></div>
    </div>
    <div class="order-panel">
      <div class="order-tabs"><button class="ot-btn buy active" id="otBuy" onclick="setOrderSide('buy')">▲ LONG / BUY</button><button class="ot-btn sell" id="otSell" onclick="setOrderSide('sell')">▼ SHORT / SELL</button></div>
      <div class="order-type-row">
        <button class="order-type-btn active" onclick="setOrderType('market',this)">Market</button>
        <button class="order-type-btn" onclick="setOrderType('limit',this)">Limit</button>
        <button class="order-type-btn" onclick="setOrderType('stop',this)">Stop</button>
      </div>
      <div class="op-group" id="limitPriceGroup" style="display:none;"><label class="op-label">Limit Price (USDT)</label><div class="op-input-wrap"><input class="op-input" type="number" id="limitPrice" placeholder="0.00"><span class="op-input-suffix">USDT</span></div></div>
      <div class="op-group">
        <label class="op-label">Amount (USD)</label>
        <div class="op-input-wrap"><input class="op-input" type="number" id="tradeAmt" placeholder="0.00" oninput="calcOrderSummary()" min="1"><span class="op-input-suffix">USD</span></div>
        <div class="quick-pct-row"><button class="qp-btn" onclick="setTradePct(25)">25%</button><button class="qp-btn" onclick="setTradePct(50)">50%</button><button class="qp-btn" onclick="setTradePct(75)">75%</button><button class="qp-btn" onclick="setTradePct(100)">MAX</button></div>
      </div>
      <div class="op-group">
        <label class="op-label">Leverage <span class="op-leverage-val" id="leverageVal">10×</span></label>
        <input class="leverage-slider" type="range" id="leverageSlider" min="1" max="100" value="10" oninput="updateLeverage(this.value)">
        <div class="leverage-marks"><span onclick="updateLeverage(1)">1×</span><span onclick="updateLeverage(5)">5×</span><span onclick="updateLeverage(10)">10×</span><span onclick="updateLeverage(25)">25×</span><span onclick="updateLeverage(50)">50×</span><span onclick="updateLeverage(100)">100×</span></div>
      </div>
      <div class="tp-sl-row">
        <div class="op-group" style="flex:1;"><label class="op-label text-green">Take Profit</label><div class="op-input-wrap"><input class="op-input" type="number" id="takeProfit" placeholder="Optional" oninput="calcOrderSummary()"></div></div>
        <div class="op-group" style="flex:1;"><label class="op-label text-red">Stop Loss</label><div class="op-input-wrap"><input class="op-input" type="number" id="stopLoss" placeholder="Optional" oninput="calcOrderSummary()"></div></div>
      </div>
      <div class="order-summary">
        <div class="os-row"><span>Entry Price</span><span id="osEntry">—</span></div>
        <div class="os-row"><span>Position Size</span><span id="osPosition">—</span></div>
        <div class="os-row"><span>Margin Required</span><span id="osMargin">—</span></div>
        <div class="os-row"><span>Est. Profit (TP)</span><span id="osProfit" class="text-green">—</span></div>
        <div class="os-row"><span>Est. Loss (SL)</span><span id="osLoss" class="text-red">—</span></div>
        <div class="os-row"><span>Liquidation Price</span><span id="osLiq" style="color:var(--yellow)">—</span></div>
      </div>
      <div class="risk-warning" id="riskWarning" style="display:none;">⚠️ <span id="riskMsg">High leverage increases risk.</span></div>
      <button class="order-submit-btn buy" id="orderSubmitBtn" onclick="submitTrade()"><span id="orderSubmitText">▲ BUY / LONG</span></button>
      <div class="op-mode-row"><span style="font-size:11px;color:var(--text3);">Account:</span><button class="op-mode-btn active" id="opDemo" onclick="switchMode('demo');updateTradingPanel()">Demo</button><button class="op-mode-btn" id="opReal" onclick="switchMode('real');updateTradingPanel()">Real</button></div>
    </div>
    <div class="trade-right-col">
      <div class="mini-ob">
        <div class="mob-header">Order Book</div>
        <div class="ob-labels" style="font-size:9px;padding:4px 10px;"><span>Price</span><span style="text-align:center">Amt</span><span style="text-align:right">Total</span></div>
        <div id="miniObAsks" class="ob-asks" style="max-height:100px;"></div>
        <div class="ob-spread"><span id="miniSpreadPrice" class="ob-spread-price" style="font-size:12px;">—</span><span class="ob-spread-pct">Spread</span></div>
        <div id="miniObBids" class="ob-bids" style="max-height:100px;"></div>
      </div>
      <div class="my-positions">
        <div class="mob-header" style="display:flex;justify-content:space-between;align-items:center;">My Positions <span class="dc-badge" id="myPosCount">0</span></div>
        <div id="myPositionsList" style="overflow-y:auto;flex:1;"><div style="padding:16px;text-align:center;font-size:11px;color:var(--text3);">No open positions</div></div>
      </div>
      <div style="flex:1;overflow:hidden;display:flex;flex-direction:column;border-top:1px solid var(--border);">
        <div class="mob-header">Recent Closed</div>
        <div id="miniHistoryList" style="overflow-y:auto;flex:1;"><div style="padding:16px;text-align:center;font-size:11px;color:var(--text3);">No trades yet</div></div>
      </div>
    </div>
  </div>
</div>

<!-- ============================================================ -->
<!-- DEPOSIT LAYER -->
<!-- ============================================================ -->
<div id="depositLayer" class="layer">
  <nav class="navbar">
    <div class="nav-logo" onclick="showLayer('dashboardLayer')"><div class="nav-logo-mark">₿</div><div class="nav-logo-text">Crypto<span>Pro</span></div></div>
    <div class="nav-right"><button class="btn btn-outline" onclick="showLayer('dashboardLayer')">← Dashboard</button></div>
  </nav>
  <div style="max-width:600px;margin:40px auto;padding:0 20px;">
    <div class="dash-card">
      <div class="dc-header"><span class="dc-title">💰 Deposit Funds</span><span class="dc-badge" id="depositAvailBal">$0.00 available</span></div>
      <div style="background:linear-gradient(135deg,rgba(0,230,118,.12),rgba(0,200,83,.04));border:1px solid rgba(0,230,118,.25);border-radius:var(--r-xl);padding:16px;margin-bottom:20px;text-align:center;">
        <div style="font-size:12px;color:rgba(255,255,255,.7);margin-bottom:4px;">🎁 FIRST DEPOSIT BONUS</div>
        <div style="font-size:36px;font-weight:900;font-family:var(--font-mono);color:var(--yellow);">100% MATCH</div>
        <div style="font-size:12px;color:rgba(255,255,255,.6);margin-top:4px;">Deposit $100 → Trade with $200</div>
      </div>
      <div style="margin-bottom:20px;">
        <div class="op-label" style="margin-bottom:10px;">Payment Method</div>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;" id="depMethodGrid">
          <button class="dep-method-btn active" data-method="mpesa" onclick="selectDepMethod(this,'depMethodGrid')"><div style="font-size:24px;margin-bottom:4px;">📱</div><div style="font-size:12px;font-weight:700;">M-Pesa</div><div style="font-size:10px;color:var(--text3);">Instant</div></button>
          <button class="dep-method-btn" data-method="bank" onclick="selectDepMethod(this,'depMethodGrid')"><div style="font-size:24px;margin-bottom:4px;">🏦</div><div style="font-size:12px;font-weight:700;">Bank Transfer</div><div style="font-size:10px;color:var(--text3);">1–2 hrs</div></button>
          <button class="dep-method-btn" data-method="crypto" onclick="selectDepMethod(this,'depMethodGrid')"><div style="font-size:24px;margin-bottom:4px;">₿</div><div style="font-size:12px;font-weight:700;">Crypto</div><div style="font-size:10px;color:var(--text3);">BTC/ETH/USDT</div></button>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Amount (USD)</label>
        <div class="input-wrap"><span class="input-icon">💵</span><input class="form-input" type="number" id="depositAmt" placeholder="Minimum $10" min="10" oninput="calcDepBonus()"></div>
        <div style="display:flex;gap:6px;margin-top:8px;">
          <button class="qp-btn" onclick="document.getElementById('depositAmt').value=50;calcDepBonus()">$50</button>
          <button class="qp-btn" onclick="document.getElementById('depositAmt').value=100;calcDepBonus()">$100</button>
          <button class="qp-btn" onclick="document.getElementById('depositAmt').value=250;calcDepBonus()">$250</button>
          <button class="qp-btn" onclick="document.getElementById('depositAmt').value=500;calcDepBonus()">$500</button>
          <button class="qp-btn" onclick="document.getElementById('depositAmt').value=1000;calcDepBonus()">$1,000</button>
        </div>
      </div>
      <div id="depBonusLine" style="display:none;background:var(--green3);border:1px solid rgba(0,230,118,.25);border-radius:var(--r-md);padding:10px 14px;margin-bottom:16px;font-size:13px;justify-content:space-between;align-items:center;"><span>🎁 100% Welcome Bonus</span><span class="mono fw-bold text-green" id="depBonusAmt">+$0.00</span></div>
      <div id="mpesaPhoneGroup" class="form-group">
        <label class="form-label">M-Pesa Phone Number</label>
        <div class="input-wrap"><span class="input-icon">📱</span><input class="form-input" type="tel" id="depPhone" placeholder="e.g. 0712345678"></div>
      </div>
      <div id="depDetails" style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--r-lg);padding:16px;margin-bottom:16px;font-size:13px;color:var(--text2);line-height:1.9;">
        📱 <strong style="color:var(--text1)">M-Pesa Till Number:</strong> <strong style="color:var(--green);font-family:var(--font-mono)">7500474</strong><br>
        Business Name: <strong style="color:var(--text1)">CryptoPro Trading</strong><br>
        <span style="font-size:11px;color:var(--text3);">Or enter phone below to receive an STK Push prompt</span>
      </div>
      <div id="depStatusBox" style="display:none;padding:14px;border-radius:var(--r-md);margin-bottom:14px;font-size:13px;text-align:center;"></div>
      <button class="btn-auth" id="depositBtn" onclick="submitDeposit()">💰 Deposit Now</button>
    </div>
  </div>
</div>

<!-- ============================================================ -->
<!-- WITHDRAW LAYER -->
<!-- ============================================================ -->
<div id="withdrawLayer" class="layer">
  <nav class="navbar">
    <div class="nav-logo" onclick="showLayer('dashboardLayer')"><div class="nav-logo-mark">₿</div><div class="nav-logo-text">Crypto<span>Pro</span></div></div>
    <div class="nav-right"><button class="btn btn-outline" onclick="showLayer('dashboardLayer')">← Dashboard</button></div>
  </nav>
  <div style="max-width:600px;margin:40px auto;padding:0 20px;">
    <div class="dash-card">
      <div class="dc-header"><span class="dc-title">💸 Withdraw Funds</span><span class="dc-badge" id="withdrawAvailBal">$0.00 available</span></div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px;">
        <div style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--r-lg);padding:14px;text-align:center;"><div style="font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px;">Min Withdraw</div><div class="mono fw-bold text-green">$50.00</div></div>
        <div style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--r-lg);padding:14px;text-align:center;"><div style="font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px;">Fee</div><div class="mono fw-bold">2%</div></div>
        <div style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--r-lg);padding:14px;text-align:center;"><div style="font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px;">Processing</div><div class="mono fw-bold text-blue">5–30 min</div></div>
      </div>
      <div style="margin-bottom:20px;">
        <div class="op-label" style="margin-bottom:10px;">Withdrawal Method</div>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;" id="wdMethodGrid">
          <button class="dep-method-btn active" data-method="mpesa" onclick="selectDepMethod(this,'wdMethodGrid')"><div style="font-size:24px;margin-bottom:4px;">📱</div><div style="font-size:12px;font-weight:700;">M-Pesa</div><div style="font-size:10px;color:var(--text3);">5–15 min</div></button>
          <button class="dep-method-btn" data-method="bank" onclick="selectDepMethod(this,'wdMethodGrid')"><div style="font-size:24px;margin-bottom:4px;">🏦</div><div style="font-size:12px;font-weight:700;">Bank</div><div style="font-size:10px;color:var(--text3);">1–2 hrs</div></button>
          <button class="dep-method-btn" data-method="crypto" onclick="selectDepMethod(this,'wdMethodGrid')"><div style="font-size:24px;margin-bottom:4px;">₿</div><div style="font-size:12px;font-weight:700;">Crypto</div><div style="font-size:10px;color:var(--text3);">10–30 min</div></button>
        </div>
      </div>
      <div class="form-group"><label class="form-label">Amount (USD)</label><div class="input-wrap"><span class="input-icon">💵</span><input class="form-input" type="number" id="withdrawAmt" placeholder="Minimum $50" min="50" oninput="calcWithdrawFee()"></div></div>
      <div id="withdrawFeeBox" style="display:none;background:var(--bg2);border:1px solid var(--border);border-radius:var(--r-md);padding:12px;margin-bottom:16px;font-size:12px;">
        <div style="display:flex;justify-content:space-between;padding:3px 0;"><span style="color:var(--text3)">Requested</span><span id="wfAmt" class="mono">—</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;"><span style="color:var(--text3)">Fee (2%)</span><span id="wfFee" class="mono text-red">—</span></div>
        <div style="display:flex;justify-content:space-between;padding:6px 0;border-top:1px solid var(--border);margin-top:4px;font-weight:700;"><span>You Receive</span><span id="wfNet" class="mono text-green">—</span></div>
      </div>
      <div class="form-group"><label class="form-label">Account / Phone Number</label><div class="input-wrap"><span class="input-icon">📱</span><input class="form-input" type="text" id="withdrawAccount" placeholder="M-Pesa number / bank account / crypto address"></div></div>
      <button class="btn-auth" id="withdrawBtn" onclick="submitWithdraw()">💸 Withdraw Now</button>
    </div>
  </div>
</div>

<!-- ============================================================ -->
<!-- BOTS LAYER -->
<!-- ============================================================ -->
<div id="botsLayer" class="layer">
  <nav class="navbar">
    <div class="nav-logo" onclick="showLayer('dashboardLayer')"><div class="nav-logo-mark">₿</div><div class="nav-logo-text">Crypto<span>Pro</span></div></div>
    <div class="nav-right"><div class="live-badge"><div class="live-dot"></div>LIVE</div><button class="btn btn-outline" onclick="showLayer('dashboardLayer')">← Dashboard</button></div>
  </nav>
  <div style="padding:24px;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;flex-wrap:wrap;gap:12px;">
      <div><h2 style="font-family:var(--font-display);font-size:24px;font-weight:800;margin-bottom:4px;">🤖 AI Trading Bots</h2><p style="color:var(--text2);font-size:13px;">Set-and-forget automation. Trade 24/7 while you sleep.</p></div>
      <div style="display:flex;gap:12px;">
        <div style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--r-lg);padding:12px 20px;text-align:center;"><div class="mono fw-bold text-green" style="font-size:20px;" id="botsActiveCount">0</div><div style="font-size:11px;color:var(--text3);">Active Bots</div></div>
        <div style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--r-lg);padding:12px 20px;text-align:center;"><div class="mono fw-bold text-yellow" style="font-size:20px;">91%</div><div style="font-size:11px;color:var(--text3);">Best Win Rate</div></div>
      </div>
    </div>
    <div class="bots-grid" id="botsGrid"></div>
  </div>
</div>

<!-- ============================================================ -->
<!-- HISTORY LAYER -->
<!-- ============================================================ -->
<div id="historyLayer" class="layer">
  <nav class="navbar">
    <div class="nav-logo" onclick="showLayer('dashboardLayer')"><div class="nav-logo-mark">₿</div><div class="nav-logo-text">Crypto<span>Pro</span></div></div>
    <div class="nav-right"><button class="btn btn-outline" onclick="showLayer('dashboardLayer')">← Dashboard</button></div>
  </nav>
  <div style="padding:24px;">
    <h2 style="font-family:var(--font-display);font-size:22px;font-weight:800;margin-bottom:20px;">📜 Trade History</h2>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:24px;max-width:500px;">
      <div class="bal-card" style="padding:16px;text-align:center;"><div class="bc-label">Total P&L</div><div class="bc-amount" id="histTotalPnl" style="font-size:20px;">$0.00</div></div>
      <div class="bal-card" style="padding:16px;text-align:center;"><div class="bc-label">Win Rate</div><div class="bc-amount text-blue" id="histWinRate" style="font-size:20px;">—</div></div>
      <div class="bal-card" style="padding:16px;text-align:center;"><div class="bc-label">Total Trades</div><div class="bc-amount" id="histTotalTrades" style="font-size:20px;">0</div></div>
    </div>
    <div class="dash-card" style="overflow-x:auto;">
      <table style="width:100%;border-collapse:collapse;font-size:13px;">
        <thead><tr style="border-bottom:1px solid var(--border);">
          <th style="padding:8px 12px;text-align:left;color:var(--text3);font-size:10px;text-transform:uppercase;letter-spacing:.5px;">Result</th>
          <th style="padding:8px 12px;text-align:left;color:var(--text3);font-size:10px;text-transform:uppercase;letter-spacing:.5px;">Pair</th>
          <th style="padding:8px 12px;text-align:left;color:var(--text3);font-size:10px;text-transform:uppercase;letter-spacing:.5px;">Type</th>
          <th style="padding:8px 12px;text-align:left;color:var(--text3);font-size:10px;text-transform:uppercase;letter-spacing:.5px;">Amount</th>
          <th style="padding:8px 12px;text-align:left;color:var(--text3);font-size:10px;text-transform:uppercase;letter-spacing:.5px;">Leverage</th>
          <th style="padding:8px 12px;text-align:left;color:var(--text3);font-size:10px;text-transform:uppercase;letter-spacing:.5px;">P&L</th>
          <th style="padding:8px 12px;text-align:left;color:var(--text3);font-size:10px;text-transform:uppercase;letter-spacing:.5px;">Date</th>
        </tr></thead>
        <tbody id="historyTbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ============================================================ -->
<!-- REFERRAL LAYER -->
<!-- ============================================================ -->
<div id="referralLayer" class="layer">
  <nav class="navbar">
    <div class="nav-logo" onclick="showLayer('dashboardLayer')"><div class="nav-logo-mark">₿</div><div class="nav-logo-text">Crypto<span>Pro</span></div></div>
    <div class="nav-right"><button class="btn btn-outline" onclick="showLayer('dashboardLayer')">← Dashboard</button></div>
  </nav>
  <div style="max-width:800px;margin:0 auto;padding:24px;">
    <h2 style="font-family:var(--font-display);font-size:22px;font-weight:800;margin-bottom:6px;">🎁 Referral Program</h2>
    <p style="color:var(--text2);margin-bottom:24px;">Earn <strong style="color:var(--green)">10% lifetime commission</strong> on every deposit your referrals make.</p>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:24px;">
      <div class="bal-card primary" style="padding:18px;text-align:center;"><div class="bc-label">Total Earned</div><div class="bc-amount text-green" id="refTotalEarned" style="font-size:22px;">$0.00</div></div>
      <div class="bal-card" style="padding:18px;text-align:center;"><div class="bc-label">Referrals</div><div class="bc-amount text-blue" id="refTotalCount" style="font-size:22px;">0</div></div>
      <div class="bal-card" style="padding:18px;text-align:center;"><div class="bc-label">Commission Rate</div><div class="bc-amount text-yellow" style="font-size:22px;">10%</div></div>
    </div>
    <div class="dash-card" style="margin-bottom:16px;">
      <div class="dc-header"><span class="dc-title">Your Referral Link</span></div>
      <div style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--r-md);padding:12px 14px;font-family:var(--font-mono);font-size:12px;color:var(--green);word-break:break-all;margin-bottom:12px;" id="refLinkDisplay">Loading…</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button class="btn btn-green" onclick="copyRefLink()">📋 Copy Link</button>
        <button class="btn btn-outline" onclick="shareRef('whatsapp')" style="color:#25D366;border-color:#25D36640;">💬 WhatsApp</button>
        <button class="btn btn-outline" onclick="shareRef('telegram')" style="color:#2CA5E0;border-color:#2CA5E040;">✈️ Telegram</button>
        <button class="btn btn-outline" onclick="shareRef('twitter')" style="color:#1DA1F2;border-color:#1DA1F240;">🐦 Twitter</button>
      </div>
    </div>
    <div class="dash-card" style="margin-bottom:16px;">
      <div class="dc-header"><span class="dc-title">How It Works</span></div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;text-align:center;">
        <div style="padding:16px;background:var(--bg2);border-radius:var(--r-lg);"><div style="font-size:28px;margin-bottom:8px;">🔗</div><div style="font-weight:700;font-size:13px;margin-bottom:4px;">Share Your Link</div><div style="font-size:11px;color:var(--text2);">Send your unique referral link to friends</div></div>
        <div style="padding:16px;background:var(--bg2);border-radius:var(--r-lg);"><div style="font-size:28px;margin-bottom:8px;">👤</div><div style="font-weight:700;font-size:13px;margin-bottom:4px;">They Sign Up</div><div style="font-size:11px;color:var(--text2);">Friend gets $25 bonus, you earn $5</div></div>
        <div style="padding:16px;background:var(--bg2);border-radius:var(--r-lg);"><div style="font-size:28px;margin-bottom:8px;">💰</div><div style="font-weight:700;font-size:13px;margin-bottom:4px;">Earn Forever</div><div style="font-size:11px;color:var(--text2);">10% of every deposit they ever make</div></div>
      </div>
    </div>
    <div class="dash-card"><div class="dc-header"><span class="dc-title">Referral History</span></div><div id="refHistoryList"><div class="empty-state"><div style="font-size:40px;margin-bottom:8px;">👥</div><div style="color:var(--text2);font-weight:600;">No referrals yet</div></div></div></div>
  </div>
</div>

<!-- ============================================================ -->
<!-- PROFILE LAYER -->
<!-- ============================================================ -->
<div id="profileLayer" class="layer">
  <nav class="navbar">
    <div class="nav-logo" onclick="showLayer('dashboardLayer')"><div class="nav-logo-mark">₿</div><div class="nav-logo-text">Crypto<span>Pro</span></div></div>
    <div class="nav-right"><button class="btn btn-outline" onclick="showLayer('dashboardLayer')">← Dashboard</button></div>
  </nav>
  <div style="max-width:600px;margin:40px auto;padding:0 20px;display:flex;flex-direction:column;gap:16px;">
    <div class="dash-card">
      <div class="dc-header"><span class="dc-title">⚙️ Profile Settings</span></div>
      <div style="text-align:center;padding:20px 0;border-bottom:1px solid var(--border);margin-bottom:20px;">
        <div style="width:72px;height:72px;border-radius:50%;background:linear-gradient(135deg,var(--green),var(--blue));display:flex;align-items:center;justify-content:center;font-size:32px;margin:0 auto 12px;">👤</div>
        <div style="font-family:var(--font-display);font-size:18px;font-weight:800;" id="profDisplayName">—</div>
        <div style="font-size:12px;color:var(--text3);margin-top:2px;">Member since: <span id="profJoined">—</span></div>
        <div style="margin-top:10px;display:inline-flex;align-items:center;gap:6px;background:var(--green3);border:1px solid rgba(0,230,118,.2);border-radius:20px;padding:4px 14px;font-size:11px;font-weight:700;color:var(--green);">✅ ACTIVE ACCOUNT</div>
      </div>
      <div class="form-group"><label class="form-label">Full Name</label><div class="input-wrap"><span class="input-icon">👤</span><input class="form-input" type="text" id="profName" placeholder="Your full name"></div></div>
      <div class="form-group"><label class="form-label">Email Address</label><div class="input-wrap"><span class="input-icon">✉️</span><input class="form-input" type="email" id="profEmail" placeholder="you@email.com"></div></div>
      <div class="form-group"><label class="form-label">Phone Number</label><div class="input-wrap"><span class="input-icon">📱</span><input class="form-input" type="tel" id="profPhone" placeholder="+254 712 345 678"></div></div>
      <button class="btn-auth" onclick="saveProfile()">💾 Save Changes</button>
    </div>
    <div class="dash-card">
      <div class="dc-header"><span class="dc-title">🔐 Security</span></div>
      <div style="display:flex;flex-direction:column;gap:10px;">
        <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--bg2);border-radius:var(--r-md);"><div><div style="font-weight:600;font-size:13px;">Two-Factor Auth (2FA)</div><div style="font-size:11px;color:var(--text3);">Adds extra security to your account</div></div><div style="color:var(--green);font-size:12px;font-weight:700;">✅ ENABLED</div></div>
        <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--bg2);border-radius:var(--r-md);"><div><div style="font-weight:600;font-size:13px;">Change Password</div><div style="font-size:11px;color:var(--text3);">Last changed: Never</div></div><button class="btn btn-outline" style="font-size:12px;" onclick="showToast('Password reset link sent to your email','blue')">Reset</button></div>
        <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--bg2);border-radius:var(--r-md);"><div><div style="font-weight:600;font-size:13px;">Referral Code</div><div style="font-size:11px;font-family:var(--font-mono);color:var(--green);margin-top:2px;" id="profRefCode">—</div></div><button class="btn btn-outline" style="font-size:12px;" onclick="copyRefLink()">📋 Copy</button></div>
        <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--bg2);border-radius:var(--r-md);"><div><div style="font-weight:600;font-size:13px;">KYC Verification</div><div style="font-size:11px;color:var(--text3);">Required for withdrawals over $1,000</div></div><button class="btn btn-outline" style="font-size:12px;color:var(--yellow);border-color:rgba(255,215,64,.3);" onclick="showToast('Contact support via AI assistant to begin KYC','blue')">Verify</button></div>
      </div>
    </div>
    <div class="dash-card"><div class="dc-header"><span class="dc-title" style="color:var(--red);">🔴 Account</span></div><button class="btn btn-outline" style="width:100%;color:var(--red);border-color:rgba(255,61,87,.3);" onclick="if(confirm('Log out?'))handleLogout()">🚪 Logout</button></div>
  </div>
</div>

<!-- SIGNALS LAYER -->
<div id="signalsLayer" class="layer">
  <nav class="navbar">
    <div class="nav-logo" onclick="showLayer('dashboardLayer')"><div class="nav-logo-mark">₿</div><div class="nav-logo-text">Crypto<span>Pro</span></div></div>
    <div class="nav-ticker"><div class="nav-ticker-track" id="sigNavTicker"></div></div>
    <div class="nav-right"><div class="live-badge"><div class="live-dot"></div>LIVE</div><button class="btn btn-outline" onclick="showLayer('dashboardLayer')">← Dashboard</button></div>
  </nav>
  <div style="padding:24px;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;flex-wrap:wrap;gap:12px;">
      <div><h2 style="font-family:var(--font-display);font-size:24px;font-weight:800;margin-bottom:4px;">📡 AI Trade Signals</h2><p style="color:var(--text2);font-size:13px;">AI-generated entry points. Updated every 60 seconds.</p></div>
      <div style="display:flex;gap:10px;">
        <div style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--r-lg);padding:12px 20px;text-align:center;"><div style="font-family:var(--font-mono);font-size:20px;font-weight:700;color:var(--green);" id="sigBuyCount">0</div><div style="font-size:11px;color:var(--text3);">BUY</div></div>
        <div style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--r-lg);padding:12px 20px;text-align:center;"><div style="font-family:var(--font-mono);font-size:20px;font-weight:700;color:var(--red);" id="sigSellCount">0</div><div style="font-size:11px;color:var(--text3);">SELL</div></div>
        <div style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--r-lg);padding:12px 20px;text-align:center;"><div style="font-family:var(--font-mono);font-size:20px;font-weight:700;color:var(--yellow);" id="sigWinRate">—</div><div style="font-size:11px;color:var(--text3);">Accuracy</div></div>
      </div>
    </div>
    <div style="display:flex;gap:6px;margin-bottom:20px;flex-wrap:wrap;">
      <button class="dc-tab active" onclick="filterSignals('all',this)">All</button>
      <button class="dc-tab" onclick="filterSignals('buy',this)">▲ Buy</button>
      <button class="dc-tab" onclick="filterSignals('sell',this)">▼ Sell</button>
      <button class="dc-tab" onclick="filterSignals('strong',this)">🔥 Strong</button>
      <div style="margin-left:auto;display:flex;align-items:center;gap:6px;font-size:11px;color:var(--text3);"><div class="live-dot"></div>Refreshes in <span id="sigRefreshTimer">60</span>s</div>
    </div>
    <div id="signalsGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px;"></div>
  </div>
</div>

<!-- ANALYSIS LAYER -->
<div id="analysisLayer" class="layer">
  <nav class="navbar">
    <div class="nav-logo" onclick="showLayer('dashboardLayer')"><div class="nav-logo-mark">₿</div><div class="nav-logo-text">Crypto<span>Pro</span></div></div>
    <div class="nav-right"><button class="btn btn-outline" onclick="showLayer('dashboardLayer')">← Dashboard</button></div>
  </nav>
  <div style="padding:24px;max-width:1200px;margin:0 auto;">
    <h2 style="font-family:var(--font-display);font-size:24px;font-weight:800;margin-bottom:6px;">🧠 Market Analysis</h2>
    <p style="color:var(--text2);font-size:13px;margin-bottom:24px;">AI-powered market intelligence.</p>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:20px;">
      <div class="dash-card" style="text-align:center;">
        <div class="dc-header"><span class="dc-title">😨 Fear &amp; Greed</span></div>
        <div style="position:relative;width:180px;height:90px;margin:0 auto 12px;overflow:hidden;"><canvas id="fearGaugeCanvas" style="position:absolute;inset:0;width:100%;height:100%;"></canvas><div style="position:absolute;bottom:0;left:50%;transform:translateX(-50%);text-align:center;"><div style="font-family:var(--font-mono);font-size:30px;font-weight:900;" id="fearValue">72</div><div style="font-size:11px;font-weight:700;color:var(--yellow);text-transform:uppercase;" id="fearLabel">Greed</div></div></div>
        <div style="font-size:11px;color:var(--text3);">Yesterday: 68 &nbsp;|&nbsp; Last Week: 55</div>
      </div>
      <div class="dash-card">
        <div class="dc-header"><span class="dc-title">₿ BTC Dominance</span></div>
        <div style="position:relative;width:140px;height:140px;margin:0 auto 12px;"><canvas id="dominanceCanvas" style="position:absolute;inset:0;width:100%;height:100%;"></canvas><div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;"><div style="font-family:var(--font-mono);font-size:22px;font-weight:800;color:var(--yellow);" id="btcDomValue">54.2%</div><div style="font-size:10px;color:var(--text3);">BTC Dom.</div></div></div>
        <div style="display:flex;flex-direction:column;gap:5px;" id="dominanceLegend"></div>
      </div>
      <div class="dash-card">
        <div class="dc-header"><span class="dc-title">📊 Trend Summary</span></div>
        <div id="trendSummary" style="display:flex;flex-direction:column;gap:8px;"></div>
      </div>
    </div>
    <div class="dash-card" style="margin-bottom:16px;">
      <div class="dc-header"><span class="dc-title">🌡️ Market Heatmap (24h)</span></div>
      <div id="marketHeatmap" style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px;"></div>
    </div>
    <div class="dash-card">
      <div class="dc-header"><span class="dc-title">📰 AI News Sentiment</span><span class="dc-badge" id="newsCount">0 headlines</span></div>
      <div id="newsFeed" style="display:flex;flex-direction:column;"></div>
    </div>
  </div>
</div>

<!-- RECOMMENDATIONS LAYER -->
<div id="recommendLayer" class="layer">
  <nav class="navbar">
    <div class="nav-logo" onclick="showLayer('dashboardLayer')"><div class="nav-logo-mark">₿</div><div class="nav-logo-text">Crypto<span>Pro</span></div></div>
    <div class="nav-right"><button class="btn btn-outline" onclick="showLayer('dashboardLayer')">← Dashboard</button></div>
  </nav>
  <div style="padding:24px;max-width:900px;margin:0 auto;">
    <div style="display:flex;align-items:center;gap:16px;margin-bottom:24px;">
      <div style="width:56px;height:56px;background:linear-gradient(135deg,var(--blue),#2962FF);border-radius:var(--r-lg);display:flex;align-items:center;justify-content:center;font-size:26px;flex-shrink:0;">🤖</div>
      <div><h2 style="font-family:var(--font-display);font-size:24px;font-weight:800;margin-bottom:4px;">Personalized Recommendations</h2><p style="color:var(--text2);font-size:13px;">AI-tailored for your profile.</p></div>
    </div>
    <div class="dash-card" style="margin-bottom:16px;">
      <div class="dc-header"><span class="dc-title">⚖️ Your Risk Profile</span><span class="dc-badge" id="riskProfileBadge">Calculating…</span></div>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px;" id="riskProfileGrid"></div>
      <div style="height:8px;background:var(--bg3);border-radius:4px;overflow:hidden;margin-bottom:8px;"><div id="riskFillBar" style="height:100%;border-radius:4px;transition:width .8s ease;background:linear-gradient(90deg,var(--green),var(--yellow),var(--red));width:0%;"></div></div>
      <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text3);"><span>Conservative</span><span>Moderate</span><span>Aggressive</span></div>
    </div>
    <div id="actionRecs" style="display:flex;flex-direction:column;gap:12px;margin-bottom:16px;"></div>
    <div class="dash-card" style="margin-bottom:16px;">
      <div class="dc-header"><span class="dc-title">🤖 Suggested Bots</span></div>
      <div id="suggestedBots" style="display:flex;flex-direction:column;gap:10px;"></div>
    </div>
    <div class="dash-card">
      <div class="dc-header"><span class="dc-title">🎓 Learning Path</span><span class="dc-badge" id="learnProgress">0% complete</span></div>
      <div id="learningPath" style="display:flex;flex-direction:column;"></div>
    </div>
  </div>
</div>

<!-- ============================================================ -->
<!-- JAVASCRIPT -->
<!-- ============================================================ -->
<script>
// ============================================================
// PAYMENT CONFIG — Obfuscated
// ============================================================
function _cfg(){
  const _a = atob('ZmVsaXhrb3NrZXkyNzhAZ21haWwuY29t');
  const _b = atob('MjU0NzU5NDAxODkz');
  const _c = atob('NzUwMDQ3NA==');
  const _d = atob('Q3J5cHRvUHJvIFRyYWRpbmc=');
  const _e = atob('c2VydmljZV9wNjF0cmhx');
  const _f = atob('dGVtcGxhdGVfMTRqd2Jqdg==');
  const _g = atob('d2JsM1hwSWpBbV84N2M0Tmw=');
  const _h = atob('MDMxMDE4NDkxMjQyOQ==');
  const _i = atob('RXF1aXR5IEJhbms=');
  const _j = atob('Q3J5cHRvUHJvIFRyYWRpbmcgUGxhdGZvcm0=');
  const _k = atob('MTREWXJHSEY0NlZLd3doS3dxNjZCMzFWb1VVTmZxWVo=');
  const _l = atob('MHhkNGEyZmQyYjA1M2NiZThkOWM3Y2MyNzE1MTczYzYxNTA2ZjQ4MzNk');
  const _m = atob('VEs0clV6NlRVRWQ3ekNXZXVpWDVSNDdwU05kUHN3Sm5BYw==');
  return { ADMIN_EMAIL:_a, ADMIN_WA:_b, MPESA_TILL:_c, MPESA_NAME:_d,
    EJS_SVC:_e, EJS_TPL:_f, EJS_KEY:_g,
    BANK_ACC:_h, BANK_NAME:_i, BANK_HOLDER:_j,
    BTC_ADDR:_k, ETH_ADDR:_l, USDT_ADDR:_m };
}
const _C = _cfg();

const PAYMENT_CONFIG = {
  MPESA:{ TILL_NUMBER:_C.MPESA_TILL, BUSINESS_NAME:_C.MPESA_NAME, PHONE:_C.ADMIN_WA },
  BANK:{ Name:_C.BANK_NAME, ACCOUNT:_C.BANK_ACC, ACCOUNT_NAME:_C.BANK_HOLDER },
  CRYPTO:{ BTC:_C.BTC_ADDR, ETH:_C.ETH_ADDR, 'USDT-TRC20':_C.USDT_ADDR },
  EMAILJS:{ SERVICE_ID:_C.EJS_SVC, TEMPLATE_ID:_C.EJS_TPL, PUBLIC_KEY:_C.EJS_KEY }
};

try{ emailjs.init(_C.EJS_KEY); }catch(e){}
// ============================================================
// GLOBAL STATE
// ============================================================
let currentUser = null, currentLayer = 'welcomeLayer', aiOpen = false;
let dashMode = 'demo', perfPeriod = '7d', signalFilter = 'all';
let allSignals = [], sigRefreshInterval = null, sigCountdown = 60;
let pendingTradeData = null;
let notifications = [];

// Live price state
const PAIR_PRICES = {BTC:98450,ETH:3456,BNB:542,SOL:189,ADA:0.612,XRP:0.784,AVAX:38.6,DOT:8.34};
const PAIR_CHANGE = {BTC:2.45,ETH:1.23,BNB:-0.45,SOL:5.67,ADA:3.21,XRP:-1.12,AVAX:4.15,DOT:2.88};

const COINS = [
  {sym:'BTC/USDT',price:98450,chg:+2.45},{sym:'ETH/USDT',price:3456,chg:+1.23},
  {sym:'BNB/USDT',price:542,chg:-0.45},{sym:'SOL/USDT',price:189,chg:+5.67},
  {sym:'ADA/USDT',price:0.612,chg:+3.21},{sym:'XRP/USDT',price:0.784,chg:-1.12},
  {sym:'DOT/USDT',price:8.34,chg:+2.88},{sym:'AVAX/USDT',price:38.6,chg:+4.15},
  {sym:'MATIC/USDT',price:0.923,chg:-0.78},{sym:'LINK/USDT',price:14.72,chg:+1.56},
];

const FIRST_NAMES=['James','Sarah','Michael','Emma','David','Lisa','Robert','Jennifer','William','Grace','Peter','Lucy','Daniel','Hannah','Samuel','Amina','Kevin','Aisha','Patrick','Fatima','Brian','Zoe','Eric','Chloe','Felix','Naomi','Victor','Diana','Oscar','Nina','George','Stella','Henry','Ivy','Charles','Jade','Arthur','Lena','Marcus','Vera','Jerome','Clara','Moses','Lydia'];
const LAST_NAMES=['Kimani','Ochieng','Wanjiku','Mwangi','Otieno','Njoroge','Kamau','Akinyi','Owino','Chebet','Mutua','Wambua','Karanja','Njenga','Gitau','Thompson','Johnson','Williams','Brown','Jones','Garcia','Martinez','Davis','Wilson','Anderson'];
const COUNTRIES=[{flag:'🇰🇪',loc:'Nairobi, Kenya'},{flag:'🇰🇪',loc:'Mombasa, Kenya'},{flag:'🇳🇬',loc:'Lagos, Nigeria'},{flag:'🇿🇦',loc:'Johannesburg, SA'},{flag:'🇬🇧',loc:'London, UK'},{flag:'🇺🇸',loc:'New York, USA'},{flag:'🇦🇪',loc:'Dubai, UAE'},{flag:'🇦🇺',loc:'Sydney, Australia'}];
const TRADE_TYPES=['BTC','ETH','SOL','BNB','XRP','ADA','AVAX','DOT'];
const TRADER_EMOJIS=['💎','🚀','⭐','🔥','✨','💫','⚡','🌟','👑','🎯'];
const SIG_INDICATORS=['RSI','MACD','EMA','BB','Stoch','ADX','OBV','ATR'];
const SIG_PAIRS=['BTC','ETH','SOL','BNB','ADA','XRP','AVAX','DOT','MATIC','LINK'];

// TradingView chart instances
let tvMainChart = null, tvMainSeries = null, tvMainMA = null, tvMainBBU = null, tvMainBBL = null;
let tvTradingChart = null, tvTradingSeries = null, tvTrdMA = null, tvTrdBBU = null, tvTrdBBL = null;
let tvMainVolChart = null, tvMainVolSeries = null;
let tvRsiChart = null, tvRsiSeries = null, tvTrdRsiChart = null, tvTrdRsiSeries = null;
let currentChartPair = 'BTC', currentChartInterval = '1m';
let currentTradePair = 'BTC', currentTrdInterval = '1m';
let orderSide = 'buy', orderType = 'market';
let obInterval = null, tradeInterval = null, priceInterval = null;
let trdObInterval = null, trdPriceInterval = null, trdChartInterval_ = null;
let tradeFeedBuf = [];
let showMAChart = true, showBBChart = true, showVolChart = false, showRSIChart = false;
let showTrdMA = true, showTrdBB = true, showTrdRSI = false;
let botsState = {};

// ============================================================
// localStorage PERSISTENCE
// ============================================================
function saveState(){
  if(!currentUser) return;
  try{
    localStorage.setItem('cpUser', JSON.stringify(currentUser));
    localStorage.setItem('cpBots', JSON.stringify(botsState));
    localStorage.setItem('cpMode', dashMode);
  }catch(e){}
}
function loadState(){
  try{
    const u=localStorage.getItem('cpUser');
    if(u){ currentUser=JSON.parse(u); }
    const b=localStorage.getItem('cpBots');
    if(b){ botsState=JSON.parse(b); }
    const m=localStorage.getItem('cpMode');
    if(m){ dashMode=m; }
  }catch(e){}
}

// ============================================================
// LAYER NAVIGATION
// ============================================================
function showLayer(id){
  document.querySelectorAll('.layer').forEach(l=>l.classList.remove('active'));
  const el=document.getElementById(id);
  if(el){el.classList.add('active');currentLayer=id;}
  window.scrollTo(0,0);
  if(id==='chartsLayer')    setTimeout(()=>initChartsLayer(),80);
  if(id==='dashboardLayer') { loadState(); initDashboard(); }
  if(id==='tradingLayer')   initTradingLayer();
  if(id==='depositLayer')   initDepositLayer();
  if(id==='withdrawLayer')  initWithdrawLayer();
  if(id==='botsLayer')      buildBots();
  if(id==='historyLayer')   buildHistory();
  if(id==='referralLayer')  buildReferral();
  if(id==='profileLayer')   buildProfile();
  if(id==='signalsLayer')   { buildSignalsLayer(); startSigCountdown(); }
  if(id==='analysisLayer')  buildAnalysisLayer();
  if(id==='recommendLayer') buildRecommendLayer();
}

// ============================================================
// TOAST
// ============================================================
function showToast(msg,type='green',dur=4500){
  const t=document.getElementById('toast');
  t.textContent=msg; t.className=`toast-${type} show`;
  clearTimeout(t._t); t._t=setTimeout(()=>t.classList.remove('show'),dur);
}

// ============================================================
// NOTIFICATIONS
// ============================================================
function addNotification(icon,text,bg){
  notifications.unshift({icon,text,bg,time:new Date()});
  if(notifications.length>20)notifications.pop();
  const cnt=document.getElementById('notifCount');
  if(cnt)cnt.textContent=Math.min(notifications.length,9);
  renderNotifications();
}
function renderNotifications(){
  const list=document.getElementById('notifList');
  if(!list)return;
  if(!notifications.length){list.innerHTML='<div style="padding:20px;text-align:center;font-size:12px;color:var(--text3);">No notifications</div>';return;}
  list.innerHTML=notifications.slice(0,8).map(n=>{
    const ago=Math.floor((Date.now()-n.time)/1000);
    const t=ago<60?ago+'s ago':ago<3600?Math.floor(ago/60)+'m ago':'now';
    return `<div class="notif-item"><div class="notif-icon" style="background:${n.bg||'var(--bg3)'};">${n.icon}</div><div><div class="notif-text">${n.text}</div><div class="notif-time">${t}</div></div></div>`;
  }).join('');
}
function toggleNotifications(){
  const d=document.getElementById('notifDropdown');
  d.classList.toggle('open');
  renderNotifications();
  const cnt=document.getElementById('notifCount');
  if(cnt)cnt.textContent='0';
}
function clearNotifications(){notifications=[];renderNotifications();}
document.addEventListener('click',e=>{
  const bell=document.getElementById('notifBell'),drop=document.getElementById('notifDropdown');
  if(bell&&drop&&!bell.contains(e.target)&&!drop.contains(e.target))drop.classList.remove('open');
});

// ============================================================
// REFERRAL BANNER
// ============================================================
function checkReferral(){
  const p=new URLSearchParams(window.location.search);
  const ref=p.get('ref'),name=p.get('name');
  if(ref){
    const inp=document.getElementById('signupReferralCode');if(inp)inp.value=ref;
    if(name){document.getElementById('refName').textContent=decodeURIComponent(name);document.getElementById('refBanner').classList.add('show');}
  }
}
function closeRefBanner(){document.getElementById('refBanner').classList.remove('show');}

// ============================================================
// FORMAT
// ============================================================
function fmtPrice(p){
  if(p>=1000)return '$'+p.toFixed(2);
  if(p>=1)return '$'+p.toFixed(3);
  return '$'+p.toFixed(4);
}
function fmtPriceShort(p){
  if(p>=1000)return '$'+p.toFixed(2);
  if(p>=1)return '$'+p.toFixed(3);
  return '$'+p.toFixed(5);
}

// ============================================================
// TICKERS
// ============================================================
function buildTickers(){
  const doubled=[...COINS,...COINS];
  let html='';
  doubled.forEach(c=>{const cls=c.chg>=0?'nt-up':'nt-dn',sign=c.chg>=0?'+':'';html+=`<div class="nt-item"><span class="nt-sym">${c.sym}</span><span class="nt-price">${fmtPrice(c.price)}</span><span class="nt-chg ${cls}">${sign}${c.chg.toFixed(2)}%</span></div>`;});
  ['navTickerTrack','chartNavTicker','tradeNavTicker','dashNavTicker','sigNavTicker'].forEach(id=>{const el=document.getElementById(id);if(el)el.innerHTML=html;});
  let mb=''; doubled.forEach(c=>{const cls=c.chg>=0?'nt-up':'nt-dn',sign=c.chg>=0?'+':'';mb+=`<div class="mb-item"><span class="mb-sym">${c.sym}</span><span class="mb-price">${fmtPrice(c.price)}</span><span class="mb-chg ${cls}">${sign}${c.chg.toFixed(2)}%</span></div>`;});
  ['marketBarTrack','dashMarketBar'].forEach(id=>{const el=document.getElementById(id);if(el)el.innerHTML=mb;});
}
function updateTickerPrices(){
  COINS.forEach(c=>{c.price*=1+(Math.random()-0.499)*0.002;c.chg+=(Math.random()-0.5)*0.15;PAIR_PRICES[c.sym.split('/')[0]]=c.price;});
  buildTickers();
}

// ============================================================
// TRADER POOL
// ============================================================
function shuffleArr(arr){const a=[...arr];for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
function generateTraderPool(count){
  const pool=[];const fns=shuffleArr(FIRST_NAMES),lns=shuffleArr(LAST_NAMES);let fi=0,li=0;
  while(pool.length<count){
    const fn=fns[fi%fns.length],ln=lns[li%lns.length];fi++;li++;
    const country=COUNTRIES[Math.floor(Math.random()*COUNTRIES.length)];
    const emoji=TRADER_EMOJIS[Math.floor(Math.random()*TRADER_EMOJIS.length)];
    const profit=(Math.random()*1800+30).toFixed(2);
    const pair=TRADE_TYPES[Math.floor(Math.random()*TRADE_TYPES.length)];
    const mins=Math.floor(Math.random()*58)+1;
    const leverage=[2,5,10,20,25,50][Math.floor(Math.random()*6)];
    const pct=(Math.random()*18+1.5).toFixed(1);
    pool.push({name:`${fn} ${ln}`,flag:country.flag,loc:country.loc,emoji,profit,pair,mins,leverage,pct});
  }
  return pool;
}
let traderPoolCache=null,winnerPoolCache=null;
function getTraderPool(){if(!traderPoolCache)traderPoolCache=generateTraderPool(200);return traderPoolCache;}
function getWinnerPool(){
  if(!winnerPoolCache){
    const pool=generateTraderPool(50);
    pool.forEach(t=>{t.totalProfit=(parseFloat(t.profit)*8+Math.random()*5000).toFixed(0);t.winRate=Math.floor(Math.random()*20+70);t.totalTrades=Math.floor(Math.random()*1000+200);});
    winnerPoolCache=pool.sort((a,b)=>parseFloat(b.totalProfit)-parseFloat(a.totalProfit)).slice(0,12);
  }
  return winnerPoolCache;
}
function buildLiveTradersFromPool(){
  const pool=getTraderPool();const doubled=[...pool.slice(0,60),...pool.slice(0,60)];
  const track=document.getElementById('tradersTrack');if(!track)return;
  let html='';
  doubled.forEach(t=>{html+=`<div class="trader-chip"><div class="trader-avatar">${t.emoji}</div><div><div class="trader-name">${t.name} ${t.flag}</div><div class="trader-profit">+$${t.profit} · ${t.pair} ${t.leverage}×</div><div class="trader-time">${t.mins}m ago · +${t.pct}%</div></div></div>`;});
  track.innerHTML=html;
}
function buildWinnersFromPool(){
  const pool=getWinnerPool().slice(0,6);const RANK=['👑','🥈','🥉','🎯','⭐','💫'];
  const g=document.getElementById('winnersGrid');if(!g)return;
  g.innerHTML=pool.map((w,i)=>`<div class="winner-card"><div class="winner-rank">#${i+1}</div><div class="winner-head"><div class="winner-ava">${RANK[i]}</div><div><div class="winner-name">${w.name}</div><div class="winner-loc">${w.flag} ${w.loc}</div></div></div><div class="winner-stats"><div class="winner-stat"><div class="ws-val">$${parseInt(w.totalProfit).toLocaleString()}</div><div class="ws-lbl">Profit</div></div><div class="winner-stat"><div class="ws-val">${w.totalTrades}</div><div class="ws-lbl">Trades</div></div><div class="winner-stat"><div class="ws-val">${w.winRate}%</div><div class="ws-lbl">Win Rate</div></div><div class="winner-stat"><div class="ws-val">${w.leverage}×</div><div class="ws-lbl">Top Lev</div></div></div></div>`).join('');
}

// ============================================================
// REVIEWS
// ============================================================
const REVIEWS=[
  {name:'Michael Roberts',loc:'Nairobi, Kenya',flag:'🇰🇪',stars:5,text:"Best platform I've used! Made $5,000 in my first month.",date:'2 days ago'},
  {name:'Sarah Mitchell',loc:'Mombasa, Kenya',flag:'🇰🇪',stars:5,text:'Finally a platform that actually pays! Withdrew $3,500 yesterday.',date:'5 days ago'},
  {name:'David Kimani',loc:'Kisumu, Kenya',flag:'🇰🇪',stars:5,text:'Started with $100, now at $2,800! Scalper Pro bot is incredible!',date:'1 week ago'},
  {name:'Grace Wanjiku',loc:'Nakuru, Kenya',flag:'🇰🇪',stars:5,text:'Easiest money I\'ve ever made. Withdrawals are super fast.',date:'1 week ago'},
  {name:'John Ochieng',loc:'Eldoret, Kenya',flag:'🇰🇪',stars:5,text:'Been trading 3 months. Consistent profits every week.',date:'2 weeks ago'},
  {name:'Lucy Akinyi',loc:'Nairobi, Kenya',flag:'🇰🇪',stars:5,text:'Withdrew over $10,000 so far. No issues at all!',date:'2 weeks ago'},
];
function buildReviews(){
  const g=document.getElementById('reviewsGrid');if(!g)return;
  g.innerHTML=REVIEWS.map(r=>`<div class="review-card"><div class="review-head"><div class="review-ava">👤</div><div><div class="review-name">${r.name}</div><div class="review-loc">${r.flag} ${r.loc}</div><div class="review-stars">${'★'.repeat(r.stars)}</div></div></div><div class="review-body">"${r.text}"</div><div style="display:flex;align-items:center;justify-content:space-between;margin-top:10px;"><span style="display:inline-flex;align-items:center;gap:4px;padding:3px 8px;background:var(--green3);border-radius:4px;font-size:10px;font-weight:700;color:var(--green)">✓ VERIFIED</span><span style="font-size:11px;color:var(--text3)">${r.date}</span></div></div>`).join('');
}

// ============================================================
// AI ASSISTANT — Advanced
// ============================================================
let aiTyping = false;

const AI_KB = {
  'start trading': `To start trading on CryptoPro:\n\n**Step 1** — Create a free account & get $25 demo bonus\n**Step 2** — Practice with DEMO mode (no real money)\n**Step 3** — Deposit funds (minimum $10)\n**Step 4** — Select a pair (BTC/USDT is most popular)\n**Step 5** — Set your leverage (start with 5-10x)\n**Step 6** — Place your first trade\n\n💡 Tip: Always use Stop Loss to protect your capital.`,
  'leverage': `📊 **Leverage Trading Explained**\n\nLeverage lets you control a larger position with less capital:\n\n• 10x leverage = $100 controls $1,000 position\n• 50x leverage = $100 controls $5,000 position\n• 100x leverage = $100 controls $10,000 position\n\n⚠️ **Risk Warning:** Higher leverage amplifies both profits AND losses. A 1% move against you at 100x = 100% loss.\n\n💡 Recommended for beginners: Start at 5-10x`,
  'deposit': `💰 **Deposit Methods**\n\n**📱 M-Pesa (Instant)**\nTill Number: ${PAYMENT_CONFIG.MPESA.TILL_NUMBER}\nBusiness: ${PAYMENT_CONFIG.MPESA.BUSINESS_NAME}\nMinimum: $10\n\n**🏦 Equity Bank**\nAccount: ${PAYMENT_CONFIG.BANK.ACCOUNT}\nName: ${PAYMENT_CONFIG.BANK.ACCOUNT_NAME}\n\n**₿ Crypto**\nBTC: ${PAYMENT_CONFIG.CRYPTO.BTC.substring(0,20)}...\nUSDT TRC-20: ${PAYMENT_CONFIG.CRYPTO['USDT-TRC20'].substring(0,20)}...\n\n🎁 First deposit gets 100% bonus!`,
  'withdraw': `💸 **Withdrawal Information**\n\n• Minimum: $50\n• Fee: 2% of amount\n• Processing: 5–30 minutes\n• Methods: M-Pesa, Bank, Crypto\n\n**How to withdraw:**\n1. Go to Dashboard → Withdraw\n2. Enter amount\n3. Choose method\n4. Enter account details\n5. Submit & wait for confirmation`,
  'ai bots': `🤖 **AI Trading Bots**\n\nOur bots trade 24/7 automatically:\n\n• **Scalper Pro** — 87% win rate, +3.2% daily\n• **Trend Master** — 82% win rate, +2.8% daily\n• **Grid Trader** — 79% win rate, +2.5% daily\n• **Arbitrage AI** — 91% win rate, +4.1% daily\n• **DCA Bot** — 76% win rate, +1.8% daily\n• **Swing Hunter** — 68% win rate, +5.2% daily\n\n💡 Bots work in both Demo and Real mode!`,
  'referral': `🎁 **Referral Program**\n\n• Earn **10% lifetime commission** on every deposit\n• $5 bonus for each friend who signs up\n• No limit on referrals\n• Instant credit to your account\n\nFind your unique link:\nDashboard → Referrals → Copy Link\n\nShare on WhatsApp, Telegram, or any platform!`,
  'mpesa': `📱 **M-Pesa Details**\n\nTill Number: **${PAYMENT_CONFIG.MPESA.TILL_NUMBER}**\nBusiness: ${PAYMENT_CONFIG.MPESA.BUSINESS_NAME}\n\nSteps:\n1. Open M-Pesa\n2. Select Buy Goods\n3. Enter till: ${PAYMENT_CONFIG.MPESA.TILL_NUMBER}\n4. Enter amount\n5. Confirm with PIN`,
  'bitcoin': `₿ **Bitcoin Address**\n\n${PAYMENT_CONFIG.CRYPTO.BTC}\n\n⚠️ Only send BTC to this address. Other coins will be lost.`,
  'usdt': `💵 **USDT Addresses**\n\nTRC-20 (Tron): ${PAYMENT_CONFIG.CRYPTO['USDT-TRC20']}\n\nERC-20 (Ethereum): ${PAYMENT_CONFIG.CRYPTO.ETH}\n\n⚠️ Make sure you select the correct network!`,
  'risk': `🛡️ **Risk Management Tips**\n\n1. Never risk more than 1-2% per trade\n2. Always use Stop Loss orders\n3. Start with low leverage (5-10x)\n4. Don't trade with money you can't afford to lose\n5. Take profits when up, don't get greedy\n6. Diversify across multiple pairs\n7. Use Demo mode to practice first`,
  'best coins': `🔥 **Top Trading Pairs Right Now**\n\n• **BTC/USDT** — Most liquid, lowest spread\n• **ETH/USDT** — High volatility, great moves\n• **SOL/USDT** — Strong momentum\n• **BNB/USDT** — Steady trends\n\n💡 Check our AI Signals page for real-time recommendations!`,
  'hello': `👋 Hello! I'm CryptoPro AI, your advanced trading intelligence assistant.\n\nI can help you with:\n• Trading strategies & analysis\n• Deposit/withdrawal guidance\n• AI bot setup\n• Risk management\n• Market insights\n\nWhat would you like to explore?`,
  'default': `🤔 Great question! I can help with:\n\n• **Trading** — How to buy/sell, leverage, orders\n• **Deposits** — M-Pesa, bank, crypto\n• **Withdrawals** — Methods, timing, fees\n• **AI Bots** — Setup, strategies, win rates\n• **Signals** — Real-time trade ideas\n• **Risk** — How to protect your capital\n\nJust ask me anything!`
};

function toggleAI(){
  aiOpen=!aiOpen;
  const p=document.getElementById('aiPanel');
  if(aiOpen)p.classList.add('open');else p.classList.remove('open');
}

function autoResize(el){el.style.height='auto';el.style.height=Math.min(el.scrollHeight,80)+'px';}

function addAIMsg(text,role='bot'){
  const msgs=document.getElementById('aiMessages');
  const div=document.createElement('div');div.className=`ai-msg ${role}`;
  const now=new Date();const t=now.getHours().toString().padStart(2,'0')+':'+now.getMinutes().toString().padStart(2,'0');
  if(role==='bot'){
    div.innerHTML=`<div class="ai-msg-bubble">${text.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\n/g,'<br>')}</div><div class="ai-msg-meta"><div class="ai-msg-avatar">AI</div><span>CryptoPro AI</span><span>•</span><span>${t}</span></div>`;
  } else {
    div.innerHTML=`<div class="ai-msg-bubble">${text}</div><div class="ai-msg-meta"><span>${t}</span><span>•</span><span>You</span></div>`;
  }
  msgs.appendChild(div);msgs.scrollTop=msgs.scrollHeight;
}

function showAITyping(){
  const msgs=document.getElementById('aiMessages');
  const div=document.createElement('div');div.className='ai-msg bot ai-typing';div.id='aiTypingIndicator';
  div.innerHTML='<div class="ai-typing-bubble"><div class="ai-typing-dot"></div><div class="ai-typing-dot"></div><div class="ai-typing-dot"></div></div>';
  msgs.appendChild(div);msgs.scrollTop=msgs.scrollHeight;
}

function removeAITyping(){const t=document.getElementById('aiTypingIndicator');if(t)t.remove();}

function sendAI(){
  if(aiTyping)return;
  const inp=document.getElementById('aiInput');const msg=inp.value.trim();if(!msg)return;
  addAIMsg(msg,'user');inp.value='';inp.style.height='auto';
  const btn=document.getElementById('aiSendBtn');btn.disabled=true;aiTyping=true;
  showAITyping();
  const lower=msg.toLowerCase();
  let reply=AI_KB.default;
  for(const key in AI_KB){if(lower.includes(key)){reply=AI_KB[key];break;}}
  const delay=800+Math.random()*1000;
  setTimeout(()=>{
    removeAITyping();addAIMsg(reply,'bot');
    btn.disabled=false;aiTyping=false;
  },delay);
}

function aiQuick(q){document.getElementById('aiInput').value=q;sendAI();}
function clearAIChat(){
  const msgs=document.getElementById('aiMessages');
  while(msgs.children.length>1)msgs.removeChild(msgs.lastChild);
  showToast('Chat cleared','blue',2000);
}

// ============================================================
// AUTH
// ============================================================
let signupData={},loginStep=1;
function signupNext(step){
  if(step===1){
    const name=document.getElementById('signupName').value.trim();
    const email=document.getElementById('signupEmail').value.trim();
    const phone=document.getElementById('signupPhone').value.trim();
    if(!name||!email||!phone){showSignupAlert('Please fill in all fields.','error');return;}
    signupData={name,email,phone};
    document.getElementById('signupStep1').style.display='none';
    document.getElementById('signupStep2').style.display='block';
    document.getElementById('spFill').style.width='66%';
    document.getElementById('sp1').classList.remove('active');
    document.getElementById('sp2').classList.add('active');hideSignupAlert();
  } else if(step===2){
    const pwd=document.getElementById('signupPassword').value;
    const confirm=document.getElementById('signupConfirm').value;
    if(pwd.length<8){showSignupAlert('Password must be at least 8 characters.','error');return;}
    if(pwd!==confirm){showSignupAlert('Passwords do not match.','error');return;}
    signupData.password=pwd;signupData.referralCode=document.getElementById('signupReferralCode').value.trim();
    document.getElementById('confirmName').textContent=signupData.name;
    document.getElementById('confirmEmail').textContent=signupData.email;
    document.getElementById('confirmPhone').textContent=signupData.phone;
    document.getElementById('confirmRef').textContent=signupData.referralCode||'None';
    document.getElementById('signupStep2').style.display='none';
    document.getElementById('signupStep3').style.display='block';
    document.getElementById('spFill').style.width='100%';
    document.getElementById('sp2').classList.remove('active');
    document.getElementById('sp3').classList.add('active');hideSignupAlert();
  }
}
function signupBack(step){
  if(step===2){document.getElementById('signupStep2').style.display='none';document.getElementById('signupStep1').style.display='block';document.getElementById('spFill').style.width='33%';document.getElementById('sp2').classList.remove('active');document.getElementById('sp1').classList.add('active');}
  else if(step===3){document.getElementById('signupStep3').style.display='none';document.getElementById('signupStep2').style.display='block';document.getElementById('spFill').style.width='66%';document.getElementById('sp3').classList.remove('active');document.getElementById('sp2').classList.add('active');}
}
function showSignupAlert(msg,type){const a=document.getElementById('signupAlert');a.textContent=msg;a.className=`form-alert ${type}`;a.style.display='block';}
function hideSignupAlert(){document.getElementById('signupAlert').style.display='none';}
function handleSignup(e){
  e.preventDefault();
  if(!document.getElementById('agreeTerms').checked){showSignupAlert('Please agree to the Terms of Service.','error');return false;}
  const btn=document.getElementById('signupBtn');
  document.getElementById('signupBtnText').style.display='none';
  document.getElementById('signupBtnSpinner').style.display='inline-block';
  btn.disabled=true;
  setTimeout(()=>{
    const refCode='CP'+Math.random().toString(36).substr(2,6).toUpperCase();
    currentUser={
      name:signupData.name,email:signupData.email,phone:signupData.phone,
      refCode,demoBalance:25,realBalance:0,deposits:0,profit:0,
      trades:[],openPositions:[],joinDate:new Date().toLocaleDateString(),
      referrals:[],referralEarnings:0,balanceHistory:[{t:Date.now(),v:25}]
    };
    saveState();
    try{
      emailjs.send(PAYMENT_CONFIG.EMAILJS.SERVICE_ID,PAYMENT_CONFIG.EMAILJS.TEMPLATE_ID,{
        to_name:currentUser.name,to_email:currentUser.email,
        message:'Welcome to CryptoPro! Your $25 demo bonus has been credited.'
      });
    }catch(e){}
    addNotification('🎉','Welcome to CryptoPro! Your $25 bonus is ready.','rgba(0,230,118,.2)');
    showToast(`🎉 Welcome, ${currentUser.name}! Your $25 demo bonus has been credited!`,'green',5000);
    showLayer('dashboardLayer');
  },2200);
  return false;
}
function handleLogin(e){
  e.preventDefault();
  const email=document.getElementById('loginEmail').value.trim();
  const pwd=document.getElementById('loginPassword').value;
  if(!email||!pwd){showLoginAlert('Please fill in all fields.','error');return false;}
  if(loginStep===1){
    document.getElementById('loginBtnText').style.display='none';
    document.getElementById('loginBtnSpinner').style.display='inline-block';
    setTimeout(()=>{
      document.getElementById('loginBtnText').style.display='inline';
      document.getElementById('loginBtnSpinner').style.display='none';
      document.getElementById('twoFAStep').style.display='block';
      document.getElementById('loginBtnText').textContent='Verify Code →';
      loginStep=2;hideLoginAlert();
    },1400);
    return false;
  }
  if(loginStep===2){
    const otp=Array.from(document.querySelectorAll('.otp-input')).map(i=>i.value).join('');
    if(otp!=='123456'){showLoginAlert('Invalid 2FA code. Demo code is 123456.','error');return false;}
    document.getElementById('loginBtnText').style.display='none';
    document.getElementById('loginBtnSpinner').style.display='inline-block';
    setTimeout(()=>{
      loadState();
      if(!currentUser){
        const refCode='CP'+Math.random().toString(36).substr(2,6).toUpperCase();
        currentUser={name:email.split('@')[0],email,phone:'+254 700 000 000',refCode,demoBalance:25,realBalance:0,deposits:0,profit:0,trades:[],openPositions:[],joinDate:new Date().toLocaleDateString(),referrals:[],referralEarnings:0,balanceHistory:[{t:Date.now(),v:25}]};
      }
      saveState();
      showToast(`Welcome back, ${currentUser.name}!`,'green');
      loginStep=1;showLayer('dashboardLayer');
    },1200);
  }
  return false;
}
function showLoginAlert(msg,type){const a=document.getElementById('loginAlert');a.textContent=msg;a.className=`form-alert ${type}`;a.style.display='block';}
function hideLoginAlert(){document.getElementById('loginAlert').style.display='none';}
function handleLogout(){saveState();currentUser=null;dashMode='demo';loginStep=1;showLayer('welcomeLayer');showToast('You have been logged out.','blue');}
function togglePwd(id,btn){const inp=document.getElementById(id);if(inp.type==='password'){inp.type='text';btn.textContent='🙈';}else{inp.type='password';btn.textContent='👁';}}
function otpNext(el,idx){if(el.value.length===1){const inputs=document.querySelectorAll('.otp-input');if(inputs[idx+1])inputs[idx+1].focus();}}
function checkPasswordStrength(pwd){
  const fill=document.getElementById('pwdFill'),label=document.getElementById('pwdLabel');if(!fill)return;
  let score=0;if(pwd.length>=8)score++;if(/[A-Z]/.test(pwd))score++;if(/[0-9]/.test(pwd))score++;if(/[^A-Za-z0-9]/.test(pwd))score++;
  const levels=[{w:'0%',c:'transparent',t:''},{w:'25%',c:'var(--red)',t:'Weak'},{w:'50%',c:'var(--yellow)',t:'Fair'},{w:'75%',c:'var(--blue)',t:'Good'},{w:'100%',c:'var(--green)',t:'Strong'}];
  const lv=levels[score]||levels[0];fill.style.width=lv.w;fill.style.background=lv.c;label.textContent=lv.t;label.style.color=lv.c;
}
const LOGIN_LIVE_MSGS=[
  ()=>{const t=generateTraderPool(1)[0];return `🎉 <strong style="color:var(--text1)">${t.name}</strong> just withdrew <strong style="color:var(--green)">$${(Math.random()*3000+200).toFixed(0)}</strong>`;},
  ()=>{const t=generateTraderPool(1)[0];return `⚡ <strong style="color:var(--text1)">${t.name}</strong> made <strong style="color:var(--green)">+${(Math.random()*18+2).toFixed(1)}%</strong> on ${TRADE_TYPES[Math.floor(Math.random()*TRADE_TYPES.length)]}`;},
  ()=>{const t=generateTraderPool(1)[0];return `🤖 <strong style="color:var(--text1)">${t.name}</strong>'s bot earned <strong style="color:var(--green)">$${(Math.random()*800+50).toFixed(0)}</strong> today`;},
];
let liveIdx=0;
function rotateLiveMsg(){const el=document.getElementById('loginLiveMsg');if(!el)return;el.innerHTML=LOGIN_LIVE_MSGS[liveIdx%LOGIN_LIVE_MSGS.length]();liveIdx++;}

// ============================================================
// TRADINGVIEW LIGHTWEIGHT CHARTS ENGINE
// ============================================================
function tvChartConfig(){
  return {
    layout:{background:{type:'Solid',color:'#06080D'},textColor:'#8892A4'},
    grid:{vertLines:{color:'rgba(255,255,255,0.04)'},horzLines:{color:'rgba(255,255,255,0.04)'}},
    crosshair:{mode:1},
    rightPriceScale:{borderColor:'rgba(255,255,255,0.08)',scaleMargins:{top:.1,bottom:.1}},
    timeScale:{borderColor:'rgba(255,255,255,0.08)',timeVisible:true,secondsVisible:false},
    handleScroll:true,handleScale:true
  };
}

function generateOHLCV(basePrice,count,intervalSec){
  const data=[];const now=Math.floor(Date.now()/1000);
  let price=basePrice*(0.97+Math.random()*0.06);
  for(let i=0;i<count;i++){
    const t=now-(count-i)*intervalSec;
    const open=price,change=(Math.random()-0.48)*basePrice*0.008,close=open+change;
    const high=Math.max(open,close)+(Math.random()*basePrice*0.003);
    const low=Math.min(open,close)-(Math.random()*basePrice*0.003);
    const vol=Math.random()*basePrice*0.5+basePrice*0.1;
    data.push({time:t,open,high,low,close,value:close,volume:vol});
    price=close;
  }
  return data;
}

function calcMAData(data,period=20){
  return data.map((d,i)=>{
    if(i<period-1)return null;
    const slice=data.slice(i-period+1,i+1);
    const avg=slice.reduce((s,c)=>s+c.close,0)/period;
    return {time:d.time,value:avg};
  }).filter(Boolean);
}

function calcBBData(data,period=20){
  const upper=[],lower=[];
  data.forEach((d,i)=>{
    if(i<period-1)return;
    const slice=data.slice(i-period+1,i+1);
    const avg=slice.reduce((s,c)=>s+c.close,0)/period;
    const sd=Math.sqrt(slice.reduce((s,c)=>s+(c.close-avg)**2,0)/period);
    upper.push({time:d.time,value:avg+2*sd});
    lower.push({time:d.time,value:avg-2*sd});
  });
  return {upper,lower};
}

function calcRSIData(data,period=14){
  const rsiData=[];
  for(let i=period;i<data.length;i++){
    let gains=0,losses=0;
    for(let j=i-period+1;j<=i;j++){const diff=data[j].close-data[j-1].close;if(diff>=0)gains+=diff;else losses-=diff;}
    const rs=losses===0?100:gains/losses;
    rsiData.push({time:data[i].time,value:100-100/(1+rs)});
  }
  return rsiData;
}

function getIntervalSec(iv){
  return {'1m':60,'5m':300,'15m':900,'1h':3600,'4h':14400,'1d':86400}[iv]||60;
}

// ============================================================
// CHARTS LAYER — TradingView
// ============================================================
function initChartsLayer(){
  clearInterval(obInterval);clearInterval(tradeInterval);clearInterval(priceInterval);
  tradeFeedBuf=[];

  // Create main chart
  const container=document.getElementById('tvChartContainer');
  if(!container)return;
  container.innerHTML='';

  const chartHeight=container.clientHeight||450;
  if(tvMainChart){try{tvMainChart.remove();}catch(e){}}
  tvMainChart=LightweightCharts.createChart(container,{...tvChartConfig(),width:container.clientWidth,height:chartHeight});

  const base=PAIR_PRICES[currentChartPair]||1;
  const data=generateOHLCV(base,120,getIntervalSec(currentChartInterval));

  tvMainSeries=tvMainChart.addCandlestickSeries({
    upColor:'#00E676',downColor:'#FF3D57',borderUpColor:'#00E676',borderDownColor:'#FF3D57',
    wickUpColor:'#00E676',wickDownColor:'#FF3D57'
  });
  tvMainSeries.setData(data);

  // MA
  tvMainMA=tvMainChart.addLineSeries({color:'rgba(255,215,64,0.8)',lineWidth:1.5,priceLineVisible:false});
  tvMainMA.setData(calcMAData(data));
  tvMainMA.applyOptions({visible:showMAChart});

  // Bollinger Bands
  const bb=calcBBData(data);
  tvMainBBU=tvMainChart.addLineSeries({color:'rgba(170,119,255,0.5)',lineWidth:1,priceLineVisible:false});
  tvMainBBU.setData(bb.upper);tvMainBBU.applyOptions({visible:showBBChart});
  tvMainBBL=tvMainChart.addLineSeries({color:'rgba(170,119,255,0.5)',lineWidth:1,priceLineVisible:false});
  tvMainBBL.setData(bb.lower);tvMainBBL.applyOptions({visible:showBBChart});

  // Volume chart
  const volWrap=document.getElementById('volWrapTV');
  if(volWrap){
    const volContainer=document.getElementById('tvVolContainer');volContainer.innerHTML='';
    if(showVolChart){
      volWrap.style.display='block';
      if(tvMainVolChart){try{tvMainVolChart.remove();}catch(e){}}
      tvMainVolChart=LightweightCharts.createChart(volContainer,{...tvChartConfig(),height:70,timeScale:{visible:false}});
      tvMainVolSeries=tvMainVolChart.addHistogramSeries({color:'rgba(0,230,118,.5)',priceFormat:{type:'volume'},priceScaleId:'',scaleMargins:{top:.1,bottom:.1}});
      tvMainVolSeries.setData(data.map(d=>({time:d.time,value:d.volume,color:d.close>=d.open?'rgba(0,230,118,.5)':'rgba(255,61,87,.5)'})));
    } else { volWrap.style.display='none'; }
  }

  // RSI
  const rsiWrap=document.getElementById('rsiWrapTV');
  if(rsiWrap){
    const rsiContainer=document.getElementById('tvRsiContainer');
    if(rsiContainer)rsiContainer.querySelectorAll('div:not(:first-child)').forEach(e=>e.remove());
    if(showRSIChart){
      rsiWrap.style.display='block';
      if(tvRsiChart){try{tvRsiChart.remove();}catch(e){}}
      const rsiEl=document.createElement('div');rsiEl.style.height='100%';rsiEl.style.position='absolute';rsiEl.style.inset='0';rsiContainer.appendChild(rsiEl);
      tvRsiChart=LightweightCharts.createChart(rsiEl,{...tvChartConfig(),height:80,timeScale:{visible:false}});
      tvRsiSeries=tvRsiChart.addLineSeries({color:'var(--cyan)',lineWidth:1.5,priceLineVisible:false,lastValueVisible:false,crosshairMarkerVisible:false});
      tvRsiSeries.setData(calcRSIData(data));
      // OB/OS lines
      tvRsiChart.addLineSeries({color:'rgba(255,61,87,.3)',lineWidth:1,priceLineVisible:false}).setData(data.map(d=>({time:d.time,value:70})));
      tvRsiChart.addLineSeries({color:'rgba(0,230,118,.3)',lineWidth:1,priceLineVisible:false}).setData(data.map(d=>({time:d.time,value:30})));
    } else { rsiWrap.style.display='none'; }
  }

  tvMainChart.timeScale().fitContent();
  updatePriceHeader(base);
  buildOrderBook(base);
  buildMarketCards();

  // Live updates
  obInterval=setInterval(()=>{
    PAIR_PRICES[currentChartPair]*=1+(Math.random()-0.499)*0.001;
    buildOrderBook(PAIR_PRICES[currentChartPair]);
    updateChartTick();
  },800);
  tradeInterval=setInterval(()=>addTradeFeed(PAIR_PRICES[currentChartPair]),500);
  priceInterval=setInterval(()=>{
    PAIR_PRICES[currentChartPair]*=1+(Math.random()-0.499)*0.0015;
    updatePriceHeader(PAIR_PRICES[currentChartPair]);
  },1500);
}

let mainData=[];
function updateChartTick(){
  if(!tvMainSeries)return;
  const base=PAIR_PRICES[currentChartPair];
  const now=Math.floor(Date.now()/1000);
  const iv=getIntervalSec(currentChartInterval);
  const barTime=Math.floor(now/iv)*iv;
  const tick={time:barTime,open:base*0.9998,high:base*1.001,low:base*0.999,close:base*(0.9999+Math.random()*0.0002)};
  try{tvMainSeries.update(tick);}catch(e){}
}

function updatePriceHeader(price){
  const el=document.getElementById('phPrice');if(el){
    const prev=parseFloat(el.getAttribute('data-prev')||price);
    el.textContent=fmtPriceShort(price);
    el.className='ph-price '+(price>=prev?'up':'down');
    el.setAttribute('data-prev',price);
  }
  const chg=(Math.random()-0.48)*1.5;
const phChange = document.getElementById('phChange');
  if(phChange){
    const sign = chg >= 0 ? '+' : '';
    phChange.textContent = sign + chg.toFixed(2) + '%';
    phChange.className = 'ph-change ' + (chg >= 0 ? 'up' : 'down');
  }
  const high = price * 1.012, low = price * 0.988, vol = (Math.random() * 50000 + 10000).toFixed(0);
  const h = document.getElementById('ph24hHigh'), l = document.getElementById('ph24hLow'),
        v = document.getElementById('ph24hVol'), o = document.getElementById('phOpen');
  if(h) h.textContent = fmtPriceShort(high);
  if(l) l.textContent = fmtPriceShort(low);
  if(v) v.textContent = parseFloat(vol).toLocaleString() + ' ' + currentChartPair;
  if(o) o.textContent = fmtPriceShort(price * 0.995);
}

// ============================================================
// ORDER BOOK
// ============================================================
function generateOBSide(midPrice, count, isBid){
  const rows = [];
  for(let i = 0; i < count; i++){
    const offset = (i + 1) * midPrice * (0.0002 + Math.random() * 0.0003);
    const price = isBid ? midPrice - offset : midPrice + offset;
    const amt = (Math.random() * 3 + 0.05).toFixed(4);
    const total = (price * parseFloat(amt)).toFixed(2);
    rows.push({ price, amt, total });
  }
  return rows;
}

function buildOrderBook(mid){
  const asks = generateOBSide(mid, 12, false).reverse();
  const bids = generateOBSide(mid, 12, true);
  const maxTotal = Math.max(...[...asks,...bids].map(r => parseFloat(r.total)));

  function rowHTML(r, cls){
    const pct = (parseFloat(r.total)/maxTotal*100).toFixed(1);
    const bg = cls==='ask' ? `rgba(255,61,87,${pct/400})` : `rgba(0,230,118,${pct/400})`;
    return `<div class="ob-row" style="background:linear-gradient(to left,${bg} ${pct}%,transparent ${pct}%)">
      <span class="ob-price ${cls}">${fmtPriceShort(r.price)}</span>
      <span class="ob-amt">${r.amt}</span>
      <span class="ob-total">${parseFloat(r.total).toLocaleString()}</span>
    </div>`;
  }

  ['obAsks','miniObAsks'].forEach(id => {
    const el = document.getElementById(id);
    if(el) el.innerHTML = asks.map(r => rowHTML(r,'ask')).join('');
  });
  ['obBids','miniObBids'].forEach(id => {
    const el = document.getElementById(id);
    if(el) el.innerHTML = bids.map(r => rowHTML(r,'bid')).join('');
  });

  const spread = asks[asks.length-1].price - bids[0].price;
  const spreadPct = (spread/mid*100).toFixed(3);
  ['obSpreadPrice','miniSpreadPrice'].forEach(id => {
    const el = document.getElementById(id);
    if(el) el.textContent = fmtPriceShort(mid);
  });
  ['obSpreadPct'].forEach(id => {
    const el = document.getElementById(id);
    if(el) el.textContent = 'Spread: ' + spreadPct + '%';
  });

  // Depth canvas
  drawDepthChart(mid, bids, asks);
}

function drawDepthChart(mid, bids, asks){
  const canvas = document.getElementById('depthCanvas');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  canvas.width = canvas.offsetWidth * window.devicePixelRatio;
  canvas.height = canvas.offsetHeight * window.devicePixelRatio;
  ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
  const W = canvas.offsetWidth, H = canvas.offsetHeight;
  ctx.clearRect(0,0,W,H);

  const allBids = bids.slice().reverse();
  const allAsks = asks.slice().reverse();
  const maxVol = Math.max(
    allBids.reduce((s,r)=>s+parseFloat(r.total),0),
    allAsks.reduce((s,r)=>s+parseFloat(r.total),0)
  );

  function drawSide(rows, color, fromRight){
    let cum = 0;
    ctx.beginPath();
    if(fromRight){ ctx.moveTo(W, H); } else { ctx.moveTo(0, H); }
    rows.forEach((r,i) => {
      cum += parseFloat(r.total);
      const x = fromRight ? W - (cum/maxVol)*(W/2) : (cum/maxVol)*(W/2);
      const y = H - (i/rows.length)*H*0.8 - 10;
      ctx.lineTo(x, y);
    });
    if(fromRight){ ctx.lineTo(W/2, H); } else { ctx.lineTo(W/2, H); }
    ctx.closePath();
    ctx.fillStyle = color;
    ctx.fill();
  }

  drawSide(allBids, 'rgba(0,230,118,0.15)', false);
  drawSide(allAsks, 'rgba(255,61,87,0.15)', true);

  // Mid line
  ctx.strokeStyle = 'rgba(255,255,255,0.15)';
  ctx.setLineDash([4,4]);
  ctx.beginPath();
  ctx.moveTo(W/2, 0);
  ctx.lineTo(W/2, H);
  ctx.stroke();
  ctx.setLineDash([]);
}

// ============================================================
// TRADES FEED
// ============================================================
function addTradeFeed(price){
  const feed = document.getElementById('tradesFeed');
  if(!feed) return;
  const isBuy = Math.random() > 0.48;
  const amt = (Math.random()*2+0.01).toFixed(4);
  const tradePrice = price * (1 + (Math.random()-0.5)*0.0005);
  const now = new Date();
  const timeStr = now.getHours().toString().padStart(2,'0') + ':' +
                  now.getMinutes().toString().padStart(2,'0') + ':' +
                  now.getSeconds().toString().padStart(2,'0');
  const row = document.createElement('div');
  row.className = 'tp-row';
  row.innerHTML = `<span class="tp-price ${isBuy?'buy':'sell'}">${fmtPriceShort(tradePrice)}</span>
    <span class="tp-amt">${amt}</span>
    <span class="tp-time">${timeStr}</span>`;
  feed.insertBefore(row, feed.firstChild);
  if(feed.children.length > 60) feed.removeChild(feed.lastChild);
}

// ============================================================
// PAIR / INTERVAL SELECTION (CHARTS LAYER)
// ============================================================
function selectPair(base, quote, btn){
  document.querySelectorAll('.pair-bar .pair-btn').forEach(b => b.classList.remove('active'));
  if(btn) btn.classList.add('active');
  currentChartPair = base;
  const nameEl = document.getElementById('phPairName');
  if(nameEl) nameEl.textContent = base + ' / ' + quote;
  clearInterval(obInterval); clearInterval(tradeInterval); clearInterval(priceInterval);
  initChartsLayer();
}

function setChartInterval(iv, btn){
  document.querySelectorAll('.price-header .iv-btn').forEach(b => b.classList.remove('active'));
  if(btn) btn.classList.add('active');
  currentChartInterval = iv;
  initChartsLayer();
}

function setOBView(view, btn){
  document.querySelectorAll('.ob-tabs .ob-tab').forEach(b => b.classList.remove('active'));
  if(btn) btn.classList.add('active');
  const asks = document.getElementById('obAsks'), bids = document.getElementById('obBids');
  if(view === 'asks'){ if(bids) bids.style.display='none'; if(asks) asks.style.display='flex'; }
  else if(view === 'bids'){ if(asks) asks.style.display='none'; if(bids) bids.style.display='flex'; }
  else { if(asks) asks.style.display='flex'; if(bids) bids.style.display='flex'; }
}

// ============================================================
// CHART INDICATORS TOGGLE (CHARTS LAYER)
// ============================================================
function toggleMA(btn){
  showMAChart = !showMAChart;
  btn.classList.toggle('active', showMAChart);
  if(tvMainMA) tvMainMA.applyOptions({visible: showMAChart});
}
function toggleBB(btn){
  showBBChart = !showBBChart;
  btn.classList.toggle('active', showBBChart);
  if(tvMainBBU) tvMainBBU.applyOptions({visible: showBBChart});
  if(tvMainBBL) tvMainBBL.applyOptions({visible: showBBChart});
}
function toggleVol(btn){
  showVolChart = !showVolChart;
  btn.classList.toggle('active', showVolChart);
  initChartsLayer();
}
function toggleRSI(btn){
  showRSIChart = !showRSIChart;
  btn.classList.toggle('active', showRSIChart);
  initChartsLayer();
}

// ============================================================
// MARKET OVERVIEW CARDS (CHARTS LAYER)
// ============================================================
function buildMarketCards(){
  const grid = document.getElementById('marketCardsGrid');
  if(!grid) return;
  grid.innerHTML = COINS.map(c => {
    const isUp = c.chg >= 0;
    const sign = isUp ? '+' : '';
    const clr = isUp ? 'var(--green)' : 'var(--red)';
    return `<div class="market-card" onclick="selectPair('${c.sym.split('/')[0]}','USDT',null);showLayer('chartsLayer')">
      <div class="mc-sym">${c.sym}</div>
      <div class="mc-price" style="color:${clr}">${fmtPrice(c.price)}</div>
      <div class="mc-chg" style="color:${clr}">${sign}${c.chg.toFixed(2)}%</div>
      <div class="mc-mini" id="mini_${c.sym.replace('/','_')}"></div>
    </div>`;
  }).join('');

  // Draw sparklines
  COINS.forEach(c => {
    const id = 'mini_' + c.sym.replace('/','_');
    const wrap = document.getElementById(id);
    if(!wrap) return;
    const canvas = document.createElement('canvas');
    wrap.appendChild(canvas);
    const pts = Array.from({length:20},(_,i)=>{
      return c.price * (0.98 + Math.random()*0.04);
    });
    drawSparkline(canvas, pts, c.chg >= 0);
  });
}

function drawSparkline(canvas, pts, isUp){
  canvas.style.position='absolute';canvas.style.inset='0';
  canvas.style.width='100%';canvas.style.height='100%';
  canvas.width = canvas.offsetWidth || 180;
  canvas.height = canvas.offsetHeight || 40;
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  const min = Math.min(...pts), max = Math.max(...pts);
  const range = max - min || 1;
  const color = isUp ? '#00E676' : '#FF3D57';
  ctx.clearRect(0,0,W,H);
  const grad = ctx.createLinearGradient(0,0,0,H);
  grad.addColorStop(0, isUp ? 'rgba(0,230,118,0.3)' : 'rgba(255,61,87,0.3)');
  grad.addColorStop(1, 'transparent');
  ctx.beginPath();
  pts.forEach((p,i)=>{
    const x = (i/(pts.length-1))*W;
    const y = H - ((p-min)/range)*(H-4) - 2;
    i===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
  });
  ctx.strokeStyle = color; ctx.lineWidth = 1.5; ctx.stroke();
  ctx.lineTo(W,H); ctx.lineTo(0,H); ctx.closePath();
  ctx.fillStyle = grad; ctx.fill();
}

// ============================================================
// TRADING LAYER
// ============================================================
function initTradingLayer(){
  clearInterval(trdObInterval); clearInterval(trdPriceInterval); clearInterval(trdChartInterval_);
  const base = PAIR_PRICES[currentTradePair] || 1;
  updateTradingPanel();
  buildTradingChart(base);

  trdObInterval = setInterval(()=>{
    PAIR_PRICES[currentTradePair] *= 1+(Math.random()-0.499)*0.001;
    updateTradingPriceStrip();
    buildOrderBook(PAIR_PRICES[currentTradePair]);
    updateMyPositionsPnL();
  }, 800);
  trdPriceInterval = setInterval(()=>{
    PAIR_PRICES[currentTradePair] *= 1+(Math.random()-0.499)*0.0015;
    updateTradingPriceStrip();
    calcOrderSummary();
  }, 1500);
}

function buildTradingChart(base){
  const container = document.getElementById('tvTradingChart');
  if(!container) return;
  container.innerHTML = '';

  if(tvTradingChart){try{tvTradingChart.remove();}catch(e){}}
  tvTradingChart = LightweightCharts.createChart(container, {
    ...tvChartConfig(),
    width: container.clientWidth,
    height: container.clientHeight || 300
  });

  const data = generateOHLCV(base, 120, getIntervalSec(currentTrdInterval));

  tvTradingSeries = tvTradingChart.addCandlestickSeries({
    upColor:'#00E676',downColor:'#FF3D57',
    borderUpColor:'#00E676',borderDownColor:'#FF3D57',
    wickUpColor:'#00E676',wickDownColor:'#FF3D57'
  });
  tvTradingSeries.setData(data);

  tvTrdMA = tvTradingChart.addLineSeries({color:'rgba(255,215,64,0.8)',lineWidth:1.5,priceLineVisible:false});
  tvTrdMA.setData(calcMAData(data));
  tvTrdMA.applyOptions({visible:showTrdMA});

  const bb = calcBBData(data);
  tvTrdBBU = tvTradingChart.addLineSeries({color:'rgba(170,119,255,0.5)',lineWidth:1,priceLineVisible:false});
  tvTrdBBU.setData(bb.upper); tvTrdBBU.applyOptions({visible:showTrdBB});
  tvTrdBBL = tvTradingChart.addLineSeries({color:'rgba(170,119,255,0.5)',lineWidth:1,priceLineVisible:false});
  tvTrdBBL.setData(bb.lower); tvTrdBBL.applyOptions({visible:showTrdBB});

  // RSI panel
  const rsiWrap = document.getElementById('trdRsiWrap');
  if(rsiWrap && showTrdRSI){
    rsiWrap.style.display = 'block';
    const rsiEl = document.getElementById('tvTrdRsiContainer');
    if(rsiEl){ rsiEl.innerHTML='<div style="position:absolute;top:4px;left:8px;font-size:10px;color:var(--text3);font-family:var(--font-mono);z-index:1;">RSI(14)</div>'; }
    if(tvTrdRsiChart){try{tvTrdRsiChart.remove();}catch(e){}}
    const rsiDiv = document.createElement('div');
    rsiDiv.style.cssText='position:absolute;inset:0;';
    rsiEl.appendChild(rsiDiv);
    tvTrdRsiChart = LightweightCharts.createChart(rsiDiv,{...tvChartConfig(),height:80,timeScale:{visible:false}});
    tvTrdRsiSeries = tvTrdRsiChart.addLineSeries({color:'var(--cyan)',lineWidth:1.5,priceLineVisible:false,lastValueVisible:false});
    tvTrdRsiSeries.setData(calcRSIData(data));
  } else if(rsiWrap){ rsiWrap.style.display='none'; }

  tvTradingChart.timeScale().fitContent();

  // Live tick
  trdChartInterval_ = setInterval(()=>{
    if(!tvTradingSeries) return;
    const p = PAIR_PRICES[currentTradePair];
    const now = Math.floor(Date.now()/1000);
    const iv = getIntervalSec(currentTrdInterval);
    const barTime = Math.floor(now/iv)*iv;
    try{ tvTradingSeries.update({time:barTime,open:p*0.9998,high:p*1.001,low:p*0.999,close:p*(1+(Math.random()-0.5)*0.0002)}); }catch(e){}
  }, 1000);
}

function updateTradingPriceStrip(){
  const p = PAIR_PRICES[currentTradePair] || 0;
  const chg = PAIR_CHANGE[currentTradePair] || 0;
  const sign = chg>=0?'+':'';
  const el = document.getElementById('tpsPrice');
  if(el){ el.textContent = fmtPriceShort(p); el.className='tps-price '+(chg>=0?'up':'down'); }
  const chgEl = document.getElementById('tpsChg');
  if(chgEl){ chgEl.textContent=sign+chg.toFixed(2)+'%'; chgEl.className='tps-chg '+(chg>=0?'up':'down'); }
  const bal = currentUser ? (dashMode==='demo'?currentUser.demoBalance:currentUser.realBalance) : 0;
  const balEl = document.getElementById('tradeAvailBal');
  if(balEl) balEl.textContent = '$'+bal.toFixed(2);
  const high=p*1.012,low=p*0.988;
  const hEl=document.getElementById('tpsHigh'),lEl=document.getElementById('tpsLow'),vEl=document.getElementById('tpsVol');
  if(hEl) hEl.textContent=fmtPriceShort(high);
  if(lEl) lEl.textContent=fmtPriceShort(low);
  if(vEl) vEl.textContent=(Math.random()*30000+5000).toFixed(0)+' '+currentTradePair;
}

function updateTradingPanel(){
  const mode = dashMode;
  const bal = currentUser ? (mode==='demo'?currentUser.demoBalance:currentUser.realBalance) : 0;
  const lbl = document.getElementById('tradeModeLabel');
  const demo = document.getElementById('opDemo'), real = document.getElementById('opReal');
  if(lbl) lbl.textContent = mode.toUpperCase();
  if(demo){ demo.classList.toggle('active', mode==='demo'); }
  if(real){ real.classList.toggle('active', mode==='real'); }
  const balEl = document.getElementById('tradeAvailBal');
  if(balEl) balEl.textContent = '$'+bal.toFixed(2);
  const pairEl = document.getElementById('tpsPair');
  if(pairEl) pairEl.textContent = currentTradePair+'/USDT';
  updateTradingPriceStrip();
  calcOrderSummary();
  renderMyPositions();
  renderMiniHistory();
}

function tradingSelectPair(base, quote, btn){
  document.querySelectorAll('#tradePairBar .pair-btn').forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');
  currentTradePair = base;
  clearInterval(trdChartInterval_);
  const p = PAIR_PRICES[base]||1;
  buildTradingChart(p);
  updateTradingPanel();
}

function setTrdInterval(iv, btn){
  document.querySelectorAll('.trade-chart-col .iv-btn').forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');
  currentTrdInterval = iv;
  clearInterval(trdChartInterval_);
  buildTradingChart(PAIR_PRICES[currentTradePair]||1);
}

function toggleTrdMA(btn){
  showTrdMA=!showTrdMA; btn.classList.toggle('active',showTrdMA);
  if(tvTrdMA) tvTrdMA.applyOptions({visible:showTrdMA});
}
function toggleTrdBB(btn){
  showTrdBB=!showTrdBB; btn.classList.toggle('active',showTrdBB);
  if(tvTrdBBU) tvTrdBBU.applyOptions({visible:showTrdBB});
  if(tvTrdBBL) tvTrdBBL.applyOptions({visible:showTrdBB});
}
function toggleTrdRSI(btn){
  showTrdRSI=!showTrdRSI; btn.classList.toggle('active',showTrdRSI);
  buildTradingChart(PAIR_PRICES[currentTradePair]||1);
}

function setOrderSide(side){
  orderSide = side;
  const buyBtn = document.getElementById('otBuy'), sellBtn = document.getElementById('otSell');
  const submitBtn = document.getElementById('orderSubmitBtn'), submitText = document.getElementById('orderSubmitText');
  if(side==='buy'){
    buyBtn.classList.add('active'); sellBtn.classList.remove('active');
    submitBtn.className='order-submit-btn buy';
    submitText.textContent='▲ BUY / LONG';
  } else {
    sellBtn.classList.add('active'); buyBtn.classList.remove('active');
    submitBtn.className='order-submit-btn sell';
    submitText.textContent='▼ SELL / SHORT';
  }
  calcOrderSummary();
}

function setOrderType(type, btn){
  orderType = type;
  document.querySelectorAll('.order-type-btn').forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');
  const lpg = document.getElementById('limitPriceGroup');
  if(lpg) lpg.style.display = (type==='market') ? 'none' : 'block';
  calcOrderSummary();
}

function updateLeverage(val){
  val = parseInt(val);
  const slider = document.getElementById('leverageSlider');
  if(slider){ slider.value = val; slider.style.background=`linear-gradient(to right,var(--green) 0%,var(--green) ${val}%,var(--bg3) ${val}%,var(--bg3) 100%)`; }
  const lbl = document.getElementById('leverageVal');
  if(lbl) lbl.textContent = val+'×';
  const warn = document.getElementById('riskWarning'), msg = document.getElementById('riskMsg');
  if(warn && msg){
    if(val>=50){
      warn.style.display='flex';
      msg.textContent = val>=100 ? '🔥 Extreme risk! 100x leverage can liquidate instantly.' :
                        val>=75  ? '⚠️ Very high leverage. Use strict stop loss.' :
                                   '⚠️ High leverage ('+val+'×) increases risk significantly.';
    } else { warn.style.display='none'; }
  }
  calcOrderSummary();
}

function setTradePct(pct){
  if(!currentUser) return;
  const bal = dashMode==='demo' ? currentUser.demoBalance : currentUser.realBalance;
  const amt = (bal * pct/100).toFixed(2);
  const inp = document.getElementById('tradeAmt');
  if(inp){ inp.value = amt; calcOrderSummary(); }
}

function calcOrderSummary(){
  const price = PAIR_PRICES[currentTradePair] || 1;
  const amt = parseFloat(document.getElementById('tradeAmt')?.value)||0;
  const leverage = parseInt(document.getElementById('leverageSlider')?.value)||10;
  const tp = parseFloat(document.getElementById('takeProfit')?.value)||0;
  const sl = parseFloat(document.getElementById('stopLoss')?.value)||0;
  const position = amt * leverage;
  const margin = amt;
  const coins = position / price;
  const liqOffset = (1/leverage) * price * 0.9;
  const liqPrice = orderSide==='buy' ? price - liqOffset : price + liqOffset;
  const estProfit = tp ? Math.abs(tp-price)*coins : 0;
  const estLoss = sl ? Math.abs(price-sl)*coins : 0;

  const set = (id, val) => { const el=document.getElementById(id); if(el)el.textContent=val; };
  set('osEntry', amt>0 ? fmtPriceShort(price) : '—');
  set('osPosition', amt>0 ? '$'+position.toFixed(2) : '—');
  set('osMargin', amt>0 ? '$'+margin.toFixed(2) : '—');
  set('osProfit', tp && amt>0 ? '+$'+estProfit.toFixed(2) : '—');
  set('osLoss', sl && amt>0 ? '-$'+estLoss.toFixed(2) : '—');
  set('osLiq', amt>0 ? fmtPriceShort(liqPrice) : '—');
}

// ============================================================
// SUBMIT TRADE — Show Confirmation Modal
// ============================================================
function submitTrade(){
  if(!currentUser){ showToast('Please login to trade.','red'); return; }
  const amt = parseFloat(document.getElementById('tradeAmt')?.value)||0;
  if(amt < 1){ showToast('Minimum trade amount is $1.','red'); return; }
  const bal = dashMode==='demo' ? currentUser.demoBalance : currentUser.realBalance;
  if(amt > bal){ showToast('Insufficient balance. Please deposit.','red'); return; }
  const leverage = parseInt(document.getElementById('leverageSlider')?.value)||10;
  const price = PAIR_PRICES[currentTradePair] || 1;
  const position = amt * leverage;
  const tp = parseFloat(document.getElementById('takeProfit')?.value)||0;
  const sl = parseFloat(document.getElementById('stopLoss')?.value)||0;
  const liqOffset = (1/leverage) * price * 0.9;
  const liqPrice = orderSide==='buy' ? price - liqOffset : price + liqOffset;

  pendingTradeData = { pair:currentTradePair+'/USDT', side:orderSide, type:orderType,
    amt, leverage, price, position, tp, sl, liqPrice, mode:dashMode };

  const modal = document.getElementById('orderModal');
  const titleEl = document.getElementById('modalTitle');
  const rowsEl = document.getElementById('modalRows');
  const confirmBtn = document.getElementById('modalConfirmBtn');

  titleEl.innerHTML = (orderSide==='buy'?'<span style="color:var(--green)">▲ BUY / LONG</span>':'<span style="color:var(--red)">▼ SELL / SHORT</span>') + ' — ' + currentTradePair+'/USDT';
  rowsEl.innerHTML = `
    <div class="modal-row"><span>Mode</span><span style="color:var(--yellow)">${dashMode.toUpperCase()}</span></div>
    <div class="modal-row"><span>Order Type</span><span>${orderType.toUpperCase()}</span></div>
    <div class="modal-row"><span>Entry Price</span><span>${fmtPriceShort(price)}</span></div>
    <div class="modal-row"><span>Amount (Margin)</span><span>$${amt.toFixed(2)}</span></div>
    <div class="modal-row"><span>Leverage</span><span style="color:var(--yellow)">${leverage}×</span></div>
    <div class="modal-row"><span>Position Size</span><span>$${position.toFixed(2)}</span></div>
    ${tp ? `<div class="modal-row"><span>Take Profit</span><span style="color:var(--green)">${fmtPriceShort(tp)}</span></div>` : ''}
    ${sl ? `<div class="modal-row"><span>Stop Loss</span><span style="color:var(--red)">${fmtPriceShort(sl)}</span></div>` : ''}
    <div class="modal-row"><span>Liq. Price</span><span style="color:var(--yellow)">${fmtPriceShort(liqPrice)}</span></div>
  `;
  confirmBtn.className = 'btn-auth';
  confirmBtn.style.background = orderSide==='buy'?'var(--green)':'var(--red)';
  confirmBtn.style.color = '#000';
  confirmBtn.textContent = orderSide==='buy' ? '✅ Confirm Buy' : '✅ Confirm Sell';
  modal.style.display = 'flex';
}

function closeOrderModal(e){
  if(e.target === document.getElementById('orderModal')) document.getElementById('orderModal').style.display='none';
}

function confirmTrade(){
  if(!pendingTradeData || !currentUser) return;
  const t = pendingTradeData;
  document.getElementById('orderModal').style.display='none';

  // Deduct margin
  if(t.mode==='demo') currentUser.demoBalance -= t.amt;
  else currentUser.realBalance -= t.amt;

  // Add open position
  const pos = {
    id: Date.now(), pair:t.pair, side:t.side, amt:t.amt, leverage:t.leverage,
    entryPrice:t.price, tp:t.tp, sl:t.sl, liqPrice:t.liqPrice, mode:t.mode,
    openTime:Date.now(), pnl:0
  };
  currentUser.openPositions = currentUser.openPositions || [];
  currentUser.openPositions.push(pos);
  saveState();

  showFillNotification(t);
  addNotification(t.side==='buy'?'📈':'📉',
    `<strong>${t.pair}</strong> ${t.side.toUpperCase()} opened at ${fmtPriceShort(t.price)} · $${t.amt} · ${t.leverage}×`,
    t.side==='buy'?'rgba(0,230,118,0.15)':'rgba(255,61,87,0.15)');
  showToast(`✅ ${t.pair} ${t.side.toUpperCase()} position opened!`, t.side==='buy'?'green':'red');

  renderMyPositions();
  updateTradingPanel();
  updateDashboardData();

  // Auto-close simulation after 30-180s for demo
  if(t.mode==='demo'){
    const delay = (30 + Math.random()*150)*1000;
    setTimeout(()=>autoClosePosition(pos.id), delay);
  }
}

function autoClosePosition(id){
  if(!currentUser) return;
  currentUser.openPositions = currentUser.openPositions || [];
  const idx = currentUser.openPositions.findIndex(p=>p.id===id);
  if(idx===-1) return;
  const pos = currentUser.openPositions[idx];
  const closePrice = PAIR_PRICES[pos.pair.split('/')[0]] || pos.entryPrice;
  const dir = pos.side==='buy' ? 1 : -1;
  const priceDiff = (closePrice - pos.entryPrice) * dir;
  const coins = (pos.amt * pos.leverage) / pos.entryPrice;
  const rawPnl = priceDiff * coins;
  const pnl = parseFloat((rawPnl * (0.5+Math.random())).toFixed(2));
  const isWin = pnl > 0;

  // Update balances
  const returnAmt = pos.amt + pnl;
  if(pos.mode==='demo') currentUser.demoBalance = Math.max(0, currentUser.demoBalance + returnAmt);
  else currentUser.realBalance = Math.max(0, currentUser.realBalance + returnAmt);
  currentUser.profit = (currentUser.profit||0) + pnl;

  // Record trade
  currentUser.trades = currentUser.trades || [];
  currentUser.trades.unshift({
    result: isWin?'win':'loss', pair:pos.pair, side:pos.side, amt:pos.amt,
    leverage:pos.leverage, entryPrice:pos.entryPrice, closePrice,
    pnl, date:new Date().toLocaleString(), mode:pos.mode
  });

  // Add balance history point
  const bal = pos.mode==='demo' ? currentUser.demoBalance : currentUser.realBalance;
  currentUser.balanceHistory = currentUser.balanceHistory || [];
  currentUser.balanceHistory.push({t:Date.now(), v:bal});

  // Remove position
  currentUser.openPositions.splice(idx, 1);
  saveState();

  addNotification(isWin?'✅':'❌',
    `<strong>${pos.pair}</strong> closed ${isWin?'+':''}$${pnl.toFixed(2)} · ${isWin?'WIN 🎉':'LOSS'}`,
    isWin?'rgba(0,230,118,0.15)':'rgba(255,61,87,0.15)');
  showToast(`${isWin?'🎉 WIN':'😔 LOSS'}: ${pos.pair} closed ${isWin?'+':''}$${pnl.toFixed(2)}`, isWin?'green':'red', 5000);

  renderMyPositions();
  updateDashboardData();
}

function closePositionManually(id){
  autoClosePosition(id);
}

function showFillNotification(t){
  const el = document.getElementById('fillNotif');
  el.style.display='flex';
  el.style.borderLeft = '3px solid '+(t.side==='buy'?'var(--green)':'var(--red)');
  el.innerHTML=`<div class="fill-icon">${t.side==='buy'?'📈':'📉'}</div><div><div class="fill-text" style="color:${t.side==='buy'?'var(--green)':'var(--red)'}">Order Filled — ${t.pair}</div><div class="fill-sub">${t.side.toUpperCase()} · $${t.amt} · ${t.leverage}× · ${t.type.toUpperCase()}</div></div>`;
  clearTimeout(el._t);
  el._t = setTimeout(()=>el.style.display='none', 4000);
}

function renderMyPositions(){
  if(!currentUser) return;
  const list = document.getElementById('myPositionsList');
  const cnt = document.getElementById('myPosCount');
  const positions = currentUser.openPositions || [];
  if(cnt) cnt.textContent = positions.length;
  if(!list) return;
  if(!positions.length){
    list.innerHTML='<div style="padding:16px;text-align:center;font-size:11px;color:var(--text3);">No open positions</div>';
    return;
  }
  list.innerHTML = positions.map(pos=>{
    const curPrice = PAIR_PRICES[pos.pair.split('/')[0]] || pos.entryPrice;
    const dir = pos.side==='buy'?1:-1;
    const coins = (pos.amt*pos.leverage)/pos.entryPrice;
    const pnl = (curPrice-pos.entryPrice)*dir*coins;
    const pnlSign = pnl>=0?'+':'';
    return `<div class="my-pos-row">
      <div class="mpr-top">
        <span class="mpr-pair">${pos.pair}</span>
        <span class="mpr-pnl" style="color:${pnl>=0?'var(--green)':'var(--red)'}">${pnlSign}$${pnl.toFixed(2)}</span>
      </div>
      <div class="mpr-stats">
        <span>${pos.side.toUpperCase()} ${pos.leverage}×</span>
        <span>$${pos.amt}</span>
        <span>@ ${fmtPriceShort(pos.entryPrice)}</span>
      </div>
      <button class="mpr-close" onclick="closePositionManually(${pos.id})">✕ Close</button>
    </div>`;
  }).join('');
}

function updateMyPositionsPnL(){
  if(!currentUser || !currentUser.openPositions) return;
  renderMyPositions();
}

function renderMiniHistory(){
  if(!currentUser) return;
  const list = document.getElementById('miniHistoryList');
  if(!list) return;
  const trades = (currentUser.trades||[]).slice(0,8);
  if(!trades.length){ list.innerHTML='<div style="padding:16px;text-align:center;font-size:11px;color:var(--text3);">No trades yet</div>';return; }
  list.innerHTML = trades.map(t=>`
    <div style="display:grid;grid-template-columns:auto 1fr auto;gap:6px;align-items:center;padding:6px 10px;border-bottom:1px solid var(--border);font-size:11px;">
      <span style="padding:2px 6px;border-radius:3px;font-size:9px;font-weight:700;background:${t.result==='win'?'var(--green3)':'var(--red2)'};color:${t.result==='win'?'var(--green)':'var(--red)'};">${t.result==='win'?'WIN':'LOSS'}</span>
      <span style="font-family:var(--font-display);font-weight:700;">${t.pair}</span>
      <span style="font-family:var(--font-mono);font-weight:700;color:${t.pnl>=0?'var(--green)':'var(--red)'};">${t.pnl>=0?'+':''}$${t.pnl.toFixed(2)}</span>
    </div>`).join('');
}

// ============================================================
// DASHBOARD
// ============================================================
function initDashboard(){
  if(!currentUser){ showLayer('loginLayer'); return; }
  buildTickers();
  updateDashboardData();
  buildMSnap();

  // Referral link
  const refLink = `${window.location.origin}${window.location.pathname}?ref=${currentUser.refCode}&name=${encodeURIComponent(currentUser.name)}`;
  const srl = document.getElementById('sideRefLink');
  if(srl) srl.textContent = refLink;
  const ducName = document.getElementById('duchName');
  if(ducName) ducName.textContent = currentUser.name.split(' ')[0];

  drawPerfChart();
  drawAllocChart();
  renderRecentTrades();
  renderOpenPositions();
  switchMode(dashMode);

  // Simulate bots earning in background
  setInterval(()=>{
    if(!currentUser) return;
    Object.keys(botsState).forEach(botId=>{
      if(botsState[botId]){
        const earn = (Math.random()*2.5+0.1);
        if(dashMode==='demo') currentUser.demoBalance+=earn;
        else currentUser.realBalance+=earn;
        currentUser.profit=(currentUser.profit||0)+earn;
        const bal = dashMode==='demo'?currentUser.demoBalance:currentUser.realBalance;
        currentUser.balanceHistory=currentUser.balanceHistory||[];
        currentUser.balanceHistory.push({t:Date.now(),v:bal});
        saveState();
        updateDashboardData();
      }
    });
  }, 8000);
}

function updateDashboardData(){
  if(!currentUser) return;
  const isDemo = dashMode==='demo';
  const bal = isDemo ? currentUser.demoBalance : currentUser.realBalance;
  const profit = currentUser.profit || 0;
  const deposits = currentUser.deposits || 0;
  const trades = currentUser.trades || [];
  const wins = trades.filter(t=>t.result==='win').length;
  const winRate = trades.length ? (wins/trades.length*100).toFixed(1)+'%' : '—';
  const chgPct = bal>0&&deposits>0 ? ((bal-deposits)/deposits*100).toFixed(2) : profit>0?(profit/25*100).toFixed(2):'0.00';

  const set=(id,v)=>{const el=document.getElementById(id);if(el)el.textContent=v;};
  set('sblAmount', '$'+bal.toFixed(2));
  set('bcAmount', '$'+bal.toFixed(2));
  set('bcProfit', (profit>=0?'+':'')+'$'+profit.toFixed(2));
  set('bcDeposits', '$'+deposits.toFixed(2));
  set('bcWinRate', winRate);
  const chgEl=document.getElementById('bcChange');
  if(chgEl){ chgEl.textContent=(parseFloat(chgPct)>=0?'+':'')+chgPct+'%'; chgEl.className='bc-change '+(parseFloat(chgPct)>=0?'up':'down'); }
  set('bcLabel', isDemo?'Demo Balance':'Real Balance');
  set('sblLabel', isDemo?'DEMO BALANCE':'REAL BALANCE');

  // History stats
  const totalPnl = trades.reduce((s,t)=>s+t.pnl,0);
  set('histTotalPnl', (totalPnl>=0?'+':'')+'$'+totalPnl.toFixed(2));
  set('histWinRate', winRate);
  set('histTotalTrades', trades.length);
  set('openPosCount', (currentUser.openPositions||[]).length+' Active');
  set('depositAvailBal', '$'+bal.toFixed(2)+' available');
  set('withdrawAvailBal', '$'+bal.toFixed(2)+' available');
}

function switchMode(mode){
  dashMode = mode;
  const isDemo = mode==='demo';
  document.getElementById('mtDemo')?.classList.toggle('active', isDemo);
  document.getElementById('mtReal')?.classList.toggle('active', !isDemo);
  saveState();
  updateDashboardData();
  drawPerfChart();
  drawAllocChart();
}

// ============================================================
// PERFORMANCE CHART (Dashboard)
// ============================================================
function drawPerfChart(){
  const canvas = document.getElementById('perfCanvas');
  if(!canvas||!currentUser) return;
  const ctx = canvas.getContext('2d');
  canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight;
  const W=canvas.width, H=canvas.height;
  ctx.clearRect(0,0,W,H);

  const history = currentUser.balanceHistory||[{t:Date.now()-86400000,v:25},{t:Date.now(),v:currentUser.demoBalance}];
  const days = perfPeriod==='7d'?7:perfPeriod==='30d'?30:90;
  const cutoff = Date.now()-days*86400000;
  let pts = history.filter(p=>p.t>=cutoff);
  if(pts.length<2) pts=[{t:cutoff,v:25},{t:Date.now(),v:currentUser.demoBalance}];

  const vals=pts.map(p=>p.v);
  const minV=Math.min(...vals)*0.99, maxV=Math.max(...vals)*1.01;
  const range=maxV-minV||1;

  const grad=ctx.createLinearGradient(0,0,0,H);
  grad.addColorStop(0,'rgba(0,230,118,0.25)');
  grad.addColorStop(1,'rgba(0,230,118,0)');

  ctx.beginPath();
  pts.forEach((p,i)=>{
    const x=(i/(pts.length-1))*W;
    const y=H-((p.v-minV)/range)*(H-20)-10;
    i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
  });
  const lastX=W, lastY=H-((pts[pts.length-1].v-minV)/range)*(H-20)-10;
  ctx.strokeStyle='#00E676'; ctx.lineWidth=2; ctx.stroke();
  ctx.lineTo(lastX,H); ctx.lineTo(0,H); ctx.closePath();
  ctx.fillStyle=grad; ctx.fill();

  // Footer stats
  const first=vals[0],last=vals[vals.length-1];
  const ret=((last-first)/first*100);
  const dailyRets=vals.slice(1).map((v,i)=>(v-vals[i])/vals[i]*100);
  const best=dailyRets.length?Math.max(...dailyRets):0;
  const worst=dailyRets.length?Math.min(...dailyRets):0;
  const set=(id,v)=>{const el=document.getElementById(id);if(el)el.textContent=v;};
  set('pfReturn',(ret>=0?'+':'')+ret.toFixed(2)+'%');
  set('pfBest','+'+best.toFixed(2)+'%');
  set('pfWorst',worst.toFixed(2)+'%');
}

function setPerfPeriod(p,btn){
  perfPeriod=p;
  document.querySelectorAll('.dc-tabs .dc-tab').forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');
  drawPerfChart();
}

// ============================================================
// ALLOCATION DONUT CHART
// ============================================================
function drawAllocChart(){
  const canvas=document.getElementById('allocCanvas');
  if(!canvas||!currentUser) return;
  const ctx=canvas.getContext('2d');
  canvas.width=canvas.offsetWidth;canvas.height=canvas.offsetHeight;
  const W=canvas.width,H=canvas.height;
  const cx=W/2,cy=H/2,r=Math.min(W,H)/2-8,inner=r*0.6;
  ctx.clearRect(0,0,W,H);

  const allocs=[
    {name:'BTC',pct:42,color:'#F7931A'},
    {name:'ETH',pct:28,color:'#627EEA'},
    {name:'SOL',pct:15,color:'#9945FF'},
    {name:'BNB',pct:10,color:'#F0B90B'},
    {name:'Other',pct:5,color:'#4A5568'},
  ];
  let start=-Math.PI/2;
  allocs.forEach(a=>{
    const end=start+(a.pct/100)*Math.PI*2;
    ctx.beginPath();ctx.moveTo(cx,cy);ctx.arc(cx,cy,r,start,end);ctx.closePath();
    ctx.fillStyle=a.color;ctx.fill();
    start=end;
  });
  // inner hole
  ctx.beginPath();ctx.arc(cx,cy,inner,0,Math.PI*2);ctx.fillStyle='#0C0F18';ctx.fill();

  const bal=currentUser.demoBalance||0;
  const amtEl=document.getElementById('acAmount');
  if(amtEl) amtEl.textContent='$'+bal.toFixed(0);

  const legend=document.getElementById('allocLegend');
  if(legend) legend.innerHTML=allocs.map(a=>`
    <div class="al-row"><div class="al-dot" style="background:${a.color}"></div><span class="al-name">${a.name}</span><span class="al-pct">${a.pct}%</span></div>`).join('');
}

// ============================================================
// OPEN POSITIONS & RECENT TRADES (Dashboard)
// ============================================================
function renderOpenPositions(){
  if(!currentUser) return;
  const positions=currentUser.openPositions||[];
  const cnt=document.getElementById('openPosCount');
  if(cnt) cnt.textContent=positions.length+' Active';
  const con=document.getElementById('openPositionsContainer');
  if(!con) return;
  if(!positions.length){
    con.innerHTML=`<div class="empty-state"><div style="font-size:40px;margin-bottom:8px;">📊</div><div style="font-weight:600;color:var(--text2);">No open positions</div><div style="font-size:12px;color:var(--text3);margin-top:4px;">Start trading to see live P&L here</div><button class="btn btn-green" style="margin-top:16px;" onclick="showLayer('tradingLayer')">Open Trade →</button></div>`;
    return;
  }
  con.innerHTML=positions.map(pos=>{
    const curPrice=PAIR_PRICES[pos.pair.split('/')[0]]||pos.entryPrice;
    const dir=pos.side==='buy'?1:-1;
    const coins=(pos.amt*pos.leverage)/pos.entryPrice;
    const pnl=(curPrice-pos.entryPrice)*dir*coins;
    const pnlSign=pnl>=0?'+':'';
    const pnlPct=((pnl/pos.amt)*100).toFixed(2);
    return `<div class="position-row">
      <div class="pr-top">
        <span class="pr-pair">${pos.pair}</span>
        <span class="pr-type ${pos.side==='buy'?'long':'short'}">${pos.side.toUpperCase()}</span>
        <span class="pr-pnl" style="color:${pnl>=0?'var(--green)':'var(--red)'}">${pnlSign}$${pnl.toFixed(2)} (${pnlSign}${pnlPct}%)</span>
      </div>
      <div class="pr-stats">
        <div class="pr-stat"><span class="pr-stat-lbl">Entry</span><span class="pr-stat-val">${fmtPriceShort(pos.entryPrice)}</span></div>
        <div class="pr-stat"><span class="pr-stat-lbl">Current</span><span class="pr-stat-val">${fmtPriceShort(curPrice)}</span></div>
        <div class="pr-stat"><span class="pr-stat-lbl">Margin</span><span class="pr-stat-val">$${pos.amt}</span></div>
        <div class="pr-stat"><span class="pr-stat-lbl">Leverage</span><span class="pr-stat-val">${pos.leverage}×</span></div>
      </div>
      <button class="pr-close-btn" onclick="closePositionManually(${pos.id})">✕ Close Position</button>
    </div>`;
  }).join('');
}

function renderRecentTrades(){
  if(!currentUser) return;
  const trades=(currentUser.trades||[]).slice(0,6);
  const con=document.getElementById('recentTradesContainer');
  if(!con) return;
  if(!trades.length){con.innerHTML=`<div class="empty-state"><div style="font-size:36px;margin-bottom:8px;">📭</div><div style="font-size:13px;color:var(--text2);">No trades yet</div></div>`;return;}
  con.innerHTML=trades.map(t=>`
    <div class="rt-row">
      <span class="rt-type ${t.result==='win'?'win':'loss'}">${t.result.toUpperCase()}</span>
      <span class="rt-pair">${t.pair}</span>
      <span class="rt-pnl" style="color:${t.pnl>=0?'var(--green)':'var(--red)'}">${t.pnl>=0?'+':''}$${t.pnl.toFixed(2)}</span>
      <span class="rt-date">${t.date.split(',')[0]}</span>
    </div>`).join('');
}

function buildMSnap(){
  const list=document.getElementById('mSnapList');
  if(!list) return;
  list.innerHTML=COINS.slice(0,6).map(c=>{
    const isUp=c.chg>=0,sign=isUp?'+':'';
    return `<div class="ms-row" onclick="showLayer('chartsLayer')">
      <span class="ms-sym">${c.sym}</span>
      <span class="ms-price mono">${fmtPrice(c.price)}</span>
      <span class="ms-chg ${isUp?'nt-up':'nt-dn'}">${sign}${c.chg.toFixed(2)}%</span>
    </div>`;
  }).join('');
}

// ============================================================
// DEPOSIT
// ============================================================
function initDepositLayer(){
  if(!currentUser) return;
  const bal=dashMode==='demo'?currentUser.demoBalance:currentUser.realBalance;
  const el=document.getElementById('depositAvailBal');
  if(el) el.textContent='$'+bal.toFixed(2)+' available';
}

function selectDepMethod(btn, gridId){
  document.querySelectorAll('#'+gridId+' .dep-method-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  const method=btn.getAttribute('data-method');
  const depDetails=document.getElementById('depDetails');
  const mpesaGroup=document.getElementById('mpesaPhoneGroup');

  if(gridId==='depMethodGrid'){
    if(method==='mpesa'){
      if(depDetails) depDetails.innerHTML=`📱 <strong style="color:var(--text1)">M-Pesa Till Number:</strong> <strong style="color:var(--green);font-family:var(--font-mono)">${PAYMENT_CONFIG.MPESA.TILL_NUMBER}</strong><br>Business Name: <strong style="color:var(--text1)">${PAYMENT_CONFIG.MPESA.BUSINESS_NAME}</strong><br><span style="font-size:11px;color:var(--text3);">Or enter phone below to receive an STK Push prompt</span>`;
      if(mpesaGroup) mpesaGroup.style.display='block';
    } else if(method==='bank'){
      if(depDetails) depDetails.innerHTML=`🏦 <strong style="color:var(--text1)">Bank Name:</strong> ${PAYMENT_CONFIG.BANK.Name||'Equity Bank'}<br><strong style="color:var(--text1)">Account:</strong> <strong style="color:var(--green);font-family:var(--font-mono)">${PAYMENT_CONFIG.BANK.ACCOUNT}</strong><br><strong style="color:var(--text1)">Name:</strong> ${PAYMENT_CONFIG.BANK.ACCOUNT_NAME}`;
      if(mpesaGroup) mpesaGroup.style.display='none';
    } else if(method==='crypto'){
      if(depDetails) depDetails.innerHTML=`₿ <strong style="color:var(--text1)">BTC:</strong> <span style="font-family:var(--font-mono);color:var(--yellow);font-size:11px;">${PAYMENT_CONFIG.CRYPTO.BTC}</span><br>Ξ <strong style="color:var(--text1)">ETH:</strong> <span style="font-family:var(--font-mono);color:var(--blue);font-size:11px;">${PAYMENT_CONFIG.CRYPTO.ETH}</span><br>💵 <strong style="color:var(--text1)">USDT TRC-20:</strong> <span style="font-family:var(--font-mono);color:var(--green);font-size:11px;">${PAYMENT_CONFIG.CRYPTO['USDT-TRC20']}</span>`;
      if(mpesaGroup) mpesaGroup.style.display='none';
    }
  }
}

function calcDepBonus(){
  const amt=parseFloat(document.getElementById('depositAmt')?.value)||0;
  const line=document.getElementById('depBonusLine');
  const bonusAmt=document.getElementById('depBonusAmt');
  if(amt>0&&(currentUser.deposits||0)===0){
    if(line) line.style.display='flex';
    if(bonusAmt) bonusAmt.textContent='+$'+amt.toFixed(2);
  } else { if(line) line.style.display='none'; }
}

function submitDeposit(){
  if(!currentUser){ showToast('Please login first.','red'); return; }
  const amt=parseFloat(document.getElementById('depositAmt')?.value)||0;
  if(amt<10){ showToast('Minimum deposit is $10.','red'); return; }

  const btn=document.getElementById('depositBtn');
  btn.disabled=true; btn.textContent='⟳ Processing…';

  const box=document.getElementById('depStatusBox');
  if(box){ box.style.display='block'; box.style.background='rgba(255,215,64,0.1)'; box.style.border='1px solid rgba(255,215,64,0.3)'; box.style.color='var(--yellow)'; box.textContent='⏳ Processing deposit… Please make payment to the details above.'; }

  // Send admin email notification
  const isFirst = (currentUser.deposits||0)===0;
  const bonus = isFirst ? amt : 0;
  const totalCredit = amt + bonus;

  const emailParams = {
    to_email: 'felixkoskey278@gmail.com',
    to_name: 'Admin',
    subject: `💰 NEW DEPOSIT — ${currentUser.name}`,
    message: `
NEW DEPOSIT NOTIFICATION — CryptoPro

User: ${currentUser.name}
Email: ${currentUser.email}
Phone: ${currentUser.phone}
Amount: $${amt.toFixed(2)}
Bonus: $${bonus.toFixed(2)} (${isFirst?'First deposit 100% match':'None'})
Total Credit: $${totalCredit.toFixed(2)}
Mode: ${dashMode.toUpperCase()}
Time: ${new Date().toLocaleString()}
Referral Code: ${currentUser.refCode}

Please verify payment and approve.
    `.trim()
  };

  try{
    emailjs.send(PAYMENT_CONFIG.EMAILJS.SERVICE_ID, PAYMENT_CONFIG.EMAILJS.TEMPLATE_ID, emailParams);
  }catch(e){}

  // Also try WhatsApp link (opens on admin's device if clicked)
  const waMsg = encodeURIComponent(`💰 NEW DEPOSIT\nUser: ${currentUser.name}\nEmail: ${currentUser.email}\nPhone: ${currentUser.phone}\nAmount: $${amt.toFixed(2)}\nBonus: $${bonus.toFixed(2)}\nTime: ${new Date().toLocaleString()}`);
  // Store for admin reference
  console.log(`WhatsApp notify: https://wa.me/${PAYMENT_CONFIG.MPESA.PHONE}?text=${waMsg}`);

  setTimeout(()=>{
    // Credit balance
    const credit = totalCredit;
    if(dashMode==='demo') currentUser.demoBalance += credit;
    else currentUser.realBalance += credit;
    currentUser.deposits = (currentUser.deposits||0) + amt;
    currentUser.balanceHistory = currentUser.balanceHistory||[];
    currentUser.balanceHistory.push({t:Date.now(), v:dashMode==='demo'?currentUser.demoBalance:currentUser.realBalance});
    saveState();

    if(box){ box.style.background='rgba(0,230,118,0.1)'; box.style.border='1px solid rgba(0,230,118,0.3)'; box.style.color='var(--green)'; box.textContent=`✅ Deposit of $${amt.toFixed(2)}${bonus>0?' + $'+bonus.toFixed(2)+' bonus':''} credited! Total: $${credit.toFixed(2)}`; }
    btn.disabled=false; btn.textContent='💰 Deposit Now';
    addNotification('💰',`Deposit of $${amt.toFixed(2)} credited successfully!`,'rgba(0,230,118,0.2)');
    showToast(`✅ $${credit.toFixed(2)} credited to your account!${bonus>0?' (includes $'+bonus.toFixed(2)+' welcome bonus!)':''}`, 'green', 6000);
    updateDashboardData();
    document.getElementById('depositAmt').value='';
    document.getElementById('depBonusLine').style.display='none';
  }, 3500);
}

// ============================================================
// WITHDRAW
// ============================================================
function initWithdrawLayer(){
  if(!currentUser) return;
  const bal=dashMode==='demo'?currentUser.demoBalance:currentUser.realBalance;
  const el=document.getElementById('withdrawAvailBal');
  if(el) el.textContent='$'+bal.toFixed(2)+' available';
}

function calcWithdrawFee(){
  const amt=parseFloat(document.getElementById('withdrawAmt')?.value)||0;
  const box=document.getElementById('withdrawFeeBox');
  if(amt>0){
    if(box){ box.style.display='block';
      document.getElementById('wfAmt').textContent='$'+amt.toFixed(2);
      const fee=amt*0.02;
      document.getElementById('wfFee').textContent='-$'+fee.toFixed(2);
      document.getElementById('wfNet').textContent='$'+(amt-fee).toFixed(2);
    }
  } else { if(box)box.style.display='none'; }
}

function submitWithdraw(){
  if(!currentUser){ showToast('Please login first.','red'); return; }
  const amt=parseFloat(document.getElementById('withdrawAmt')?.value)||0;
  const account=document.getElementById('withdrawAccount')?.value.trim();
  if(amt<50){ showToast('Minimum withdrawal is $50.','red'); return; }
  if(!account){ showToast('Please enter your account/phone number.','red'); return; }
  const bal=dashMode==='demo'?currentUser.demoBalance:currentUser.realBalance;
  if(amt>bal){ showToast('Insufficient balance.','red'); return; }

  const btn=document.getElementById('withdrawBtn');
  btn.disabled=true; btn.textContent='⟳ Processing…';

  const fee=amt*0.02, net=amt-fee;
  const emailParams={
    to_email:'felixkoskey278@gmail.com',
    to_name:'Admin',
    subject:`💸 WITHDRAWAL REQUEST — ${currentUser.name}`,
    message:`
WITHDRAWAL REQUEST — CryptoPro

User: ${currentUser.name}
Email: ${currentUser.email}
Phone: ${currentUser.phone}
Amount Requested: $${amt.toFixed(2)}
Fee (2%): $${fee.toFixed(2)}
Net to Pay: $${net.toFixed(2)}
Account/Number: ${account}
Mode: ${dashMode.toUpperCase()}
Current Balance: $${bal.toFixed(2)}
Time: ${new Date().toLocaleString()}

Please process this withdrawal.
    `.trim()
  };

  try{
    emailjs.send(PAYMENT_CONFIG.EMAILJS.SERVICE_ID, PAYMENT_CONFIG.EMAILJS.TEMPLATE_ID, emailParams);
  }catch(e){}

  setTimeout(()=>{
    if(dashMode==='demo') currentUser.demoBalance-=amt;
    else currentUser.realBalance-=amt;
    currentUser.balanceHistory=currentUser.balanceHistory||[];
    currentUser.balanceHistory.push({t:Date.now(),v:dashMode==='demo'?currentUser.demoBalance:currentUser.realBalance});
    saveState();
    btn.disabled=false; btn.textContent='💸 Withdraw Now';
    addNotification('💸',`Withdrawal of $${net.toFixed(2)} submitted — processing in 5–30 min`,'rgba(68,138,255,0.2)');
    showToast(`✅ Withdrawal of $${net.toFixed(2)} submitted! Processing in 5–30 minutes.`,'green',5000);
    updateDashboardData();
    document.getElementById('withdrawAmt').value='';
    document.getElementById('withdrawAccount').value='';
    document.getElementById('withdrawFeeBox').style.display='none';
  },2000);
}

// ============================================================
// AI BOTS
// ============================================================
const BOTS_DATA=[
  {id:'scalper',name:'Scalper Pro',icon:'⚡',risk:'Low Risk',riskColor:'var(--green)',winRate:'87%',daily:'+3.2%',trades:'1,240',pairs:'BTC,ETH,SOL',desc:'High-frequency scalping bot. Executes 50-200 trades/day targeting small, consistent gains.',bg:'rgba(0,230,118,0.08)',border:'rgba(0,230,118,0.2)'},
  {id:'trend',name:'Trend Master',icon:'📈',risk:'Medium Risk',riskColor:'var(--yellow)',winRate:'82%',daily:'+2.8%',trades:'486',pairs:'BTC,ETH,BNB,ADA',desc:'Follows major market trends using EMA crossovers and MACD signals. Holds positions for hours.',bg:'rgba(255,215,64,0.05)',border:'rgba(255,215,64,0.2)'},
  {id:'grid',name:'Grid Trader',icon:'📊',risk:'Low Risk',riskColor:'var(--green)',winRate:'79%',daily:'+2.5%',trades:'3,200',pairs:'BTC,ETH',desc:'Places buy/sell grids within a price range. Profits from market oscillation automatically.',bg:'rgba(68,138,255,0.05)',border:'rgba(68,138,255,0.2)'},
  {id:'arb',name:'Arbitrage AI',icon:'🔄',risk:'Very Low Risk',riskColor:'var(--cyan)',winRate:'91%',daily:'+4.1%',trades:'890',pairs:'BTC,ETH,USDT',desc:'Exploits price differences across markets. Near-zero risk with consistent small profits.',bg:'rgba(0,229,255,0.05)',border:'rgba(0,229,255,0.2)'},
  {id:'dca',name:'DCA Bot',icon:'💎',risk:'Low Risk',riskColor:'var(--blue)',winRate:'76%',daily:'+1.8%',trades:'320',pairs:'BTC,ETH,SOL,DOT',desc:'Dollar Cost Averaging — buys regularly regardless of price. Best for long-term accumulation.',bg:'rgba(170,119,255,0.05)',border:'rgba(170,119,255,0.2)'},
  {id:'swing',name:'Swing Hunter',icon:'🎯',risk:'High Risk',riskColor:'var(--red)',winRate:'68%',daily:'+5.2%',trades:'124',pairs:'SOL,AVAX,MATIC',desc:'Captures large swing moves. Higher risk but potentially massive returns on breakouts.',bg:'rgba(255,61,87,0.05)',border:'rgba(255,61,87,0.2)'},
];

function buildBots(){
  const grid=document.getElementById('botsGrid');
  if(!grid) return;
  grid.innerHTML=BOTS_DATA.map(bot=>{
    const isOn=botsState[bot.id]||false;
    return `<div class="bot-card ${isOn?'active-bot':''}" id="botCard_${bot.id}" style="border-color:${isOn?bot.border:'var(--border)'}">
      <div class="bc-top">
        <div class="bc-icon" style="background:${bot.bg}">${bot.icon}</div>
        <div><div class="bc-name">${bot.name}</div><div class="bc-risk" style="color:${bot.riskColor}">${bot.risk}</div></div>
        <div class="bc-status ${isOn?'on':'off'}" id="botStatus_${bot.id}">${isOn?'● ON':'○ OFF'}</div>
      </div>
      <div class="bc-desc">${bot.desc}</div>
      <div class="bc-stats">
        <div class="bc-stat"><div class="bcs-val text-green">${bot.winRate}</div><div class="bcs-lbl">Win Rate</div></div>
        <div class="bc-stat"><div class="bcs-val text-green">${bot.daily}</div><div class="bcs-lbl">Daily Avg</div></div>
        <div class="bc-stat"><div class="bcs-val">${bot.trades}</div><div class="bcs-lbl">Trades</div></div>
        <div class="bc-stat"><div class="bcs-val text-blue">${dashMode==='demo'?'Demo':'Real'}</div><div class="bcs-lbl">Mode</div></div>
      </div>
      <div class="bc-pairs" style="color:var(--text3)">Pairs: ${bot.pairs}</div>
      <button class="bc-toggle-btn ${isOn?'stop':'start'}" id="botBtn_${bot.id}" onclick="toggleBot('${bot.id}')">${isOn?'⏹ Stop Bot':'▶ Start Bot'}</button>
      ${isOn?`<div class="bc-running"><div class="live-dot" style="margin-right:6px;"></div>Bot is running…</div>`:''}
    </div>`;
  }).join('');
  updateBotsCount();
}

function toggleBot(id){
  if(!currentUser){ showToast('Please login to use bots.','red'); return; }
  const isOn=botsState[id]||false;
  botsState[id]=!isOn;
  saveState();
  buildBots();
  const bot=BOTS_DATA.find(b=>b.id===id);
  if(!isOn){
    addNotification('🤖',`<strong>${bot.name}</strong> bot started in ${dashMode} mode`,'rgba(0,230,118,0.15)');
    showToast(`🤖 ${bot.name} started! Earning ${bot.daily} daily.`,'green');
  } else {
    showToast(`⏹ ${bot.name} stopped.`,'blue');
  }
  updateBotsCount();
}

function updateBotsCount(){
  const active=Object.values(botsState).filter(Boolean).length;
  const el=document.getElementById('botsActiveCount');
  if(el) el.textContent=active;
}

// ============================================================
// HISTORY
// ============================================================
function buildHistory(){
  if(!currentUser) return;
  const trades=currentUser.trades||[];
  const tbody=document.getElementById('historyTbody');
  if(!tbody) return;

  if(!trades.length){
    tbody.innerHTML=`<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text3);">No trade history yet. Start trading!</td></tr>`;
  } else {
    tbody.innerHTML=trades.map(t=>`
      <tr class="hist-row">
        <td><span style="padding:3px 8px;border-radius:4px;font-size:11px;font-weight:700;background:${t.result==='win'?'var(--green3)':'var(--red2)'};color:${t.result==='win'?'var(--green)':'var(--red)'};">${t.result.toUpperCase()}</span></td>
        <td style="font-weight:700;">${t.pair}</td>
        <td><span style="padding:2px 7px;border-radius:4px;font-size:11px;background:${t.side==='buy'?'var(--green3)':'var(--red2)'};color:${t.side==='buy'?'var(--green)':'var(--red)'};">${t.side.toUpperCase()}</span></td>
        <td class="mono">$${t.amt.toFixed(2)}</td>
        <td class="mono" style="color:var(--yellow)">${t.leverage}×</td>
        <td class="mono" style="color:${t.pnl>=0?'var(--green)':'var(--red)'};font-weight:700;">${t.pnl>=0?'+':''}$${t.pnl.toFixed(2)}</td>
        <td style="color:var(--text3);font-size:11px;">${t.date}</td>
      </tr>`).join('');
  }

  const totalPnl=trades.reduce((s,t)=>s+t.pnl,0);
  const wins=trades.filter(t=>t.result==='win').length;
  const winRate=trades.length?(wins/trades.length*100).toFixed(1)+'%':'—';
  document.getElementById('histTotalPnl').textContent=(totalPnl>=0?'+':'')+'$'+totalPnl.toFixed(2);
  document.getElementById('histTotalPnl').style.color=totalPnl>=0?'var(--green)':'var(--red)';
  document.getElementById('histWinRate').textContent=winRate;
  document.getElementById('histTotalTrades').textContent=trades.length;
}

// ============================================================
// REFERRAL
// ============================================================
function buildReferral(){
  if(!currentUser) return;
  const refLink=`${window.location.origin}${window.location.pathname}?ref=${currentUser.refCode}&name=${encodeURIComponent(currentUser.name)}`;
  const el=document.getElementById('refLinkDisplay');
  if(el) el.textContent=refLink;
  document.getElementById('refTotalEarned').textContent='$'+(currentUser.referralEarnings||0).toFixed(2);
  document.getElementById('refTotalCount').textContent=(currentUser.referrals||[]).length;

  const hist=document.getElementById('refHistoryList');
  if(hist){
    const refs=currentUser.referrals||[];
    if(!refs.length){ hist.innerHTML='<div class="empty-state"><div style="font-size:40px;margin-bottom:8px;">👥</div><div style="color:var(--text2);font-weight:600;">No referrals yet</div></div>';return;}
    hist.innerHTML=refs.map(r=>`
      <div class="ref-hist-row">
        <div style="width:36px;height:36px;border-radius:50%;background:var(--bg3);display:flex;align-items:center;justify-content:center;font-size:16px;">👤</div>
        <div style="flex:1"><div style="font-weight:700;font-size:13px;">${r.name}</div><div style="font-size:11px;color:var(--text3);">${r.date}</div></div>
        <div class="mono fw-bold text-green">+$${r.earned.toFixed(2)}</div>
      </div>`).join('');
  }
}

function copyRefLink(){
  if(!currentUser) return;
  const link=`${window.location.origin}${window.location.pathname}?ref=${currentUser.refCode}&name=${encodeURIComponent(currentUser.name)}`;
  navigator.clipboard.writeText(link).then(()=>showToast('✅ Referral link copied!','green')).catch(()=>showToast('Copy failed','red'));
}
function copySideRef(){copyRefLink();}

function shareRef(platform){
  if(!currentUser) return;
  const link=`${window.location.origin}${window.location.pathname}?ref=${currentUser.refCode}&name=${encodeURIComponent(currentUser.name)}`;
  const msg=encodeURIComponent(`🚀 Join me on CryptoPro and get a FREE $25 bonus! Trade crypto with AI bots. Use my link: ${link}`);
  const urls={whatsapp:`https://wa.me/?text=${msg}`,telegram:`https://t.me/share/url?url=${encodeURIComponent(link)}&text=${msg}`,twitter:`https://twitter.com/intent/tweet?text=${msg}`};
  window.open(urls[platform],'_blank');
}

// ============================================================
// PROFILE
// ============================================================
function buildProfile(){
  if(!currentUser) return;
  const set=(id,v)=>{const el=document.getElementById(id);if(el)el.value=v||'';};
  const setTxt=(id,v)=>{const el=document.getElementById(id);if(el)el.textContent=v||'—';};
  set('profName',currentUser.name);
  set('profEmail',currentUser.email);
  set('profPhone',currentUser.phone);
  setTxt('profDisplayName',currentUser.name);
  setTxt('profJoined',currentUser.joinDate);
  setTxt('profRefCode',currentUser.refCode);
}

function saveProfile(){
  if(!currentUser) return;
  currentUser.name=document.getElementById('profName')?.value||currentUser.name;
  currentUser.email=document.getElementById('profEmail')?.value||currentUser.email;
  currentUser.phone=document.getElementById('profPhone')?.value||currentUser.phone;
  saveState();
  showToast('✅ Profile updated successfully!','green');
  buildProfile();
}

// ============================================================
// SIGNALS LAYER
// ============================================================
function buildSignalsLayer(){
  allSignals = SIG_PAIRS.map(sym=>{
    const isBuy=Math.random()>0.45;
    const price=PAIR_PRICES[sym]||Math.random()*1000+1;
    const conf=Math.floor(Math.random()*35+60);
    const entry=price*(0.999+Math.random()*0.002);
    const tp=isBuy?price*(1+Math.random()*0.04+0.01):price*(1-Math.random()*0.04-0.01);
    const sl=isBuy?price*(1-Math.random()*0.02-0.005):price*(1+Math.random()*0.02+0.005);
    const rr=Math.abs(tp-entry)/Math.abs(sl-entry);
    const indicators=shuffleArr(SIG_INDICATORS).slice(0,3).map(n=>({name:n,signal:Math.random()>0.4?(isBuy?'Bullish':'Bearish'):'Neutral'}));
    const tf=['1m','5m','15m','1h','4h'][Math.floor(Math.random()*5)];
    return {sym,isBuy,price,conf,entry,tp,sl,rr,indicators,tf,strong:conf>=85};
  });

  const buyCount=allSignals.filter(s=>s.isBuy).length;
  const sellCount=allSignals.length-buyCount;
  const avgConf=(allSignals.reduce((s,a)=>s+a.conf,0)/allSignals.length).toFixed(0);
  const set=(id,v)=>{const el=document.getElementById(id);if(el)el.textContent=v;};
  set('sigBuyCount',buyCount); set('sigSellCount',sellCount); set('sigWinRate',avgConf+'%');

  renderSignals();
}

function filterSignals(f,btn){
  signalFilter=f;
  document.querySelectorAll('#signalsLayer .dc-tab').forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');
  renderSignals();
}

function renderSignals(){
  const grid=document.getElementById('signalsGrid');
  if(!grid) return;
  let sigs=[...allSignals];
  if(signalFilter==='buy') sigs=sigs.filter(s=>s.isBuy);
  else if(signalFilter==='sell') sigs=sigs.filter(s=>!s.isBuy);
  else if(signalFilter==='strong') sigs=sigs.filter(s=>s.strong);

  grid.innerHTML=sigs.map(s=>`
    <div class="signal-card ${s.isBuy?'buy-sig':'sell-sig'}">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
        <div style="font-family:var(--font-display);font-size:16px;font-weight:800;">${s.sym}/USDT <span style="font-size:11px;color:var(--text3);font-weight:400;">· ${s.tf}</span></div>
        <div class="sig-direction ${s.isBuy?'buy':'sell'}">${s.isBuy?'▲ BUY':'▼ SELL'}</div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:12px;">
        <div class="sig-stat"><div class="sig-stat-lbl">Entry</div><div class="sig-stat-val">${fmtPriceShort(s.entry)}</div></div>
        <div class="sig-stat"><div class="sig-stat-lbl">Take Profit</div><div class="sig-stat-val text-green">${fmtPriceShort(s.tp)}</div></div>
        <div class="sig-stat"><div class="sig-stat-lbl">Stop Loss</div><div class="sig-stat-val text-red">${fmtPriceShort(s.sl)}</div></div>
      </div>
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
        <span style="font-size:11px;color:var(--text3);">Confidence</span>
        <div class="conf-bar"><div class="conf-fill" style="width:${s.conf}%;background:${s.conf>=80?'var(--green)':s.conf>=65?'var(--yellow)':'var(--red)'}"></div></div>
        <span style="font-family:var(--font-mono);font-size:12px;font-weight:700;color:${s.conf>=80?'var(--green)':s.conf>=65?'var(--yellow)':'var(--red)'}">${s.conf}%</span>
      </div>
      <div style="display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap;">
        ${s.indicators.map(i=>`<span class="ind-tag ${i.signal==='Bullish'?'ind-bull':i.signal==='Bearish'?'ind-bear':'ind-neutral'}">${i.name}: ${i.signal}</span>`).join('')}
      </div>
      <div style="display:flex;align-items:center;justify-content:space-between;font-size:11px;color:var(--text3);">
        <span>R:R = <strong style="color:var(--text1)">${s.rr.toFixed(2)}</strong></span>
        ${s.strong?'<span style="color:var(--yellow);font-weight:800;">🔥 STRONG SIGNAL</span>':''}
      </div>
      <button class="order-submit-btn ${s.isBuy?'buy':'sell'}" style="margin-top:12px;padding:9px;font-size:12px;border-radius:var(--r-md);" onclick="showLayer('tradingLayer')">Trade This Signal →</button>
    </div>`).join('');
}

function startSigCountdown(){
  clearInterval(sigRefreshInterval);
  sigCountdown=60;
  sigRefreshInterval=setInterval(()=>{
    sigCountdown--;
    const el=document.getElementById('sigRefreshTimer');
    if(el) el.textContent=sigCountdown;
    if(sigCountdown<=0){ buildSignalsLayer(); sigCountdown=60; }
  },1000);
}

// ============================================================
// ANALYSIS LAYER
// ============================================================
function buildAnalysisLayer(){
  drawFearGauge();
  drawDominanceChart();
  buildTrendSummary();
  buildHeatmap();
  buildNewsFeed();
}

function drawFearGauge(){
  const canvas=document.getElementById('fearGaugeCanvas');
  if(!canvas) return;
  canvas.width=canvas.offsetWidth||180; canvas.height=canvas.offsetHeight||90;
  const ctx=canvas.getContext('2d');
  const W=canvas.width,H=canvas.height;
  ctx.clearRect(0,0,W,H);
  const cx=W/2,cy=H,r=Math.min(W/2,H)-10;
  // background arc
  ctx.beginPath();ctx.arc(cx,cy,r,Math.PI,0);ctx.strokeStyle='var(--bg3)';ctx.lineWidth=14;ctx.stroke();
  // colored arc
  const val=72,pct=val/100;
  const grad=ctx.createLinearGradient(0,0,W,0);
  grad.addColorStop(0,'#00E676');grad.addColorStop(0.5,'#FFD740');grad.addColorStop(1,'#FF3D57');
  ctx.beginPath();ctx.arc(cx,cy,r,Math.PI,Math.PI+pct*Math.PI);
  ctx.strokeStyle=grad;ctx.lineWidth=14;ctx.stroke();
  document.getElementById('fearValue').textContent=val;
  document.getElementById('fearLabel').textContent=val>=75?'Extreme Greed':val>=55?'Greed':val>=45?'Neutral':val>=25?'Fear':'Extreme Fear';
}

function drawDominanceChart(){
  const canvas=document.getElementById('dominanceCanvas');
  if(!canvas) return;
  canvas.width=canvas.offsetWidth||140;canvas.height=canvas.offsetHeight||140;
  const ctx=canvas.getContext('2d');
  const W=canvas.width,H=canvas.height,cx=W/2,cy=H/2,r=Math.min(W,H)/2-6;
  ctx.clearRect(0,0,W,H);
  const slices=[{name:'BTC',pct:54.2,color:'#F7931A'},{name:'ETH',pct:17.1,color:'#627EEA'},{name:'BNB',pct:3.4,color:'#F0B90B'},{name:'Others',pct:25.3,color:'#4A5568'}];
  let start=-Math.PI/2;
  slices.forEach(s=>{
    const end=start+(s.pct/100)*Math.PI*2;
    ctx.beginPath();ctx.moveTo(cx,cy);ctx.arc(cx,cy,r,start,end);ctx.closePath();
    ctx.fillStyle=s.color;ctx.fill();start=end;
  });
  ctx.beginPath();ctx.arc(cx,cy,r*0.6,0,Math.PI*2);ctx.fillStyle='#06080D';ctx.fill();
  const legend=document.getElementById('dominanceLegend');
  if(legend) legend.innerHTML=slices.map(s=>`<div style="display:flex;align-items:center;gap:6px;font-size:11px;"><div style="width:8px;height:8px;border-radius:50%;background:${s.color};flex-shrink:0;"></div><span style="color:var(--text2)">${s.name}</span><span style="margin-left:auto;font-family:var(--font-mono);font-weight:700;">${s.pct}%</span></div>`).join('');
}

function buildTrendSummary(){
  const el=document.getElementById('trendSummary');
  if(!el) return;
  const items=[
    {label:'BTC Trend',value:'Bullish',color:'var(--green)',icon:'📈'},
    {label:'Market Sentiment',value:'Greed',color:'var(--yellow)',icon:'😤'},
    {label:'Volatility',value:'Medium',color:'var(--blue)',icon:'🌊'},
    {label:'Volume 24h',value:'High',color:'var(--green)',icon:'📊'},
    {label:'Altcoin Season',value:'Active',color:'var(--purple)',icon:'🚀'},
  ];
  el.innerHTML=items.map(i=>`<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:13px;"><span style="color:var(--text2);">${i.icon} ${i.label}</span><span style="font-weight:700;color:${i.color}">${i.value}</span></div>`).join('');
}

function buildHeatmap(){
  const el=document.getElementById('marketHeatmap');
  if(!el) return;
  el.innerHTML=COINS.map(c=>{
    const isUp=c.chg>=0;
    const intensity=Math.min(Math.abs(c.chg)/10,1);
    const bg=isUp?`rgba(0,230,118,${0.15+intensity*0.4})`:`rgba(255,61,87,${0.15+intensity*0.4})`;
    return `<div class="hm-cell" style="background:${bg};" onclick="showLayer('chartsLayer')"><div class="hm-sym">${c.sym.split('/')[0]}</div><div class="hm-chg" style="color:${isUp?'var(--green)':'var(--red)'}">${isUp?'+':''}${c.chg.toFixed(2)}%</div></div>`;
  }).join('');
}

function buildNewsFeed(){
  const el=document.getElementById('newsFeed');
  if(!el) return;
  const headlines=[
    {title:'Bitcoin breaks $98K as institutional demand surges',sentiment:'bullish',src:'CoinDesk',time:'2h ago'},
    {title:'Ethereum ETF inflows hit record $500M this week',sentiment:'bullish',src:'Bloomberg',time:'3h ago'},
    {title:'Fed signals no rate cuts until Q3 2025',sentiment:'bearish',src:'Reuters',time:'4h ago'},
    {title:'Solana DeFi TVL reaches all-time high of $15B',sentiment:'bullish',src:'DeFiPulse',time:'5h ago'},
    {title:'Crypto market cap crosses $3.5 trillion',sentiment:'bullish',src:'CoinMarketCap',time:'6h ago'},
    {title:'SEC approves new crypto trading rules',sentiment:'neutral',src:'WSJ',time:'8h ago'},
  ];
  document.getElementById('newsCount').textContent=headlines.length+' headlines';
  el.innerHTML=headlines.map(h=>`
    <div class="news-item">
      <div style="width:44px;height:44px;border-radius:var(--r-md);background:${h.sentiment==='bullish'?'var(--green3)':h.sentiment==='bearish'?'var(--red2)':'var(--bg3)'};display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;">${h.sentiment==='bullish'?'📈':h.sentiment==='bearish'?'📉':'📰'}</div>
      <div style="flex:1;"><div style="font-size:13px;font-weight:600;margin-bottom:4px;">${h.title}</div>
      <div style="display:flex;gap:10px;font-size:11px;color:var(--text3);"><span>${h.src}</span><span>${h.time}</span><span style="color:${h.sentiment==='bullish'?'var(--green)':h.sentiment==='bearish'?'var(--red)':'var(--text3)'};font-weight:700;">${h.sentiment.toUpperCase()}</span></div></div>
    </div>`).join('');
}

// ============================================================
// RECOMMENDATIONS LAYER
// ============================================================
function buildRecommendLayer(){
  if(!currentUser) return;
  const trades=currentUser.trades||[];
  const deposits=currentUser.deposits||0;
  const bal=currentUser.demoBalance||25;
  const riskScore=Math.min(100,Math.floor(deposits/10*10+trades.length*2+Object.values(botsState).filter(Boolean).length*15));

  document.getElementById('riskFillBar').style.width=riskScore+'%';
  const badge=document.getElementById('riskProfileBadge');
  if(badge) badge.textContent=riskScore<30?'Conservative':riskScore<60?'Moderate':'Aggressive';

  const grid=document.getElementById('riskProfileGrid');
  if(grid) grid.innerHTML=[
    {label:'Trades',val:trades.length,icon:'⚡'},
    {label:'Deposits',val:'$'+deposits.toFixed(0),icon:'💰'},
    {label:'Active Bots',val:Object.values(botsState).filter(Boolean).length,icon:'🤖'},
    {label:'Balance',val:'$'+bal.toFixed(0),icon:'💎'},
  ].map(i=>`<div style="background:var(--bg2);border-radius:var(--r-md);padding:12px;text-align:center;"><div style="font-size:20px;margin-bottom:4px">${i.icon}</div><div style="font-family:var(--font-mono);font-weight:700;font-size:16px">${i.val}</div><div style="font-size:10px;color:var(--text3);text-transform:uppercase">${i.label}</div></div>`).join('');

  const recs=document.getElementById('actionRecs');
  if(recs) recs.innerHTML=[
    {icon:'💰',title:'Make your first real deposit',desc:'Unlock real profits. Start with as little as $10.',priority:'high',priCol:'var(--red)',bg:'rgba(255,61,87,0.08)',action:()=>showLayer('depositLayer')},
    {icon:'🤖',title:'Activate an AI bot',desc:'Let bots earn for you 24/7 while you sleep.',priority:'med',priCol:'var(--yellow)',bg:'rgba(255,215,64,0.06)',action:()=>showLayer('botsLayer')},
    {icon:'🎁',title:'Invite friends & earn 10%',desc:'Lifetime commissions on every deposit they make.',priority:'low',priCol:'var(--green)',bg:'rgba(0,230,118,0.06)',action:()=>showLayer('referralLayer')},
  ].map((r,i)=>`<div class="rec-action-card" onclick="(${r.action.toString()})()">
    <div class="rec-action-icon" style="background:${r.bg}">${r.icon}</div>
    <div style="flex:1"><div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;"><span style="font-weight:700;font-size:14px">${r.title}</span><span class="rec-priority ${r.priority}" style="color:${r.priCol}">${r.priority.toUpperCase()}</span></div><div style="font-size:12px;color:var(--text2)">${r.desc}</div></div>
    <span style="color:var(--text3);font-size:16px">›</span>
  </div>`).join('');

  const sugBots=document.getElementById('suggestedBots');
  if(sugBots) sugBots.innerHTML=BOTS_DATA.slice(0,3).map(b=>`
    <div class="bot-suggest-row">
      <div style="width:40px;height:40px;border-radius:var(--r-md);background:rgba(0,230,118,0.08);display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0">${b.icon}</div>
      <div style="flex:1"><div style="font-weight:700;font-size:13px">${b.name}</div><div style="font-size:11px;color:var(--text3)">${b.daily} avg · ${b.winRate} win rate · ${b.risk}</div></div>
      <button class="btn btn-green" style="font-size:12px;padding:6px 14px" onclick="showLayer('botsLayer')">${botsState[b.id]?'Running ✓':'Start'}</button>
    </div>`).join('');

  const learnPath=document.getElementById('learningPath');
  const steps=['Understand leverage & margin','Place your first demo trade','Activate an AI bot','Make your first deposit','Withdraw your first profit'];
  const completed=Math.min(steps.length,Math.floor(riskScore/20));
  if(learnPath) learnPath.innerHTML=steps.map((s,i)=>`
    <div class="learn-step">
      <div class="learn-step-num" style="background:${i<completed?'var(--green)':'var(--bg3)'};color:${i<completed?'#000':'var(--text3)'}">${i<completed?'✓':i+1}</div>
      <div style="flex:1;font-size:13px;color:${i<completed?'var(--text1)':'var(--text2)'}">${s}</div>
      ${i<completed?'<span style="color:var(--green);font-size:12px">✅ Done</span>':''}
    </div>`).join('');
  document.getElementById('learnProgress').textContent=Math.round(completed/steps.length*100)+'% complete';
}

// ============================================================
// LIVE TRADERS — Fully Dynamic, Never Repeating
// ============================================================
let dynamicTraderPool=[];
let traderPoolIndex=0;

function initDynamicTraderPool(){
  // Generate 500 unique traders using seeded combinations
  dynamicTraderPool=[];
  const fns=FIRST_NAMES, lns=LAST_NAMES;
  let fi=0,li=0;
  while(dynamicTraderPool.length<500){
    const fn=fns[fi%fns.length], ln=lns[(li+Math.floor(fi/fns.length))%lns.length];
    fi++;li++;
    const country=COUNTRIES[dynamicTraderPool.length%COUNTRIES.length];
    const emoji=TRADER_EMOJIS[dynamicTraderPool.length%TRADER_EMOJIS.length];
    const profit=(Math.random()*4800+20).toFixed(2);
    const pair=TRADE_TYPES[dynamicTraderPool.length%TRADE_TYPES.length];
    const leverage=[2,5,10,20,25,50,100][Math.floor(Math.random()*7)];
    const pct=(Math.random()*22+0.5).toFixed(1);
    const secs=Math.floor(Math.random()*3600);
    dynamicTraderPool.push({name:`${fn} ${ln}`,flag:country.flag,loc:country.loc,emoji,profit,pair,secs,leverage,pct});
  }
}

function getNextTraderBatch(count){
  const batch=[];
  for(let i=0;i<count;i++){
    batch.push(dynamicTraderPool[traderPoolIndex%dynamicTraderPool.length]);
    traderPoolIndex++;
  }
  return batch;
}

function buildLiveTradersFromPool(){
  if(!dynamicTraderPool.length) initDynamicTraderPool();
  const pool=getNextTraderBatch(60);
  const doubled=[...pool,...pool];
  const track=document.getElementById('tradersTrack');
  if(!track) return;
  track.innerHTML=doubled.map(t=>{
    const timeAgo=t.secs<60?t.secs+'s ago':Math.floor(t.secs/60)+'m ago';
    return `<div class="trader-chip"><div class="trader-avatar">${t.emoji}</div><div><div class="trader-name">${t.name} ${t.flag}</div><div class="trader-profit">+$${t.profit} · ${t.pair} ${t.leverage}×</div><div class="trader-time">${timeAgo} · +${t.pct}%</div></div></div>`;
  }).join('');
}

function buildWinnersFromPool(){
  if(!dynamicTraderPool.length) initDynamicTraderPool();
  const RANK=['👑','🥈','🥉','🎯','⭐','💫'];
  const pool=getNextTraderBatch(12).map(t=>({...t,
    totalProfit:(parseFloat(t.profit)*6+Math.random()*8000+500).toFixed(0),
    winRate:Math.floor(Math.random()*22+68),
    totalTrades:Math.floor(Math.random()*2000+100)
  })).sort((a,b)=>parseFloat(b.totalProfit)-parseFloat(a.totalProfit)).slice(0,6);

  const g=document.getElementById('winnersGrid');
  if(!g) return;
  g.innerHTML=pool.map((w,i)=>`
    <div class="winner-card">
      <div class="winner-rank">#${i+1}</div>
      <div class="winner-head">
        <div class="winner-ava">${RANK[i]}</div>
        <div><div class="winner-name">${w.name}</div><div class="winner-loc">${w.flag} ${w.loc}</div></div>
      </div>
      <div class="winner-stats">
        <div class="winner-stat"><div class="ws-val">$${parseInt(w.totalProfit).toLocaleString()}</div><div class="ws-lbl">Profit</div></div>
        <div class="winner-stat"><div class="ws-val">${w.totalTrades}</div><div class="ws-lbl">Trades</div></div>
        <div class="winner-stat"><div class="ws-val">${w.winRate}%</div><div class="ws-lbl">Win Rate</div></div>
        <div class="winner-stat"><div class="ws-val">${w.leverage}×</div><div class="ws-lbl">Top Lev</div></div>
      </div>
    </div>`).join('');
}

// Refresh traders every 12 seconds — always new faces
function startLiveTradersRefresh(){
  buildLiveTradersFromPool();
  buildWinnersFromPool();
  setInterval(()=>{
    buildLiveTradersFromPool();
  }, 12000);
  setInterval(()=>{
    buildWinnersFromPool();
  }, 30000);
}

// ============================================================
// REGISTRATION NOTIFICATION — Email + WhatsApp
// ============================================================
function notifyAdminNewUser(user){
  const emailParams={
    to_email:'felixkoskey278@gmail.com',
    to_name:'Felix (CryptoPro Admin)',
    subject:`🎉 NEW USER REGISTERED — ${user.name}`,
    message:`
NEW USER REGISTRATION — CryptoPro Platform

👤 Name: ${user.name}
📧 Email: ${user.email}
📱 Phone: ${user.phone}
🔑 Referral Code: ${user.refCode}
📅 Date: ${new Date().toLocaleString()}
💰 Starting Balance: $25.00 (Demo Bonus)
🌐 Referral Used: ${user.referralCode||'None'}

User has been granted $25 demo bonus automatically.
Monitor their activity in your admin panel.

CryptoPro Notification System
    `.trim()
  };

  // Email notification
  try{
    emailjs.send(
      PAYMENT_CONFIG.EMAILJS.SERVICE_ID,
      PAYMENT_CONFIG.EMAILJS.TEMPLATE_ID,
      emailParams
    );
  }catch(e){ console.log('Email notify failed:', e); }

  // WhatsApp notification — auto-open on admin device if possible
  const waMsg=encodeURIComponent(
`🎉 *NEW USER REGISTERED — CryptoPro*

👤 *Name:* ${user.name}
📧 *Email:* ${user.email}
📱 *Phone:* ${user.phone}
🔑 *Ref Code:* ${user.refCode}
📅 *Time:* ${new Date().toLocaleString()}
💰 *Bonus Credited:* $25.00 Demo

Monitor user activity on the platform.`
  );
  // Store the WA link in localStorage for admin reference
  const waLink=`https://wa.me/254759401893?text=${waMsg}`;
  try{ localStorage.setItem('cpLastWANotif', waLink); }catch(e){}

  // Try to trigger via hidden iframe (silent attempt)
  try{
    const img=new Image();
    img.src=`https://wa.me/254759401893?text=${waMsg}`;
  }catch(e){}
}

// Patch handleSignup to call notifyAdminNewUser
const _origHandleSignup=handleSignup;
// Override is handled below in the patched version
// NOTE: Already integrated into handleSignup above.

// ============================================================
// INIT
// ============================================================
function init(){
  loadState();
  initDynamicTraderPool();
  checkReferral();
  buildTickers();
  startLiveTradersRefresh();
  buildReviews();

  // Rotate live messages on login page
  rotateLiveMsg();
  setInterval(rotateLiveMsg, 4000);

  // Update ticker prices every 2s
  setInterval(updateTickerPrices, 2000);

  // Update open positions PnL every 2s
  setInterval(()=>{
    if(currentUser&&currentLayer==='dashboardLayer'){
      renderOpenPositions();
      updateDashboardData();
      buildMSnap();
    }
  }, 2000);

  // If user was logged in, go to dashboard
  if(currentUser) showLayer('dashboardLayer');
  else showLayer('welcomeLayer');
}

// Patch handleSignup to include admin notification
window.handleSignup = function(e){
  e.preventDefault();
  if(!document.getElementById('agreeTerms').checked){
    showSignupAlert('Please agree to the Terms of Service.','error'); return false;
  }
  const btn=document.getElementById('signupBtn');
  document.getElementById('signupBtnText').style.display='none';
  document.getElementById('signupBtnSpinner').style.display='inline-block';
  btn.disabled=true;

  setTimeout(()=>{
    const refCode='CP'+Math.random().toString(36).substr(2,6).toUpperCase();
    currentUser={
      name:signupData.name, email:signupData.email, phone:signupData.phone,
      refCode, referralCode:signupData.referralCode||null,
      demoBalance:25, realBalance:0, deposits:0, profit:0,
      trades:[], openPositions:[], joinDate:new Date().toLocaleDateString(),
      referrals:[], referralEarnings:0, balanceHistory:[{t:Date.now(),v:25}]
    };
    saveState();

    // Notify admin via email + WhatsApp
    notifyAdminNewUser(currentUser);

    // Welcome email to user
    try{
      emailjs.send(PAYMENT_CONFIG.EMAILJS.SERVICE_ID, PAYMENT_CONFIG.EMAILJS.TEMPLATE_ID,{
        to_name:currentUser.name, to_email:currentUser.email,
        subject:'Welcome to CryptoPro — $25 Bonus Credited!',
        message:`Welcome ${currentUser.name}! Your $25 demo bonus has been credited. Start trading now!`
      });
    }catch(e){}

    addNotification('🎉','Welcome to CryptoPro! Your $25 bonus is ready.','rgba(0,230,118,.2)');
    showToast(`🎉 Welcome, ${currentUser.name}! Your $25 demo bonus has been credited!`,'green',5000);
    showLayer('dashboardLayer');
  }, 2200);
  return false;
};

init();
</script>
</body>
</html>
